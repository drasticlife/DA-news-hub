<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SEC DA Purchase Intelligence Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"
    />
    <script>
      tailwind.config = { darkMode: "class" };
    </script>
    <style>
      /* 랜딩 페이지 스타일 */
      #landing-page {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 9999;
        transition: opacity 1s ease-out, visibility 1s;
        cursor: pointer;
        overflow: hidden;
      }
      #landing-page.hidden {
        opacity: 0;
        visibility: hidden;
      }
      #globeViz { width: 100vw; height: 100vh; }
    
      #center-title {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        text-align: center;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        pointer-events: none;
        z-index: 10;
        text-shadow: 0 0 10px rgba(0, 169, 224, 0.8);
      }
      
      #center-title h1 {
        margin: 0;
        font-size: 3rem;
        font-weight: 300;
        letter-spacing: 2px;
        text-transform: uppercase;
      }

      #center-title p {
        margin: 10px 0 0;
        font-size: 1.2rem;
        font-weight: 100;
        opacity: 0.8;
        font-style: italic;
      }
      
      body.landing-active {
        overflow: hidden;
      }

      body {
        font-family: "Pretendard", sans-serif;
        transition: all 0.3s ease;
      }
      .header {
        height: 55px;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 100;
        border-bottom: 2px solid #1428a0;
      }
      .sidebar {
        width: 280px;
        position: fixed;
        left: 0;
        top: 55px;
        height: calc(100vh - 55px);
        border-right: 1px solid #eee;
        padding: 25px;
        overflow-y: auto;
        background: white;
      }
      .main-content {
        margin-left: 280px;
        margin-top: 55px;
        padding: 30px 40px;
        max-width: 1200px;
      }

      /* 1. 안정적인 8열 그리드 달력 (주차 포함) */
      .calendar-grid {
        display: grid;
        grid-template-columns: 28px repeat(7, minmax(28px, 1fr));
        gap: 4px;
        align-items: center;
        justify-items: center;
        width: 100%;
        max-width: 280px;
      }
      .calendar-grid span {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
        font-size: 10px;
        cursor: default;
        position: relative;
        flex-shrink: 0;
      }

      /* 주차 표시 스타일 */
      .week-label {
        font-size: 9px !important;
        font-weight: 700;
        color: #94a3b8;
        cursor: pointer !important;
        transition: all 0.2s;
      }
      .week-label:hover {
        color: #1428a0;
        transform: scale(1.1);
      }
      .week-selected {
        background: #1428a0 !important;
        color: white !important;
        border-radius: 4px !important;
      }

      /* 리스크 필터 버튼 스타일 */
      .risk-filter-btn.active {
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .dark .risk-filter-btn.active {
        background: #3f444a;
      }

      /* 얄쌍한 링 디자인 (LV1~LV3) */
      .calendar-ring {
        border: 1.2px solid #1428a0;
        color: #1428a0;
        font-weight: 800;
        cursor: pointer !important;
      }
      .ring-lv1 {
        width: 20px !important;
        height: 20px !important;
        border-width: 1px;
      }
      .ring-lv2 {
        width: 24px !important;
        height: 24px !important;
        border-width: 2px;
      }
      .ring-lv3 {
        width: 28px !important;
        height: 28px !important;
        border-width: 3px;
        box-shadow: 0 0 8px rgba(20, 40, 160, 0.15);
      }
      .calendar-selected {
        background-color: #1428a0 !important;
        color: white !important;
        border: none !important;
      }

      /* 네비게이션 화살표 스타일 */
      .nav-btn {
        cursor: pointer;
        padding: 2px;
        border-radius: 4px;
        transition: all 0.2s;
        color: #cbd5e1;
      }
      .nav-btn:hover {
        background: #f1f5f9;
        color: #1428a0;
      }

      /* 2. 동적 확장 카드 및 이미지 효과 */
      .news-item {
        border-bottom: 1px solid #f1f5f9;
        padding: 24px 0;
        cursor: pointer;
        transition: all 0.4s ease;
        overflow: hidden;
        max-height: 240px;
      }
      .news-item.expanded {
        max-height: 1500px;
        background: #fcfdfe;
        border-bottom: 2px solid #1428a0;
      }
      .summary-text {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .news-item.expanded .summary-text {
        -webkit-line-clamp: unset;
        line-clamp: unset;
      }
      .news-item img {
        filter: grayscale(100%);
        transition: all 0.5s ease;
      }
      .news-item:hover img {
        filter: grayscale(0%);
        transform: scale(1.05);
      }

      /* 3D 인터랙티브 태그 클라우드 - 순수 JS 구현 */
      #tagCloudContainer {
        position: relative;
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 8px;
        overflow: hidden;
        perspective: 600px;
      }
      #tagCloud3D {
        width: 100%;
        height: 200px;
        position: relative;
        transform-style: preserve-3d;
      }
      .tag3d {
        position: absolute;
        left: 50%;
        top: 50%;
        font-size: 12px;
        font-weight: 600;
        color: #e2e8f0;
        cursor: pointer;
        transition: color 0.3s;
        white-space: nowrap;
        user-select: none;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        transform-origin: center center;
        will-change: transform, opacity;
      }
      .tag3d:hover {
        color: #60a5fa;
        transform: scale(1.2) !important;
        text-shadow: 0 0 10px rgba(96, 165, 250, 0.6);
      }

      /* 글로벌 지도 스타일 */
      #worldMap {
        width: 100%;
        height: 130px;
        background: #f8fafc;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      }
      .country-marker {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #1428a0;
        border: 2px solid white;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .country-marker:hover {
        transform: scale(1.5);
        z-index: 10;
      }
      .country-marker::after {
        content: attr(data-country);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1428a0;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 9px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        margin-bottom: 4px;
      }
      .country-marker:hover::after {
        opacity: 1;
      }

      /* 펄스 애니메이션 */
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.3);
          opacity: 0.7;
        }
      }

      /* 환율/원자재 슬라이드 스타일 */
      .market-section {
        margin-bottom: 20px;
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px;
        position: relative;
        overflow: hidden;
        height: 80px;
      }
      .market-carousel {
        display: flex;
        transition: transform 0.5s ease-in-out;
      }
      .market-slide {
        min-width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
      }
      .market-label {
        font-weight: 600;
        color: #64748b;
        font-size: 10px;
      }
      .market-value {
        font-weight: 700;
        color: #1428a0;
        font-size: 12px;
      }
      .market-change {
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 4px;
        margin-top: 4px;
        display: inline-block;
      }
      .market-up {
        color: #dc2626;
        background: #fee2e2;
      }
      .market-down {
        color: #2563eb;
        background: #dbeafe;
      }
      .carousel-dots {
        display: flex;
        justify-content: center;
        gap: 4px;
        margin-top: 8px;
      }
      .carousel-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #cbd5e1;
        cursor: pointer;
        transition: all 0.3s;
      }
      .carousel-dot.active {
        background: #1428a0;
        width: 12px;
        border-radius: 3px;
      }

      /* URL 출처 링크 스타일 */
      .source-links {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }
      .source-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #f1f5f9;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        color: #1428a0;
        text-decoration: none;
        transition: all 0.2s;
      }
      .source-link:hover {
        background: #1428a0;
        color: white;
        transform: translateY(-1px);
      }

      .dark body {
        background-color: #1a1c1e;
        color: #e2e8f0;
      }
      .dark .header,
      .dark .sidebar,
      .dark .news-item {
        background-color: #25282c;
        border-color: #3f444a;
      }
      
      /* Investing.com 위젯 마스킹 스타일 제거됨 */
      /* Index Modal Styles */
      #indexModal .tradingview-widget-copyright {
        display: none !important;
      }
    </style>
  </head>
  <body class="bg-[#fcfcfc] text-[#333] landing-active">
    <!-- 3D 지구 랜딩 페이지 -->
    <div id="landing-page" onclick="enterDashboard()">
      <div id="center-title">
        <h1>DA Procurement</h1>
        <p>Daily Insight Journal</p>
      </div>

      <div id="globeViz"></div>
    </div>

    <script>
      function initLandingGlobe() {
        // [데이터 설정]
        // lat/lng: 실제 공장 위치
        // txtLat/txtLng: 글자가 표시될 위치 (겹침 방지용)
        const places = [
          // 1. 한국 (수원 vs 광주 상하 분리)
          { name: "Samsung Digital City", country: "Korea", product: "HQ / R&D", lat: 37.263, lng: 127.028, txtLat: 39.5, txtLng: 127.0 },
          { name: "Gwangju Plant", country: "Korea", product: "Premium DA", lat: 35.159, lng: 126.852, txtLat: 33.5, txtLng: 127.5 },

          // 2. 중국 (신규 추가) - 한국과 겹치지 않게 왼쪽(서쪽)으로 글자 이동
          { name: "SSEC", country: "China", product: "DA Complex", lat: 31.298, lng: 120.585, txtLat: 31.3, txtLng: 116.0 },
          
          // 3. 동남아 (태국 vs 베트남 대각선 분리)
          { name: "TSE", country: "Thailand", product: "A/C, Ref", lat: 13.111, lng: 100.927, txtLat: 16.5, txtLng: 98.0 },
          { name: "SEHC", country: "Vietnam", product: "TV/DA Complex", lat: 10.762, lng: 106.660, txtLat: 8.5, txtLng: 109.0 },

          // 4. 남미 (신규 추가) - 브라질
          { name: "SEDA", country: "Brazil", product: "DA/TV", lat: -3.119, lng: -60.021, txtLat: -3.119, txtLng: -60.021 },

          // 5. 그 외 지역
          { name: "SEPM", country: "Poland", product: "Ref/W/M", lat: 52.711, lng: 16.381, txtLat: 52.711, txtLng: 16.381 },
          { name: "SAMEX", country: "Mexico", product: "Ref", lat: 20.588, lng: -100.389, txtLat: 20.588, txtLng: -100.389 },
          { name: "SEM", country: "Mexico", product: "TV/Monitor", lat: 32.514, lng: -117.038, txtLat: 32.514, txtLng: -117.038 },
          { name: "SEHA", country: "USA", product: "W/M", lat: 34.274, lng: -81.618, txtLat: 34.274, txtLng: -81.618 },
          { name: "SIEL", country: "India", product: "DA/TV", lat: 12.971, lng: 80.015, txtLat: 12.971, txtLng: 80.015 }
        ];

        const world = Globe()
          (document.getElementById('globeViz'))
          .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
          .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
          .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
          .atmosphereColor('#3a228a')
          .atmosphereAltitude(0.2)

          // [점]
          .pointsData(places)
          .pointLat('lat')
          .pointLng('lng')
          .pointColor(() => '#00a9e0')
          .pointAltitude(0.01)
          .pointRadius(0.6)
          
          // [글자]
          .labelsData(places)
          .labelLat('txtLat')
          .labelLng('txtLng')
          .labelText(d => `${d.name}\n${d.country} | ${d.product}`)
          .labelSize(1.0)
          .labelDotRadius(0.3)
          .labelColor(() => 'rgba(255, 255, 255, 0.9)')
          .labelResolution(2)
          .labelAltitude(0.02)

          .onPointClick(point => {
            // 클릭 시 더 가까이 줌인
            world.pointOfView({ lat: point.lat, lng: point.lng, altitude: 1.5 }, 1000);
          });

        // [초기 시점 설정] 
        // altitude 값을 1.8 -> 1.4로 낮춰서 더 확대된 상태로 시작
        world.pointOfView({ lat: 25, lng: 110, altitude: 1.1 });

        world.controls().autoRotate = true;
        world.controls().autoRotateSpeed = 0.6;
      }

      function enterDashboard() {
        const lp = document.getElementById('landing-page');
        lp.classList.add('hidden');
        document.body.classList.remove('landing-active');
        setTimeout(() => { lp.style.display = 'none'; }, 1000);
      }

      // DOM 로드 시 지구본 초기화
      document.addEventListener('DOMContentLoaded', () => {
        initLandingGlobe();
      });
    </script>

    <header
      class="header flex items-center px-6 justify-between bg-white dark:bg-[#25282c] shadow-sm"
    >
      <div class="flex items-center gap-6">
        <div
          class="flex items-center gap-2 cursor-pointer"
          onclick="location.reload()"
        >
          <div
            class="w-7 h-7 bg-[#1428a0] rounded flex items-center justify-center text-white font-bold text-xs shadow-sm"
          >
            DA
          </div>
          <h1
            class="text-base font-black text-[#1428a0] dark:text-blue-400 tracking-tighter uppercase"
          >
            Purchase Intelligence
          </h1>
        </div>
        <nav class="flex gap-8 text-sm font-bold text-gray-400">
          <a
            href="#"
            class="text-[#1428a0] border-b-2 border-[#1428a0] pb-1"
            onclick="resetFilters()"
            >전략 시황</a
          >
          <a href="#" onclick="filterNews('원자재')">원자재</a>
          <a href="#" onclick="filterNews('거시경제')">거시/정책</a>
          <a href="#" onclick="filterNews('생산지역')">생산지역</a>
          <a href="#" onclick="filterNews('경쟁사')">경쟁사</a>
          <a href="#" onclick="showIndexModal()" class="text-[#1428a0]">INDEX</a>
        </nav>
      </div>
      <div class="flex items-center gap-2 flex-1 max-w-md mx-8">
        <select
          id="searchScope"
          onchange="handleSearchScope(event)"
          class="bg-gray-50 dark:bg-gray-800 border-none rounded-lg py-1.5 px-3 text-xs font-bold text-gray-500 focus:ring-2 focus:ring-[#1428a0] outline-none cursor-pointer h-[34px]"
        >
          <option value="all">제목+본문</option>
          <option value="title">제목</option>
          <option value="content">본문</option>
        </select>
        <div class="relative w-full">
          <i
            data-lucide="search"
            class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
          ></i>
          <input
            type="text"
            id="searchInput"
            onkeyup="handleSearch(event)"
            placeholder="뉴스 키워드 검색..."
            class="w-full bg-gray-50 dark:bg-gray-800 border-none rounded-full py-1.5 pl-10 pr-4 text-sm focus:ring-2 focus:ring-[#1428a0] transition-all outline-none"
          />
        </div>
      </div>
      <button
        onclick="toggleDarkMode()"
        class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
      >
        <i data-lucide="moon" id="themeIcon" class="w-4 h-4 text-gray-500"></i>
      </button>
    </header>

    <aside class="sidebar dark:bg-[#25282c]">
      <!-- 달력 섹션 -->
      <div class="mb-8">
        <h3
          class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400 flex justify-between items-center"
        >
          <span onclick="goToday()" class="cursor-pointer hover:text-[#1428a0] transition-colors">TODAY</span>
          <div
            class="flex items-center gap-1 bg-gray-50 dark:bg-gray-800 px-2 py-1 rounded-md"
          >
            <i
              data-lucide="chevrons-left"
              class="w-3 h-3 nav-btn"
              onclick="moveCalendar(-1, 0)"
            ></i>
            <i
              data-lucide="chevron-left"
              class="w-3 h-3 nav-btn"
              onclick="moveCalendar(0, -1)"
            ></i>
            <span
              id="calHeader"
              class="text-[10px] font-bold text-[#1428a0] min-w-[55px] text-center"
              >2026. 01</span
            >
            <i
              data-lucide="chevron-right"
              class="w-3 h-3 nav-btn"
              onclick="moveCalendar(0, 1)"
            ></i>
            <i
              data-lucide="chevrons-right"
              class="w-3 h-3 nav-btn"
              onclick="moveCalendar(1, 0)"
            ></i>
          </div>
        </h3>
        <div id="calendarGrid" class="calendar-grid text-slate-400"></div>
      </div>

      <!-- 글로벌 지도 섹션 -->
      <div class="mb-8">
        <h3
          class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400"
        >
          Global Map
        </h3>
        <div id="worldMap"></div>
      </div>

      <!-- TradingView Tickers Widget -->
      <div class="mb-4">
        <!-- TradingView Widget BEGIN -->
      <!-- Vertical Carousel Widget -->
      <style>
        .carousel-container {
          width: 100%;
          height: 126px; /* Single widget height */
          overflow: hidden;
          position: relative;
          background: transparent;
        }
        .carousel-track {
          display: flex;
          flex-direction: column;
          transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .carousel-item {
          height: 126px;
          width: 100%;
          flex-shrink: 0;
        }
        /* Hide TradingView copyright for cleaner look */
        .carousel-item .tradingview-widget-copyright {
          display: none !important;
        }
      </style>

      <div class="carousel-container mb-4">
        <div class="carousel-track" id="ticker-track">
          <!-- 1. USDKRW -->
          <div class="carousel-item">
            <div class="tradingview-widget-container">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-single-quote.js" async>
              {
                "symbol": "FX_IDC:USDKRW",
                "width": "100%",
                "colorTheme": "light",
                "isTransparent": true,
                "locale": "kr"
              }
              </script>
            </div>
          </div>
          <!-- 2. USDCNY -->
          <div class="carousel-item">
            <div class="tradingview-widget-container">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-single-quote.js" async>
              {
                "symbol": "FX_IDC:USDCNY",
                "width": "100%",
                "colorTheme": "light",
                "isTransparent": true,
                "locale": "kr"
              }
              </script>
            </div>
          </div>
          <!-- 3. USDTHB -->
          <div class="carousel-item">
            <div class="tradingview-widget-container">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-single-quote.js" async>
              {
                "symbol": "FX_IDC:USDTHB",
                "width": "100%",
                "colorTheme": "light",
                "isTransparent": true,
                "locale": "kr"
              }
              </script>
            </div>
          </div>
          <!-- 4. USDINR -->
          <div class="carousel-item">
            <div class="tradingview-widget-container">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-single-quote.js" async>
              {
                "symbol": "FX_IDC:USDINR",
                "width": "100%",
                "colorTheme": "light",
                "isTransparent": true,
                "locale": "kr"
              }
              </script>
            </div>
          </div>
          <!-- 5. USDBRL -->
          <div class="carousel-item">
            <div class="tradingview-widget-container">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-single-quote.js" async>
              {
                "symbol": "FX_IDC:USDBRL",
                "width": "100%",
                "colorTheme": "light",
                "isTransparent": true,
                "locale": "kr"
              }
              </script>
            </div>
          </div>
        </div>
      </div>

      <script>
        (function() {
          // Initialize carousel if container exists
          const track = document.getElementById('ticker-track');
          if (track) {
            const items = track.children;
            const itemCount = items.length;
            const itemHeight = 126;
            let index = 0;

            setInterval(() => {
              index++;
              if (index >= itemCount) {
                index = 0;
              }
              track.style.transform = `translateY(-${index * itemHeight}px)`;
            }, 4000); 
          }
        })();
      </script>
        <!-- TradingView Widget END -->
      </div>

      <!-- 3D 태그 클라우드 섹션 -->
      <div>
        <h3
          class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400"
        >
          Intelligence Cloud
        </h3>
        <div id="tagCloudContainer" style="width: 100%; height: 200px">
          <div id="tagCloud3D"></div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="grid grid-cols-3 gap-6 mb-10" id="summaryGrid"></div>
      <div
        class="flex justify-between items-center mb-6 pb-2 border-b dark:border-gray-700"
      >
        <h2 class="font-bold text-lg" id="feedTitle">Strategic Feed</h2>
        <div class="flex items-center gap-4">
          <div
            class="flex items-center gap-2 bg-slate-50 dark:bg-slate-800/50 p-1 rounded-lg"
          >
            <span class="text-[9px] px-2 text-slate-400">RISK:</span>
            <button
              onclick="filterByRisk('all')"
              class="risk-filter-btn active px-2 py-0.5 rounded text-[9px] font-bold hover:bg-white dark:hover:bg-slate-700 transition-all"
            >
              ALL
            </button>
            <button
              onclick="filterByRisk('High')"
              class="risk-filter-btn px-2 py-0.5 rounded text-[9px] font-bold text-red-500 hover:bg-white dark:hover:bg-slate-700 transition-all"
            >
              HIGH
            </button>
            <button
              onclick="filterByRisk('Med')"
              class="risk-filter-btn px-2 py-0.5 rounded text-[9px] font-bold text-orange-500 hover:bg-white dark:hover:bg-slate-700 transition-all"
            >
              MED
            </button>
            <button
              onclick="filterByRisk('Low')"
              class="risk-filter-btn px-2 py-0.5 rounded text-[9px] font-bold text-blue-500 hover:bg-white dark:hover:bg-slate-700 transition-all"
            >
              LOW
            </button>
          </div>
          <div
            class="text-[10px] flex gap-4 uppercase font-bold text-slate-400 border-l pl-4 dark:border-gray-700"
          >
            <span
              id="sortLatest"
              class="cursor-pointer text-[#1428a0]"
              onclick="sortNews('latest')"
              >Latest</span
            >
            <span
              id="sortOldest"
              class="cursor-pointer hover:text-[#1428a0]"
              onclick="sortNews('oldest')"
              >Oldest</span
            >
          </div>
        </div>
      </div>
      <div
        id="loading"
        class="py-20 text-center animate-pulse text-blue-600 font-bold text-[10px] tracking-widest"
      >
        SYNCING DATA...
      </div>
      <div id="news-feed" class="space-y-4"></div>
    </main>

    <div
      id="reportModal"
      class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-[1000]"
    >
      <div
        class="modal-content bg-white dark:bg-[#25282c] w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden transition-all duration-300 transform translate-y-4"
      >
        <div
          class="p-6 border-b dark:border-gray-700 flex justify-between items-center bg-[#1428a0] text-white"
        >
          <h3 class="font-bold text-lg flex items-center gap-2">
            <i data-lucide="file-text" class="w-5 h-5"></i> 전략 요약 보고서
          </h3>
          <button
            onclick="closeModal()"
            class="hover:bg-white/20 p-1 rounded-full"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>
        <div
          id="modalBody"
          class="p-8 max-h-[70vh] overflow-y-auto space-y-6"
        ></div>
      </div>
    </div>

    <script>
      const GAS_URL =
        "https://script.google.com/macros/s/AKfycbzNJA_s6YGI2Blt6b_gaDLbOFbyzqIl7c4MDlFUjoKjDn8uCQrpkXtSba4-FHVL7HVJ7g/exec";
      let allNews = [],
        currentFilteredNews = [];
      
      // 통합 필터 상태 관리
      let filterState = {
        category: "all",
        risk: "all",
        sort: "latest",
        search: "",
        scope: "all",
        dateType: null, // null | 'week' | 'day'
        dateValue: null
      };

      let curYear = 2026,
        curMonth = 0;
      let tagCloudInstance = null;

      // 국가 좌표 맵핑 (실제 세계 지도 이미지 기준, %)
      // 표준 메르카토르 투영법 - 정확한 실제 위치
      const countryCoords = {
        // 북미
        미국: { x: 22, y: 38 },
        USA: { x: 22, y: 38 },
        캐나다: { x: 20, y: 25 },
        Canada: { x: 20, y: 25 },
        멕시코: { x: 18, y: 48 },
        Mexico: { x: 18, y: 48 },

        // 남미
        브라질: { x: 32, y: 68 },
        Brazil: { x: 32, y: 68 },

        // 유럽
        영국: { x: 48, y: 30 },
        UK: { x: 48, y: 30 },
        "United Kingdom": { x: 48, y: 30 },
        프랑스: { x: 50, y: 34 },
        France: { x: 50, y: 34 },
        독일: { x: 52, y: 32 },
        Germany: { x: 52, y: 32 },
        이탈리아: { x: 53, y: 36 },
        Italy: { x: 53, y: 36 },
        스페인: { x: 47, y: 37 },
        Spain: { x: 47, y: 37 },
        러시아: { x: 70, y: 25 },
        Russia: { x: 70, y: 25 },

        // 아시아
        중국: { x: 76, y: 40 },
        China: { x: 76, y: 40 },
        일본: { x: 86, y: 38 },
        Japan: { x: 86, y: 38 },
        한국: { x: 82, y: 38 },
        Korea: { x: 82, y: 38 },
        "South Korea": { x: 82, y: 38 },
        인도: { x: 67, y: 45 },
        India: { x: 67, y: 45 },
        베트남: { x: 78, y: 50 },
        Vietnam: { x: 78, y: 50 },
        태국: { x: 76, y: 50 },
        Thailand: { x: 76, y: 50 },
        인도네시아: { x: 80, y: 58 },
        Indonesia: { x: 80, y: 58 },

        // 오세아니아
        호주: { x: 85, y: 75 },
        Australia: { x: 85, y: 75 },

        // 전역
        Global: { x: 50, y: 50 },
      };

      // 철통 날짜 파싱
      function parseDate(dateStr) {
        if (!dateStr) return new Date();
        const clean = dateStr.toString().replace(/\./g, "-").replace(/\s/g, "");
        const parts = clean.split("T")[0].split("-");
        return parts.length < 3
          ? new Date()
          : new Date(parts[0], parts[1] - 1, parts[2]);
      }

      // 주차 계산 함수
      function getWeekOfMonth(date) {
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const dayOfMonth = date.getDate();
        const firstDayOfWeek = firstDay.getDay();
        return Math.ceil((dayOfMonth + firstDayOfWeek) / 7);
      }

      // 날짜 범위로 필터링
      function getDateRangeForWeek(year, month, weekNum) {
        const firstDay = new Date(year, month, 1);
        const firstDayOfWeek = firstDay.getDay();

        const startDate = (weekNum - 1) * 7 - firstDayOfWeek + 1;
        const endDate = startDate + 6;

        return {
          start: Math.max(1, startDate),
          end: Math.min(endDate, new Date(year, month + 1, 0).getDate()),
        };
      }

      async function fetchNews() {
        try {
          const res = await fetch(GAS_URL);
          allNews = await res.json();
          // 고유 ID 부여
          allNews.forEach((n, i) => {
             n._uId = `news-${i}-${Math.random().toString(36).substr(2, 9)}`;
          });
          
          console.log("Fetched news:", allNews.length, "items");
          console.log("Sample:", allNews[0]);
          currentFilteredNews = [...allNews];
          renderAll(allNews);
          sortNews("latest");
        } catch (e) {
          console.error("Fetch error:", e);
          document.getElementById("loading").innerText = "ERROR LOADING DATA";
        }
        document.getElementById("loading").style.display = "none";
      }

      function renderAll(data) {
        renderCalendar(data);
        renderSummary(data);
        renderTags(data);
        renderWorldMap(data);
      }

      function moveCalendar(yOff, mOff) {
        curYear += yOff;
        curMonth += mOff;
        if (curMonth > 11) {
          curMonth = 0;
          curYear++;
        }
        if (curMonth < 0) {
          curMonth = 11;
          curYear--;
        }

        document.getElementById("calHeader").innerText =
          `${curYear}. ${String(curMonth + 1).padStart(2, "0")}`;
        renderCalendar(allNews);
      }

      function renderCalendar(data) {
        const grid = document.getElementById("calendarGrid");
        const dateCounts = data.reduce((acc, n) => {
          const d = parseDate(n.Date);
          if (d.getFullYear() === curYear && d.getMonth() === curMonth) {
            const day = d.getDate();
            acc[day] = (acc[day] || 0) + 1;
          }
          return acc;
        }, {});

        let html = "";

        // 헤더: 주차 + 요일
        html += `<span class="font-bold opacity-30 text-[9px]">W</span>`;
        ["S", "M", "T", "W", "T", "F", "S"].forEach(
          (s) =>
            (html += `<span class="font-bold opacity-30 text-[10px]">${s}</span>`),
        );

        const firstDay = new Date(curYear, curMonth, 1).getDay();
        const lastDate = new Date(curYear, curMonth + 1, 0).getDate();

        let currentWeek = 1;
        let dayCount = 0;

        // 첫 주
        html += `<span class="week-label" id="week-${currentWeek}" onclick="filterByWeek(${currentWeek})">W${currentWeek}</span>`;

        // 첫 주의 빈 칸
        for (let i = 0; i < firstDay; i++) {
          html += `<span class="invisible">-</span>`;
          dayCount++;
        }

        // 날짜 렌더링
        for (let d = 1; d <= lastDate; d++) {
          // 새로운 주 시작 (일요일)
          if (dayCount > 0 && dayCount % 7 === 0) {
            currentWeek++;
            html += `<span class="week-label" id="week-${currentWeek}" onclick="filterByWeek(${currentWeek})">W${currentWeek}</span>`;
          }

          const count = dateCounts[d] || 0;
          let lv =
            count >= 3
              ? "calendar-ring ring-lv3"
              : count === 2
                ? "calendar-ring ring-lv2"
                : count === 1
                  ? "calendar-ring ring-lv1"
                  : "";
          const clickEvent = count > 0 ? `onclick="filterByDate(${d})"` : "";
          html += `<span class="${lv}" id="cal-${d}" ${clickEvent}>${d}</span>`;
          dayCount++;
        }

        // 마지막 주의 빈 칸
        const remainingCells = dayCount % 7;
        if (remainingCells !== 0) {
          for (let i = remainingCells; i < 7; i++) {
            html += `<span class="invisible">-</span>`;
          }
        }

        grid.innerHTML = html;
      }

      function filterByWeek(weekNum) {
        // 모든 선택 해제
        document.querySelectorAll(".calendar-grid span").forEach((el) => {
          el.classList.remove("calendar-selected", "week-selected");
        });

        // 주차 라벨 선택 표시
        const weekLabel = document.getElementById(`week-${weekNum}`);
        if (weekLabel) weekLabel.classList.add("week-selected");

        // 상태 업데이트
        filterState.dateType = 'week';
        filterState.dateValue = weekNum;
        filterState.category = 'all'; // 달력 선택 시 카테고리 해제
        applyFilters();
      }

      function filterByDate(day) {
        document.querySelectorAll(".calendar-grid span").forEach((el) => {
          el.classList.remove("calendar-selected", "week-selected");
        });
        const target = document.getElementById(`cal-${day}`);
        if (target) target.classList.add("calendar-selected");

        // 상태 업데이트
        filterState.dateType = 'day';
        filterState.dateValue = day;
        filterState.category = 'all';
        applyFilters();
      }

      function sortNews(type) {
        filterState.sort = type;
        applyFilters();
      }

      // 다중 URL 파싱 함수
      function parseUrls(urlString) {
        if (!urlString) return [];

        // URL과 출처명 패턴 파싱: "출처명: URL" 또는 단순 URL
        const urlPattern = /(?:([^:,]+):\s*)?(https?:\/\/[^\s,]+)/g;
        const urls = [];
        let match;

        while ((match = urlPattern.exec(urlString)) !== null) {
          urls.push({
            name: match[1] ? match[1].trim() : extractDomain(match[2]),
            url: match[2].trim(),
          });
        }

        return urls.length > 0 ? urls : [{ name: "원문", url: urlString }];
      }

      // 도메인에서 출처명 추출
      function extractDomain(url) {
        try {
          const domain = new URL(url).hostname.replace("www.", "");
          return domain.split(".")[0];
        } catch {
          return "출처";
        }
      }

      function renderFeed(data) {
        const feed = document.getElementById("news-feed");
        feed.innerHTML = data
          .map((n) => {
            const urls = parseUrls(n.URL);
            const sourceLinksHtml = urls
              .map(
                (src) =>
                  `<a href="${src.url}" target="_blank" class="source-link" onclick="event.stopPropagation()">
                        <i data-lucide="external-link" class="w-3 h-3"></i>
                        ${src.name}
                    </a>`,
              )
              .join("");

            // 영향도 표시 스타일 결정
            let impactHtml = "";
            if (n.Impact) {
              const isPositive = n.Impact.includes("+");
              const isNegative = n.Impact.includes("-");
              const colorClass = isPositive
                ? "text-green-600 bg-green-50"
                : isNegative
                  ? "text-red-600 bg-red-50"
                  : "text-slate-600 bg-slate-50";
              impactHtml = `<span class="px-2 py-0.5 rounded text-[9px] font-bold ${colorClass}">Impact: ${n.Impact}</span>`;
            }

            return `
                <article id="${n._uId}" class="news-item flex gap-8 items-start bg-white dark:bg-[#25282c] p-6 rounded-xl shadow-sm border border-transparent hover:border-blue-100 transition-all" onclick="this.classList.toggle('expanded')">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="px-2 py-0.5 rounded text-[9px] font-bold ${n.Risk === "High" ? "bg-red-50 text-red-600" : "bg-blue-50 text-blue-600"}">${n.Category || "N/A"}</span>
                            ${n.Region || n.Country ? `<span class="px-2 py-0.5 rounded text-[9px] font-bold bg-indigo-50 text-indigo-600">${n.Region || n.Country}</span>` : ""}
                            ${impactHtml}
                            <span class="text-[10px] text-slate-400 ml-auto font-medium">${n.Date ? n.Date.toString().split("T")[0] : ""}</span>
                        </div>
                        <h4 class="font-bold text-base mb-3 leading-snug">${n.Title || "No Title"}</h4>
                        <p class="summary-text text-[13px] text-slate-500 dark:text-slate-400 leading-relaxed mb-4">${n.Summary || ""}</p>
                        <div class="source-links">${sourceLinksHtml}</div>
                    </div>
                    ${n.Image ? `<div class="w-44 h-32 rounded-lg overflow-hidden flex-shrink-0 border dark:border-gray-800"><img src="${n.Image}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.style.display='none';"></div>` : ""}
                </article>`;
          })
          .join("");
        lucide.createIcons();
      }

      // 3D 인터랙티브 태그 클라우드 - 순수 JavaScript 구현
      let tag3DRotation = { x: 0, y: 0 };
      let tag3DSpeed = { x: 0.5, y: 0.3 };
      let isDraggingTag = false;
      let tagDragStart = { x: 0, y: 0 };
      let tagAnimationId = null;

      function renderTags(data) {
        if (tagAnimationId) cancelAnimationFrame(tagAnimationId);
        
        console.log("renderTags called with", data.length, "items");
        const tagMap = {};
        
        if (!data || data.length === 0) {
            const container = document.getElementById("tagCloud3D");
            if (container) container.innerHTML = '<div style="color: #94a3b8; font-size: 11px; text-align: center; padding: 80px;">데이터 없음</div>';
            return;
        }

        data.forEach((n) => {
          // 태그 필드 확인
          const tagField = n.Tag || n.tag || n.Tags || n.tags || n.KEYWORD || n.Keyword || n.keyword;
          if (tagField) {
            tagField.split(",").forEach((tag) => {
              const t = tag.trim();
              if (t && t.length > 0) tagMap[t] = (tagMap[t] || 0) + 1;
            });
          }
        });
        
        const sortedTags = Object.entries(tagMap)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 15);

        if (sortedTags.length === 0) {
          const container = document.getElementById("tagCloud3D");
          if (container) container.innerHTML = '<div style="color: #94a3b8; font-size: 11px; text-align: center; padding: 80px;">태그 데이터 없음</div>';
          return;
        }

        const maxCount = Math.max(...sortedTags.map(([_, c]) => c), 1);
        const container = document.getElementById("tagCloud3D");
        container.innerHTML = "";

        // 3D 구 좌표 생성 (피보나치 구면 분포 알고리즘)
        const tags3D = sortedTags.map(([tag, count], i) => {
          const k = i + 1;
          const phi = Math.acos(1 - (2 * k) / (sortedTags.length + 1));
          const theta = Math.PI * (1 + Math.sqrt(5)) * k;
          const radius = 80; // 200px 컨테이너에 적합한 반지름

          return {
            tag,
            count,
            x: radius * Math.cos(theta) * Math.sin(phi),
            y: radius * Math.sin(theta) * Math.sin(phi),
            z: radius * Math.cos(phi),
          };
        });

        // 태그 요소 생성
        tags3D.forEach((tagObj) => {
          const elem = document.createElement("div");
          elem.className = "tag3d";
          elem.textContent = tagObj.tag;
          elem.style.fontSize = `${10 + (tagObj.count / maxCount) * 8}px`; // 폰트 크기 가독성 개선
          elem.dataset.x = tagObj.x;
          elem.dataset.y = tagObj.y;
          elem.dataset.z = tagObj.z;
          elem.onclick = (e) => {
            e.stopPropagation();
            showTagReport(tagObj.tag);
          };
          container.appendChild(elem);
        });

        // 애니메이션 루프 시작
        animateTagCloud();

        // 드래그 및 마우스 조작 이벤트 (전역 등록)
        if (!window.isTagEventRegistered) {
          const cloudBox = document.getElementById("tagCloudContainer");
          
          cloudBox.addEventListener("mousedown", (e) => {
            isDraggingTag = true;
            tagDragStart = { x: e.clientX, y: e.clientY };
          });
          
          window.addEventListener("mousemove", (e) => {
            if (isDraggingTag) {
              const dx = e.clientX - tagDragStart.x;
              const dy = e.clientY - tagDragStart.y;
              // 회전 감도 조절
              tag3DRotation.y += dx * 0.005;
              tag3DRotation.x -= dy * 0.005;
              tagDragStart = { x: e.clientX, y: e.clientY };
            }
          });
          
          window.addEventListener("mouseup", () => {
            isDraggingTag = false;
          });
          
          window.isTagEventRegistered = true;
        }
      }

      function animateTagCloud() {
        if (!isDraggingTag) {
          // 자연스러운 자동 회전
          tag3DRotation.x += 0.002;
          tag3DRotation.y += 0.003;
        }

        const tags = document.querySelectorAll(".tag3d");
        const radius = 80;

        tags.forEach((tag) => {
          const x0 = parseFloat(tag.dataset.x);
          const y0 = parseFloat(tag.dataset.y);
          const z0 = parseFloat(tag.dataset.z);

          // 3D 회전 행렬 계산 (X, Y축 기준)
          const cosX = Math.cos(tag3DRotation.x);
          const sinX = Math.sin(tag3DRotation.x);
          let y1 = y0 * cosX - z0 * sinX;
          let z1 = y0 * sinX + z0 * cosX;

          const cosY = Math.cos(tag3DRotation.y);
          const sinY = Math.sin(tag3DRotation.y);
          let x2 = x0 * cosY + z1 * sinY;
          let z2 = -x0 * sinY + z1 * cosY;

          // 투영 및 스타일 업데이트 (Z축 깊이에 따른 효과)
          const depth = (z2 + radius) / (2 * radius); // 0 (뒤) ~ 1 (앞)
          const scale = 0.5 + depth * 0.8; // 0.5x ~ 1.3x
          const opacity = 0.2 + depth * 0.8; // 0.2 ~ 1.0

          // translate3d를 사용하여 GPU 가속 활용
          tag.style.transform = `translate3d(${x2}px, ${y1}px, ${z2}px) scale(${scale})`;
          tag.style.opacity = opacity;
          tag.style.zIndex = Math.round(depth * 100);
          
          // 흐림 효과 (선택적: 깊이 표현 강조)
          if (depth < 0.3) {
            tag.style.filter = `blur(0.5px)`;
          } else {
            tag.style.filter = 'none';
          }
        });

        tagAnimationId = requestAnimationFrame(animateTagCloud);
      }

      // 글로벌 지도 렌더링
      function renderWorldMap(data) {
        console.log("renderWorldMap called with", data.length, "items");
        
        if (!data || data.length === 0) {
             document.getElementById("worldMap").innerHTML =
            '<div style="color: #94a3b8; font-size: 11px; text-align: center; padding: 40px;">데이터 없음</div>';
            return;
        }
        
        const countryMap = {};
        data.forEach((n) => {
          // 다양한 대소문자/필드명 지원
          const regionField = n.Region || n.region || n.Country || n.country || n.Place || n.place || n.Location || n.location;
          if (regionField) {
            const countries = regionField.split(",").map((c) => c.trim());
            countries.forEach((country) => {
              if (country) countryMap[country] = (countryMap[country] || 0) + 1;
            });
          }
        });
        
        const mapContainer = document.getElementById("worldMap");

        if (Object.keys(countryMap).length === 0) {
          mapContainer.innerHTML =
            '<div style="color: #94a3b8; font-size: 11px; text-align: center; padding: 40px;">지역 데이터 없음</div>';
          console.log("No countries found");
          return;
        }

        mapContainer.innerHTML = "";

        // 실제 세계 지도 이미지 배경
        mapContainer.style.backgroundImage = "url(world_map_real.png)";
        mapContainer.style.backgroundSize = "100% 100%";
        mapContainer.style.backgroundPosition = "center";
        mapContainer.style.backgroundRepeat = "no-repeat";

        // 국가별 기사 수 표시
        console.log("Adding country list");
        const countryList = document.createElement("div");
        countryList.style.cssText =
          "position: absolute; top: 5px; left: 5px; background: rgba(255,255,255,0.95); padding: 8px; border-radius: 6px; font-size: 9px; max-height: 180px; overflow-y: auto; z-index: 10;";
        countryList.innerHTML =
          `<div style="font-weight: 700; margin-bottom: 4px; color: #1428a0;">국가별 기사</div>` +
          Object.entries(countryMap)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10)
            .map(
              ([country, count]) =>
                `<div style="cursor: pointer; padding: 2px 0; color: #64748b;" onclick="filterByCountry('${country}')" onmouseover="this.style.color='#1428a0'" onmouseout="this.style.color='#64748b'">
                            ${country}: ${count}건
                        </div>`,
            )
            .join("");
        mapContainer.appendChild(countryList);

        // 국가 마커 추가
        console.log("Adding country markers");
        let markerCount = 0;
        Object.entries(countryMap).forEach(([country, count]) => {
          const coords = countryCoords[country];
          console.log(`Checking country: ${country}, coords:`, coords);
          if (coords) {
            const marker = document.createElement("div");
            marker.className = "country-marker";
            marker.setAttribute("data-country", `${country} (${count})`);
            marker.style.left = `${coords.x}%`;
            marker.style.top = `${coords.y}%`;

            // 빈도에 따른 크기 조정
            const maxCount = Math.max(...Object.values(countryMap));
            const size = 10 + (count / maxCount) * 10;
            marker.style.width = `${size}px`;
            marker.style.height = `${size}px`;

            // 펄스 애니메이션 추가
            if (count > 1) {
              marker.style.animation = "pulse 2s infinite";
            }

            marker.addEventListener("click", () => filterByCountry(country));
            mapContainer.appendChild(marker);
            markerCount++;
          } else {
            console.log(`No coords for country: ${country}`);
          }
        });

        console.log("Total markers added:", markerCount);
      }

      function filterByCountry(country) {
        currentFilteredNews = allNews.filter((n) => {
          const region = n.Region || n.Country;
          return region && region.includes(country);
        });
        renderFeed(currentFilteredNews);
        document.getElementById("feedTitle").innerText = `${country} 관련 뉴스`;
      }

      function showTagReport(tag) {
        const filtered = allNews.filter((n) => {
          const tagField = n.Tag || n.Tags;
          return tagField && tagField.includes(tag);
        });
        const body = document.getElementById("modalBody");
        body.innerHTML = `
                <h4 class="font-bold mb-4 text-lg">#${tag} 전략 브리핑 (${filtered.length}건)</h4>
                <div class="space-y-3 text-sm">
                    ${filtered
                      .map(
                        (n) => `
                        <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <div class="font-bold mb-1">${n.Title}</div>
                            <div class="text-xs text-gray-500">${n.Date ? n.Date.toString().split("T")[0] : ""} | ${n.Category || "N/A"}</div>
                        </div>
                    `,
                      )
                      .join("")}
                </div>
            `;
        document.getElementById("reportModal").classList.remove("hidden");
        lucide.createIcons();
      }

      function closeModal() {
        document.getElementById("reportModal").classList.add("hidden");
      }

      function showIndexModal() {
        document.getElementById("indexModal").classList.remove("hidden");
      }

      function closeIndexModal(event) {
        if (!event || event.target.id === "indexModal" || event.target.closest('button')) {
             document.getElementById("indexModal").classList.add("hidden");
        }
      }

      function goToday() {
        const today = new Date();
        curYear = today.getFullYear();
        curMonth = today.getMonth();
        
        document.getElementById("calHeader").innerText =
          `${curYear}. ${String(curMonth + 1).padStart(2, "0")}`;
          
        renderCalendar(allNews);
        filterByDate(today.getDate());
      }

      function filterNews(cat) {
        filterState.category = cat;
        filterState.dateType = null; // 카테고리 변경 시 날짜 필터 해제
        
        // 달력 선택 UI 해제
        document.querySelectorAll(".calendar-grid span").forEach((el) => {
          el.classList.remove("calendar-selected", "week-selected");
        });
        
        applyFilters();
      }

      function filterByRisk(risk) {
        filterState.risk = risk;
        applyFilters();
      }

      function handleSearch(event) {
        filterState.search = event.target.value.toLowerCase();
        applyFilters();
      }

      function handleSearchScope(event) {
        filterState.scope = event.target.value;
        applyFilters();
      }

      function resetFilters() {
        document.getElementById("searchInput").value = "";
        
        // 상태 초기화
        filterState = {
            category: "all",
            risk: "all",
            sort: "latest",
            search: "",
            scope: "all",
            dateType: null,
            dateValue: null
        };
        
        document.getElementById("searchScope").value = "all";

        // 달력 UI 초기화
        document.querySelectorAll(".calendar-grid span").forEach((el) => {
          el.classList.remove("calendar-selected", "week-selected");
        });

        // 달력 헤더 리셋 (현재 연월로)
        curYear = 2026; 
        curMonth = 0;
        document.getElementById("calHeader").innerText = "2026. 01";
        renderCalendar(allNews);

        applyFilters();
      }

      // [핵심] 통합 필터링 로직
      function applyFilters() {
        let result = [...allNews];

        // 1. 카테고리 필터 (날짜 필터가 없을 때만)
        if (!filterState.dateType && filterState.category !== "all") {
             result = result.filter(n => {
                if (!n.Category) return false;
                return n.Category.split(":")[0].trim() === filterState.category;
             });
        }

        // 2. 날짜 필터 (Calendar)
        let title = "Strategic Feed";
        if (filterState.dateType === 'week') {
            const range = getDateRangeForWeek(curYear, curMonth, filterState.dateValue);
            result = result.filter(n => {
                 const d = parseDate(n.Date);
                 return d.getFullYear() === curYear && d.getMonth() === curMonth && d.getDate() >= range.start && d.getDate() <= range.end;
            });
            title = `Week ${filterState.dateValue} - ${curYear}.${String(curMonth + 1).padStart(2, "0")}`;
        } else if (filterState.dateType === 'day') {
            result = result.filter(n => {
                const d = parseDate(n.Date);
                return d.getFullYear() === curYear && d.getMonth() === curMonth && d.getDate() === filterState.dateValue;
            });
            title = `${curYear}.${String(curMonth + 1).padStart(2, "0")}.${String(filterState.dateValue).padStart(2, "0")}`;
        } else if (filterState.category !== "all") {
            title = `${filterState.category} 카테고리`;
        }

        // 3. 리스크 필터 (Nav/Date 필터 결과 위에서 동작)
        // 버튼 UI 업데이트
        document.querySelectorAll(".risk-filter-btn").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.innerText === filterState.risk.toUpperCase()) btn.classList.add("active");
        });

        if (filterState.risk !== "all") {
            result = result.filter(n => n.Risk === filterState.risk);
            title += ` (${filterState.risk} Risk)`; // 제목에 리스크 상태 반영
        }

        // 4. 검색 필터
        if (filterState.search) {
            const q = filterState.search;
            const scope = filterState.scope || "all";
            
            result = result.filter(n => {
                const titleMatch = n.Title && n.Title.toLowerCase().includes(q);
                const summaryMatch = n.Summary && n.Summary.toLowerCase().includes(q);
                
                // 제목+본문(all)일 때는 태그/지역도 포함하여 검색 (기본 동작 유지)
                const tagMatch = n.Tag && n.Tag.toLowerCase().includes(q);
                const regionMatch = n.Region && n.Region.toLowerCase().includes(q);

                if (scope === "title") return titleMatch;
                if (scope === "content") return summaryMatch;
                return titleMatch || summaryMatch || tagMatch || regionMatch;
            });

            const scopeMap = { "title": "제목", "content": "본문", "all": "전체" };
            title = `'${q}' 검색 결과 (${scopeMap[scope]})`;
        }

        document.getElementById("feedTitle").innerText = title;

        // 5. 정렬 (Latest / Oldest)
        const lb = document.getElementById("sortLatest");
        const rb = document.getElementById("sortOldest");
        if (lb && rb) {
            lb.classList.remove("text-[#1428a0]", "text-slate-400");
            rb.classList.remove("text-[#1428a0]", "text-slate-400");
            
            if (filterState.sort === "latest") {
                lb.classList.add("text-[#1428a0]");
                rb.classList.add("text-slate-400");
                result.sort((a, b) => parseDate(b.Date) - parseDate(a.Date));
            } else {
                rb.classList.add("text-[#1428a0]");
                lb.classList.add("text-slate-400");
                result.sort((a, b) => parseDate(a.Date) - parseDate(b.Date));
            }
        }

        currentFilteredNews = result;
        renderFeed(result);
        renderSummary(result);
        renderWorldMap(result);
        renderTags(result);
      }

      function renderSummary(data) {
        // 리스크 가중치 맵
        const riskMap = { High: 3, Med: 2, Low: 1 };
        
        // 현재 필터링된 데이터 중에서 리스크 순으로 정렬하여 상위 3개 추출
        const topRisks = [...data]
            .sort((a, b) => (riskMap[b.Risk] || 0) - (riskMap[a.Risk] || 0))
            .slice(0, 3);

        document.getElementById("summaryGrid").innerHTML = topRisks
          .map(
            (a) =>
              `<div class="p-6 bg-white dark:bg-[#25282c] shadow-sm border-t-4 border-[#1428a0] rounded-lg cursor-pointer transform hover:scale-[1.02] transition-all" 
                    onclick="focusNews('${a._uId}')">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[9px] font-bold px-1.5 py-0.5 rounded ${a.Risk === 'High' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}">${a.Risk || 'Info'}</span>
                        <span class="text-[9px] text-gray-400">${a.Date ? a.Date.toString().split("T")[0] : ""}</span>
                    </div>
                    <h4 class="font-bold text-sm line-clamp-2 hover:text-[#1428a0]">${a.Title || "No Title"}</h4>
                </div>`,
          )
          .join("");
      }

      function focusNews(id) {
        const el = document.getElementById(id);
        if (el) {
            // 부드럽게 스크롤 이동
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // 카드 강조 효과 (반짝임)
            el.classList.add('ring-2', 'ring-[#1428a0]', 'ring-offset-2');
            setTimeout(() => el.classList.remove('ring-2', 'ring-[#1428a0]', 'ring-offset-2'), 2000);
            
            // 내용 펼치기
            if (!el.classList.contains('expanded')) {
                el.classList.add('expanded');
            }
        }
      }

      function toggleDarkMode() {
        document.documentElement.classList.toggle("dark");
        lucide.createIcons();
      }



      function showIndexModal() {
        document.getElementById("indexModal").classList.remove("hidden");
      }

      function closeIndexModal(event) {
        if (!event || event.target.id === "indexModal" || event.target.closest('button')) {
             document.getElementById("indexModal").classList.add("hidden");
        }
      }

      window.onload = () => {
        lucide.createIcons();
        fetchNews();
        // renderFXRates();
        // renderMaterialPrices();

        // 1분마다 환율/원자재 데이터 업데이트
        // setInterval(() => {
        //   renderFXRates();
        //   renderMaterialPrices();
        // }, 60000);
      };
    </script>

    <div
      id="indexModal"
      class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-[1000]"
      onclick="closeIndexModal(event)"
    >
      <div class="bg-white dark:bg-[#25282c] p-6 rounded-2xl shadow-2xl relative" onclick="event.stopPropagation()">
          <button
            onclick="closeIndexModal()"
            class="absolute top-4 right-4 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-full transition-colors"
          >
            <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
          </button>
          
          <!-- TradingView Widget BEGIN -->
          <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <div class="tradingview-widget-copyright"><a href="https://kr.tradingview.com/markets/currencies/" rel="noopener nofollow" target="_blank"><span class="blue-text">Track all markets on TradingView</span></a></div>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-forex-cross-rates.js" async>
            {
            "colorTheme": "light",
            "isTransparent": false,
            "locale": "kr",
            "currencies": [
              "USD",
              "JPY",
              "CNY",
              "KRW",
              "THB"
            ],
            "backgroundColor": "#ffffff",
            "width": 800,
            "height": 600
          }
            </script>
          </div>
          <!-- TradingView Widget END -->
      </div>
    </div>
  </body>
</html>
