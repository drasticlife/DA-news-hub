<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Insight Globe v2</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "react-globe.gl": "https://esm.sh/react-globe.gl@2.27.2?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react",
            "three": "https://esm.sh/three@0.160.0",
            "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom"
        }
    }
    </script>

    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 4. Lottie Web Component -->
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.11/dist/dotlottie-wc.js" type="module"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 169, 224, 0.3);
            border-radius: 10px;
        }

        .glow-cyan {
            box-shadow: 0 0 30px rgba(0, 169, 224, 0.2);
        }

        @keyframes reveal {
            from {
                opacity: 0;
                transform: translateY(10px);
                filter: blur(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
                filter: blur(0);
            }
        }

        .title-reveal {
            animation: reveal 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* 앵커봇 패널 */
        #anchor-panel {
            position: fixed;
            bottom: 24px;
            left: 24px;
            z-index: 300;
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            gap: 16px;
            pointer-events: none;
        }

        #anchor-panel .speech-bubble {
            pointer-events: auto;
        }

        #anchor-badge {
            position: absolute;
            top: -30px;
            /* 머리 위로 이동 */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            border-radius: 9999px;
            font-size: 9px;
            font-weight: 900;
            color: white;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            animation: float 2s ease-in-out infinite;
        }

        #anchor-badge.on-air {
            background: rgba(239, 68, 68, 0.9);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        #anchor-badge.standby {
            background: rgba(51, 65, 85, 0.8);
        }

        #anchor-badge .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(-50%, 0);
                shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            }

            50% {
                transform: translate(-50%, -5px);
                shadow: 0 8px 25px rgba(239, 68, 68, 0.6);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.4
            }
        }

        dotlottie-wc {
            display: block;
        }

        #progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #06b6d4, #3b82f6);
            border-radius: 9999px;
            transition: none;
        }

        /* 우상단 네비게이션 버튼 */
        #top-nav {
            position: fixed;
            top: 24px;
            right: 32px;
            z-index: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn-3d {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 18px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(15, 23, 42, 0.55);
            backdrop-filter: blur(16px);
            color: rgba(255, 255, 255, 0.75);
            transition: all 0.25s ease;
            text-decoration: none;
        }

        .nav-btn-3d:hover {
            background: rgba(6, 182, 212, 0.2);
            border-color: rgba(6, 182, 212, 0.5);
            color: #06b6d4;
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.2);
        }

        .nav-btn-3d.primary {
            background: rgba(6, 182, 212, 0.25);
            border-color: rgba(6, 182, 212, 0.4);
            color: #06b6d4;
        }

        .nav-btn-3d.primary:hover {
            background: rgba(6, 182, 212, 0.4);
        }

        /* 전환 오버레이 */
        #transition-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
            transition: opacity 0.6s ease-in;
        }

        #transition-overlay.fade-in {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>

<body>
    <!-- 전환 오버레이 -->
    <div id="transition-overlay"></div>

    <!-- 우상단 네비게이션 -->
    <div id="top-nav">
        <button class="nav-btn-3d" onclick="goToNewsHub()">⬡ News Hub</button>
        <button class="nav-btn-3d primary" id="dashboard-btn" onclick="goToDashboard()">▦ Dashboard</button>
    </div>

    <!-- dashboard_mod.html 프리로드 (숨김 iframe) -->
    <iframe id="preload-frame" src="dashboard_mod.html"
        style="position:fixed;width:1px;height:1px;opacity:0;pointer-events:none;border:none;top:-9999px;left:-9999px;"
        title="preload" onload="onPreloadDone()">
    </iframe>

    <!-- 앵커봇 패널 (React 밖, 순수 HTML) -->
    <div id="anchor-panel">
        <!-- BOT 캐릭터 -->
        <div style="display:flex;flex-direction:column;align-items:center;gap:8px;flex-shrink:0;pointer-events:auto;">
            <div
                style="position:relative;width:180px;height:180px;display:flex;align-items:center;justify-content:center;">
                <div id="anchor-badge" class="standby">
                    <div class="dot"></div>
                    <span id="badge-text">Standby</span>
                </div>
                <div id="lottie-container" style="width:280px;height:280px;"></div>
                <div
                    style="position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,0.3),transparent);border-radius:50%;pointer-events:none;">
                </div>
            </div>
            <div class="glass-panel" style="padding:6px 16px;border-radius:9999px;border-color:rgba(6,182,212,0.2);">
                <span id="bot-name"
                    style="font-size:10px;font-weight:900;letter-spacing:0.15em;text-transform:uppercase;color:rgba(6,182,212,0.4);">⚡
                    Strategic-Bot</span>
            </div>
        </div>

        <!-- 말풍선 -->
        <div id="speech-bubble" class="speech-bubble"
            style="display:none;position:relative;margin-bottom:0;pointer-events:auto;align-self:flex-end;">
            <!-- 꼬리 (아래쪽) -->
            <div
                style="position:absolute;left:40px;bottom:-12px;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:14px solid rgba(15,23,42,0.6);">
            </div>
            <div class="glass-panel"
                style="padding:28px;border-radius:32px;width:440px;border-color:rgba(6,182,212,0.2);box-shadow:0 0 60px rgba(0,169,224,0.12);">
                <!-- 헤더 -->
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <div id="status-dot" style="width:8px;height:8px;border-radius:50%;background:#06b6d4;"></div>
                        <span
                            style="font-size:10px;font-weight:900;color:#06b6d4;text-transform:uppercase;letter-spacing:0.15em;">Global
                            Intelligence Briefing</span>
                    </div>
                    <span id="line-counter" style="font-size:10px;font-weight:700;color:rgba(255,255,255,0.3);">1 /
                        1</span>
                </div>
                <!-- 타이핑 텍스트 -->
                <div style="min-height:100px;display:flex;align-items:flex-start;">
                    <p id="typing-text"
                        style="font-size:17px;font-weight:700;color:rgba(255,255,255,0.95);line-height:1.6;letter-spacing:-0.01em;margin:0;">
                    </p>
                    <span id="cursor"
                        style="display:inline-block;width:2px;height:20px;background:#06b6d4;margin-left:2px;animation:pulse 0.8s infinite;vertical-align:middle;"></span>
                </div>
                <!-- 진행 바 -->
                <div style="margin-top:20px;">
                    <div
                        style="width:100%;height:2px;background:rgba(255,255,255,0.1);border-radius:9999px;overflow:hidden;margin-bottom:12px;">
                        <div id="progress-bar-fill" style="width:0%;"></div>
                    </div>
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <span
                            style="font-size:9px;font-weight:900;color:rgba(255,255,255,0.25);text-transform:uppercase;letter-spacing:0.2em;">AI
                            Strategic Anchor Bot</span>
                        <button id="next-btn"
                            style="font-size:9px;font-weight:900;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.15em;background:none;border:none;cursor:pointer;padding:4px 8px;">Next
                            ▶</button>
                    </div>
                </div>
                <!-- 도트 인디케이터 -->
                <div id="dot-indicators" style="display:flex;gap:6px;margin-top:12px;flex-wrap:wrap;"></div>
            </div>
        </div>
    </div>

    <div id="root"></div>

    <!-- 앵커봇 로직 (순수 JS, React 밖) -->
    <script type="module">
        // Lottie 삽입
        const lottieEl = document.createElement('dotlottie-wc');
        lottieEl.setAttribute('src', 'https://lottie.host/3f71118b-e57a-458b-80e7-dd5601a557c9/uR8UCTEcRD.lottie');
        lottieEl.setAttribute('autoplay', '');
        lottieEl.setAttribute('loop', '');
        lottieEl.style.width = '280px';
        lottieEl.style.height = '280px';
        document.getElementById('lottie-container').appendChild(lottieEl);

        const INTEL_URL = "https://raw.githubusercontent.com/drasticlife/DA-news-hub/main/intel_report.json";
        const LINE_DURATION = 4000;
        const TYPING_SPEED = 30;
        const NEXT_LINE_DELAY = 300; // 0.3초 텀

        const PERIOD_ORDER = ["thisMonth", "thisWeek", "lastWeek", "lastMonth"];
        const PERIOD_LABELS = {
            thisMonth: "금월",
            thisWeek: "금주",
            lastWeek: "전주",
            lastMonth: "전월"
        };

        let scripts = {}; // 모든 기간의 대본 저장
        let periodIndex = 0;
        let lines = [];
        let currentIndex = 0;
        let typingTimer = null;
        let progressTimer = null;
        let delayTimer = null;

        const badge = document.getElementById('anchor-badge');
        const badgeText = document.getElementById('badge-text');
        const botName = document.getElementById('bot-name');
        const bubble = document.getElementById('speech-bubble');
        const typingText = document.getElementById('typing-text');
        const cursor = document.getElementById('cursor');
        const lineCounter = document.getElementById('line-counter');
        const progressFill = document.getElementById('progress-bar-fill');
        const dotContainer = document.getElementById('dot-indicators');
        const statusDot = document.getElementById('status-dot');
        const nextBtn = document.getElementById('next-btn');

        function buildDots() {
            dotContainer.innerHTML = '';
            lines.forEach((_, i) => {
                const d = document.createElement('div');
                d.style.cssText = `height:4px;border-radius:9999px;background:${i === currentIndex ? '#06b6d4' : 'rgba(255,255,255,0.1)'};width:${i === currentIndex ? '20px' : '4px'};transition:all 0.4s;`;
                dotContainer.appendChild(d);
            });
        }

        function startTyping() {
            clearAllTimers();

            const line = lines[currentIndex];
            typingText.textContent = '';
            cursor.style.display = 'inline-block';
            statusDot.style.background = '#4ade80'; // 초록 = 타이핑 중
            lineCounter.textContent = `${currentIndex + 1} / ${lines.length}`;
            nextBtn.textContent = currentIndex < lines.length - 1 ? `Next (${currentIndex + 1}/${lines.length}) ▶` : 'Restart ↺';
            buildDots();

            let charIdx = 0;
            typingTimer = setInterval(() => {
                charIdx++;
                typingText.textContent = line.slice(0, charIdx);
                if (charIdx >= line.length) {
                    clearInterval(typingTimer);
                    cursor.style.display = 'none';
                    statusDot.style.background = '#06b6d4'; // 시안 = 대기
                }
            }, TYPING_SPEED);

            // 진행 바
            progressFill.style.width = '0%';
            const startTime = Date.now();
            progressTimer = setInterval(() => {
                const pct = Math.min(((Date.now() - startTime) / LINE_DURATION) * 100, 100);
                progressFill.style.width = pct + '%';
                if (pct >= 100) {
                    clearInterval(progressTimer);

                    // 0.5초 텀 후 다음 라인
                    statusDot.style.background = '#f59e0b'; // 오렌지 = 대기(Delay)
                    delayTimer = setTimeout(() => {
                        currentIndex++;
                        if (currentIndex >= lines.length) {
                            // 현재 기간 종료 -> 다음 기간으로 로테이션
                            periodIndex = (periodIndex + 1) % PERIOD_ORDER.length;
                            loadPeriodScript();
                        } else {
                            startTyping();
                        }
                    }, NEXT_LINE_DELAY);
                }
            }, 50);
        }

        function clearAllTimers() {
            clearInterval(typingTimer);
            clearInterval(progressTimer);
            clearTimeout(delayTimer);
        }

        function loadPeriodScript() {
            clearAllTimers();
            const periodKey = PERIOD_ORDER[periodIndex];
            const scriptText = (scripts[periodKey] && scripts[periodKey].all) || "";

            if (!scriptText) {
                // 대본이 없으면 다음 기간으로 바로 건너뜀
                periodIndex = (periodIndex + 1) % PERIOD_ORDER.length;
                if (periodIndex === 0) return; // 한 바퀴 다 돌았는데 다 없으면 중단
                loadPeriodScript();
                return;
            }

            // 라벨 업데이트
            const label = document.querySelector('#speech-bubble span[style*="uppercase"]');
            if (label) label.textContent = `[${PERIOD_LABELS[periodKey]}] Global Intelligence Briefing`;

            // 기간 전환 시에도 0.5초 여유를 줌
            statusDot.style.background = '#f59e0b'; // 오렌지 = 전환 대기
            delayTimer = setTimeout(() => {
                // HTML 태그 제거 및 상세 분할 (문장 단위)
                const stripTags = s => s.replace(/<[^>]*>/g, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');

                // [수정] 단순 줄바꿈뿐만 아니라 마침표(. ) 등으로 문장을 분리하고, 각 문장을 적절한 길이로 여러 번 쪼개어 전체 내용을 다 보여줌
                const rawLines = scriptText.split('\n').filter(l => l.trim() !== '');
                lines = [];
                rawLines.forEach(line => {
                    const cleaned = stripTags(line).trim();
                    if (!cleaned) return;

                    // 문장 부호 뒤 공백을 기준으로 쪼갬
                    const sentences = cleaned.split(/(?<=[.!?])\s+/).filter(s => s.trim() !== '');
                    sentences.forEach(s => {
                        // 긴 문장을 70자 내외로 여러 조각(chunk)으로 쪼개기
                        if (s.length > 70) {
                            const words = s.split(' ');
                            let currentLine = '';
                            words.forEach(word => {
                                if ((currentLine + word).length > 70) {
                                    if (currentLine) lines.push(currentLine.trim());
                                    currentLine = word + ' ';
                                } else {
                                    currentLine += word + ' ';
                                }
                            });
                            if (currentLine) lines.push(currentLine.trim());
                        } else {
                            lines.push(s);
                        }
                    });
                });

                currentIndex = 0;
                startTyping();
            }, NEXT_LINE_DELAY);
        }

        function activateBot(scriptData) {
            scripts = scriptData; // { thisWeek: { all: "..." }, ... }
            badge.className = 'on-air';
            badgeText.textContent = 'On Air';
            botName.style.color = '#06b6d4';
            bubble.style.display = 'block';

            periodIndex = 0; // "thisMonth"부터 시작
            loadPeriodScript();
        }

        nextBtn.addEventListener('click', () => {
            clearAllTimers();
            currentIndex++;
            if (currentIndex >= lines.length) {
                periodIndex = (periodIndex + 1) % PERIOD_ORDER.length;
                loadPeriodScript();
            } else {
                startTyping();
            }
        });

        // intel_report.json 로드
        fetch(INTEL_URL)
            .then(r => r.json())
            .then(json => {
                // [최적화] 대시보드 공유를 위해 캐시 저장
                try {
                    sessionStorage.setItem('cachedIntel', JSON.stringify(json));
                } catch (e) { console.warn("Intel caching failed", e); }

                if (json && json.scripts) {
                    activateBot(json.scripts);
                } else if (json && json.dailyBriefing && json.dailyBriefing.script) {
                    // 폴백: 예전 구조인 경우 단순 표시
                    const fallbackScripts = { thisWeek: { all: json.dailyBriefing.script } };
                    activateBot(fallbackScripts);
                }
            })
            .catch(e => console.error('Intel load error:', e));
    </script>

    <!-- React 앱 (Globe + Strategic Feed) -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import Globe from 'react-globe.gl';
        import { Cpu } from 'lucide-react';

        const DATA_URL = "https://raw.githubusercontent.com/drasticlife/DA-news-hub/main/data.json";

        const REGION_COORDS = {
            'Global': { lat: 20, lng: 0 },
            'USA': { lat: 37, lng: -95 },
            'South Korea': { lat: 36, lng: 127 },
            'China': { lat: 35, lng: 104 },
            'Europe': { lat: 50, lng: 10 },
            'Japan': { lat: 36, lng: 138 },
            'Vietnam': { lat: 14, lng: 108 },
            'India': { lat: 20, lng: 78 },
            'Mexico': { lat: 23, lng: -102 },
            'Brazil': { lat: -14, lng: -52 },
            'Poland': { lat: 52, lng: 19 }
        };

        const stripHtml = str => str ? str.replace(/<[^>]*>/g, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&') : '';

        const App = () => {
            const globeRef = useRef();
            const rotRef = useRef(110);          // ← state 아닌 ref (리렌더 없음)
            const isInteractingRef = useRef(false);
            const interactionTimer = useRef();
            const rafRef = useRef();

            const [rawData, setRawData] = useState([]);
            const [activeRegion, setActiveRegion] = useState(null);

            // 데이터 로드
            useEffect(() => {
                fetch(DATA_URL)
                    .then(r => r.json())
                    .then(json => {
                        // [최적화] 대시보드 이동 시 재사용을 위해 캐시 저장 (2.2MB 수준이므로 sessionStorage 적합)
                        try {
                            sessionStorage.setItem('cachedNewsData', JSON.stringify(json));
                        } catch (e) {
                            console.warn("Data caching failed", e);
                        }

                        const formatted = json.map((item, idx) => ({
                            id: `news-${idx}`,
                            date: (item.A || item.Date || item.date || '').split('T')[0],
                            risk: item.G || item.Risk || item.risk || 'Low',
                            title: item.B || item.Title || item.title || '',
                            summary: stripHtml(item.D || item.Summary || item.summary || ''),
                            category: (item.C || item.Category || item.category || '').split(':')[0],
                            region: (item.I || item.Region || 'Global').split(',')[0].trim(),
                            bot: stripHtml(item.BOT || item.Bot || item.bot || '')
                        })).filter(d => d.date);
                        setRawData(formatted.reverse());
                    })
                    .catch(console.error);
            }, []);

            // 컨트롤 잠금
            useEffect(() => {
                const lock = () => {
                    if (!globeRef.current) return false;
                    const ctrl = globeRef.current.controls();
                    if (!ctrl) return false;
                    ctrl.enableZoom = false;
                    ctrl.enablePan = false;
                    const pa = Math.PI / 2 - (25 * Math.PI / 180);
                    ctrl.minPolarAngle = pa;
                    ctrl.maxPolarAngle = pa;
                    return true;
                };
                const t = setInterval(() => { if (lock()) clearInterval(t); }, 100);
                return () => clearInterval(t);
            }, []);

            // 초기 줌인
            useEffect(() => {
                if (!globeRef.current) return;
                globeRef.current.pointOfView({ lat: 25, lng: 110, altitude: 2.5 }, 0);
                setTimeout(() => globeRef.current?.pointOfView({ lat: 25, lng: 110, altitude: 0.8 }, 2500), 100);
            }, []);

            // RAF 회전 루프 — state 변경 없이 ref만 업데이트
            useEffect(() => {
                const loop = () => {
                    if (!isInteractingRef.current) {
                        rotRef.current -= 0.09;
                    }
                    if (globeRef.current) {
                        globeRef.current.pointOfView({ lng: rotRef.current, lat: 25, altitude: 0.8 }, 0);
                    }
                    // activeRegion 계산 (state 업데이트는 변경 시에만)
                    let closest = null, minDiff = Infinity;
                    Object.entries(REGION_COORDS).forEach(([name, c]) => {
                        const diff = Math.abs(((c.lng - rotRef.current + 180 + 360) % 360) - 180);
                        if (diff < 35 && diff < minDiff) { minDiff = diff; closest = name; }
                    });
                    setActiveRegion(prev => prev !== closest ? closest : prev);
                    rafRef.current = requestAnimationFrame(loop);
                };
                rafRef.current = requestAnimationFrame(loop);
                return () => cancelAnimationFrame(rafRef.current);
            }, []);

            // 휠 회전
            useEffect(() => {
                const onWheel = e => {
                    e.preventDefault();
                    if (e.ctrlKey) return;
                    isInteractingRef.current = true;
                    clearTimeout(interactionTimer.current);
                    interactionTimer.current = setTimeout(() => { isInteractingRef.current = false; }, 500);
                    rotRef.current += e.deltaY * 0.08;
                };
                window.addEventListener('wheel', onWheel, { passive: false });
                return () => window.removeEventListener('wheel', onWheel);
            }, []);

            const memoizedLabels = useMemo(() =>
                Object.entries(REGION_COORDS).map(([name, c]) => ({ ...c, name, type: 'region' }))
                , []);

            const activeRegionNews = useMemo(() => {
                if (!activeRegion) return rawData.slice(0, 5);
                const filtered = rawData.filter(d => (d.region || '').includes(activeRegion));
                return filtered.length > 0 ? filtered.slice(0, 5) : rawData.slice(0, 5);
            }, [activeRegion, rawData]);

            return (
                <div className="relative h-screen w-screen overflow-hidden">
                    {/* Globe */}
                    <div className="absolute inset-0 z-0">
                        <Globe
                            ref={globeRef}
                            globeImageUrl="https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg"
                            bumpImageUrl="https://unpkg.com/three-globe/example/img/earth-topology.png"
                            backgroundImageUrl="https://unpkg.com/three-globe/example/img/night-sky.png"
                            atmosphereColor="#3a228a"
                            atmosphereAltitude={0.2}

                            pointsData={Object.entries(REGION_COORDS).map(([name, c], i) => ({ ...c, name, id: i }))}
                            pointLat="lat" pointLng="lng"
                            pointColor={() => '#00a9e0'}
                            pointAltitude={0.01} pointRadius={0.6}

                            labelsData={memoizedLabels}
                            labelLat="lat" labelLng="lng"
                            labelText={d => d.name}
                            labelSize={1.0} labelDotRadius={0.2}
                            labelColor={() => 'rgba(255,255,255,0.9)'}
                            labelResolution={3} labelAltitude={0.01}

                            htmlElementsData={Object.entries(REGION_COORDS).map(([name, c]) => {
                                const diff = Math.abs(((c.lng - rotRef.current + 180 + 360) % 360) - 180);
                                const latestNews = rawData.find(d => (d.region || '').includes(name));
                                return { ...c, name, active: diff < 25 && name === activeRegion, news: latestNews ? latestNews.title : '전략 데이터 수집 중...' };
                            })}
                            htmlElement={d => {
                                const el = document.createElement('div');
                                el.innerHTML = `<div class="glass-panel p-4 rounded-2xl border-cyan-500/30 transition-all duration-500 ${d.active ? 'opacity-100 scale-100' : 'opacity-0 scale-90 pointer-events-none'}" style="width:220px;pointer-events:auto;">
                                    <div class="flex items-center gap-2 mb-2"><div class="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-pulse"></div><span class="text-[9px] font-black text-cyan-400 uppercase tracking-widest">${d.name} INSIGHT</span></div>
                                    <p class="text-[11px] font-bold text-white/90 leading-snug line-clamp-2">${d.news}</p>
                                    <div class="mt-2"><span class="text-[8px] font-bold text-white/30 uppercase tracking-tighter italic">Live Intelligence</span></div>
                                </div>`;
                                return el;
                            }}
                        />
                    </div>

                    {/* UI Overlay */}
                    <div style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', pointerEvents: 'none', zIndex: 100 }}>
                        {/* Header */}
                        <div className="absolute top-10 left-12 title-reveal" style={{ pointerEvents: 'none' }}>
                            <h1 className="text-4xl font-black tracking-tighter uppercase mb-1">DA PROCUREMENT</h1>
                            <div className="flex items-center gap-3">
                                <div className="h-[2px] w-12 bg-[#00a9e0]"></div>
                                <p className="text-[12px] font-medium tracking-[0.4em] text-white/60 uppercase">Daily Insight Journal</p>
                            </div>
                        </div>

                        {/* Strategic Feed - 우측 하단 배치 (겹침 방지) */}
                        <div className="absolute bottom-[24px] right-[48px] w-[420px]" style={{ pointerEvents: 'auto' }}>
                            <div className="glass-panel rounded-[40px] p-8 glow-cyan border-white/10">
                                <div className="flex items-center justify-between mb-8">
                                    <div className="flex items-center gap-3">
                                        <div className="p-4 bg-gradient-to-br from-blue-600 to-cyan-500 rounded-2xl shadow-lg">
                                            <Cpu size={24} className="text-white" />
                                        </div>
                                        <div>
                                            <p className="text-[10px] font-black tracking-[0.2em] text-cyan-400 uppercase">Regional Context</p>
                                            <h2 className="text-2xl font-black tracking-tight uppercase">Strategic Feed</h2>
                                        </div>
                                    </div>
                                    <span className="text-[10px] font-black px-3 py-1 bg-white/10 rounded-full tracking-widest text-white/40 uppercase">Live Intel</span>
                                </div>
                                <div className="pr-4 space-y-4">
                                    <div className="flex items-center gap-2 mb-2 px-2">
                                        <div className="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></div>
                                        <span className="text-[11px] font-bold text-cyan-400 uppercase tracking-widest">{activeRegion || 'Global'} Market Analysis</span>
                                    </div>
                                    {activeRegionNews.slice(0, 1).map((item, idx) => (
                                        <NewsFeedItem key={item.id || idx} item={item} />
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Controls - 복구됨 */}
                        <div className="absolute bottom-10 left-12" style={{ pointerEvents: 'auto' }}>
                            <div className="glass-panel px-6 py-3 rounded-2xl flex items-center gap-4 border-white/5 opacity-40 hover:opacity-100 transition-opacity">
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 rounded-full border border-white/30 flex items-center justify-center">
                                        <div className="w-1 h-3 bg-white/50 rounded-full animate-bounce"></div>
                                    </div>
                                    <span className="text-[10px] font-black tracking-widest text-white/60 uppercase">Rotate: Scroll 휠</span>
                                </div>
                                <div className="w-[1px] h-4 bg-white/10"></div>
                                <span className="text-[10px] font-bold text-cyan-400 tracking-widest uppercase">Target: Central Focus</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // [수정] Hooks 규칙 준수를 위해 별도 컴포넌트 추출 및 세부 분할 로직 강화
        const NewsFeedItem = ({ item }) => {
            const [chunkIdx, setChunkIdx] = useState(0);

            // 기사가 바뀌면 인덱스 초기화
            useEffect(() => {
                setChunkIdx(0);
            }, [item.id]);

            const chunks = useMemo(() => {
                const fullText = item.bot || item.summary;
                if (!fullText) return ['데이터 수집 중...'];

                // 1차 분할: 마침표 기준
                const initialChunks = fullText.split(/(?<=\.)\s+/).filter(s => s.trim() !== '');
                const finalChunks = [];

                // 2차 분할: 각 문장을 70자 내외로 여러 조각으로 쪼갬
                initialChunks.forEach(chunk => {
                    if (chunk.length > 70) {
                        const words = chunk.split(' ');
                        let currentLine = '';
                        words.forEach(word => {
                            if ((currentLine + word).length > 70) {
                                if (currentLine) finalChunks.push(currentLine.trim());
                                currentLine = word + ' ';
                            } else {
                                currentLine += word + ' ';
                            }
                        });
                        if (currentLine) finalChunks.push(currentLine.trim());
                    } else {
                        finalChunks.push(chunk);
                    }
                });

                return finalChunks;
            }, [item.bot, item.summary]);

            const currentChunk = chunks[chunkIdx] || chunks[0];
            const hasNext = chunkIdx < chunks.length - 1;

            return (
                <div
                    onClick={() => window.navigateTo(`index.html?targetId=${item.id}`)}
                    className="bg-white/[0.03] border border-white/5 p-6 rounded-3xl hover:bg-white/[0.08] transition-all hover:-translate-y-1 cursor-pointer group"
                >
                    <div className="flex items-center gap-4 mb-3">
                        <span className="text-[9px] font-black uppercase tracking-widest text-cyan-500 bg-cyan-500/10 px-2 py-1 rounded">#{item.category}</span>
                        <span className="text-[10px] text-white/20 font-bold ml-auto">{item.date}</span>
                    </div>
                    <h4 className="text-[15px] font-black leading-tight mb-3 text-white/90 group-hover:text-cyan-400 transition-colors">{item.title}</h4>

                    <p className="text-xs text-white/40 leading-relaxed min-h-[40px] transition-opacity duration-300">
                        {currentChunk}
                    </p>

                    <div className="mt-4 flex items-center justify-between">
                        <div className="flex gap-1">
                            {chunks.map((_, i) => (
                                <div key={i} className={`h-1 rounded-full transition-all duration-300 ${i === chunkIdx ? 'w-4 bg-cyan-500' : 'w-1 bg-white/10'}`} />
                            ))}
                        </div>
                        {chunks.length > 1 && (
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setChunkIdx(prev => (prev + 1) % chunks.length);
                                }}
                                className="text-[9px] font-black text-cyan-500/70 hover:text-cyan-400 uppercase tracking-widest flex items-center gap-1"
                            >
                                {hasNext ? `Next (${chunkIdx + 1}/${chunks.length})` : 'Restart'} <span className="text-[7px]">▶</span>
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <script>
        // ===== 네비게이션 전환 함수 =====
        function navigateTo(url) {
            const overlay = document.getElementById('transition-overlay');
            overlay.classList.add('fade-in');
            setTimeout(() => { window.location.href = url; }, 600);
        }

        function goToDashboard() {
            navigateTo('dashboard_mod.html');
        }

        function goToNewsHub() {
            // 기사 페이지(허브 뷰)로 이동
            navigateTo('index.html?view=hub');
        }

        function onPreloadDone() {
            // 프리로드 완료 시 Dashboard 버튼에 표시
            const btn = document.getElementById('dashboard-btn');
            if (btn) {
                btn.innerHTML = '▦ Dashboard <span style="font-size:9px;opacity:0.7;">✓ Ready</span>';
                btn.style.background = 'rgba(6,182,212,0.35)';
            }
        }
    </script>
</body>

</html>