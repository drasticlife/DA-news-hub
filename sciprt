/**
 * DA News Hub ì´ë¯¸ì§€ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ (v12.0 - GitHub í˜¸ìŠ¤íŒ… ì´ë¯¸ì§€)
 * 
 * [v12.0 ì—…ë°ì´íŠ¸]
 * - êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§í¬ê°€ ì›¹ì‚¬ì´íŠ¸ì—ì„œ ì°¨ë‹¨(ì—‘ë°•)ë˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´
 *   GitHub Pagesì— í˜¸ìŠ¤íŒ…ëœ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
 * - ì¤‘ìš”: 'default_news_cover.jpg' íŒŒì¼ì´ GitHubì— ì—…ë¡œë“œë˜ì–´ì•¼ ì •ìƒ í‘œì‹œë©ë‹ˆë‹¤.
 */

const FOLDER_ID = "11OsMn-4WoNhg9QfxgraLQSJtkmG7PXTj";
const MAX_RUNTIME = 1000 * 60 * 3.5; 

// â­ í™•ì •ëœ ëŒ€í‘œ ì´ë¯¸ì§€ (GitHub Pages í˜¸ìŠ¤íŒ…)
// íŒŒì¼ì´ GitHubì— ì—…ë¡œë“œë˜ë©´ ì´ ì£¼ì†Œê°€ ì‘ë™í•©ë‹ˆë‹¤.
const DEFAULT_IMAGE_URL = "https://drasticlife.github.io/DA-news-hub/default_news_cover.jpg";

// ğŸš« ìŠ¤í‚µí•  íŒŒì¼ í™•ì¥ì 
const SKIP_EXTENSIONS = ['.pdf', '.xls', '.xlsx', '.doc', '.docx', '.zip', '.hwp', '.ppt', '.pptx'];

// ğŸš« ìŠ¤í‚µí•  ë„ë©”ì¸ (ì‘ë‹µ ì—†ìŒ/ë³´ì•ˆ ì°¨ë‹¨ ì‚¬ì´íŠ¸)
const SKIP_DOMAINS = [
    'cmegroup.com', 
    'tradingeconomics.com', 'lme.com', 'bloomberg.com', 'metal.com', 'sunsirs.com', 'ptonline.com', 'reuters.com', 'wsj.com',
    'investing.com', 'marketwatch.com', 'cnbc.com', 'ft.com', 
    'chosun.com', 'yna.co.kr', 'donga.com', 'hani.co.kr', 'mk.co.kr', 'hankyung.com', 'joins.com', 'khan.co.kr'
];

function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('News Image Tools')
    .addItem('ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸: ì›ë³¸ ë§í¬)', 'updateNewsImages')
    .addItem('ì´ë¯¸ì§€ ë°±ì—…í•˜ê¸° (ë“œë¼ì´ë¸Œ ì €ì¥)', 'updateNewsImages_DriveBackup')
    .addSeparator()
    .addItem('ê¸°ì¡´ ë“œë¼ì´ë¸Œ íŒŒì¼ ê¶Œí•œ ìˆ˜ì •', 'fixExistingImagePermissions')
    .addToUi();
}

/**
 * [Main] í•«ë§í¬ ë°©ì‹
 */
function updateNewsImages() {
  const startTime = new Date().getTime();
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const lastRow = sheet.getLastRow();
  
  if (lastRow < 2) {
    SpreadsheetApp.getUi().alert("ì²˜ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const range = sheet.getRange(2, 1, lastRow - 1, 8);
  const data = range.getValues(); 
  let updateCount = 0;
  let defaultCount = 0;
  let isTimeOut = false;

  SpreadsheetApp.getActiveSpreadsheet().toast("ì´ë¯¸ì§€ ë§í¬ ê°€ì ¸ì˜¤ê¸°(Hotlink)ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...", "ğŸš€ ì‹œì‘");

  for (let i = 0; i < data.length; i++) {
    if (i % 5 === 0) {
        let msg = `ì§„í–‰ ì¤‘: ${i + 1}í–‰ / ${data.length}í–‰`;
        SpreadsheetApp.getActiveSpreadsheet().toast(msg, "ğŸ” ì§„í–‰ í˜„í™©");
    }
    
    // íƒ€ì„ì•„ì›ƒ
    if (new Date().getTime() - startTime > MAX_RUNTIME) {
      isTimeOut = true;
      break;
    }

    let urlInput = data[i][4]; 
    let currentImageVal = data[i][7];

    if (currentImageVal && currentImageVal.toString() !== "") {
        console.log(`[PASS] ${i+2}í–‰: ì™„ë£Œë¨`);
        continue;
    }
    
    if (!urlInput || typeof urlInput !== 'string') {
        sheet.getRange(i + 2, 8).setValue(DEFAULT_IMAGE_URL);
        defaultCount++;
        console.log(`[EMPTY->DEFAULT] ${i+2}í–‰: URL ì—†ì–´ ëŒ€í‘œ ì´ë¯¸ì§€ ì ìš©`);
        continue;
    }

    console.log(`[START] ${i+2}í–‰ ì‘ì—… ì‹œì‘...`);

    let urls = urlInput.split(/[\n,]+/)
        .map(u => u.trim())
        .filter(u => u.startsWith('http'));

    let finalImgUrl = null;

    for (let targetUrl of urls) {
      let lowerUrl = targetUrl.toLowerCase();
      // 1. íŒŒì¼ í™•ì¥ì ì²´í¬
      if (SKIP_EXTENSIONS.some(ext => lowerUrl.endsWith(ext))) {
         console.log(`  [SKIP-FILE] íŒŒì¼ ë§í¬ ê±´ë„ˆëœ€: ${targetUrl}`);
         continue;
      }
      // 2. ì°¨ë‹¨ ë„ë©”ì¸ ì²´í¬
      if (SKIP_DOMAINS.some(domain => lowerUrl.includes(domain))) {
          console.log(`  [SKIP-DOMAIN] ì ‘ì† ì°¨ë‹¨ ì‚¬ì´íŠ¸ ê±´ë„ˆëœ€: ${targetUrl}`);
          continue; 
      }

      console.log(`  >> ì ‘ì† ì‹œë„: ${targetUrl}`); 

      try {
        let response = UrlFetchApp.fetch(targetUrl, { 
            muteHttpExceptions: true, 
            validateHttpsCertificates: false,
            headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36' } 
        });
        
        if (response.getResponseCode() === 200) {
            let html = response.getContentText();
            let imgMatch = 
                html.match(/<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["']/i) ||
                html.match(/<meta[^>]+content=["']([^"']+)["'][^>]+property=["']og:image["']/i) ||
                html.match(/<meta[^>]+name=["']twitter:image["'][^>]+content=["']([^"']+)["']/i) ||
                html.match(/<meta[^>]+content=["']([^"']+)["'][^>]+name=["']twitter:image["']/i) ||
                html.match(/<meta[^>]+itemprop=["']image["'][^>]+content=["']([^"']+)["']/i);
            
            if (imgMatch && imgMatch[1]) {
                finalImgUrl = imgMatch[1];
                if (!finalImgUrl.startsWith('http')) {
                    let domainMatch = targetUrl.match(/^https?:\/\/[^\/]+/);
                    if(domainMatch) finalImgUrl = (finalImgUrl.startsWith('/') ? domainMatch[0] : domainMatch[0] + '/') + finalImgUrl;
                }
                console.log(`  [SUCCESS] ì´ë¯¸ì§€ ì°¾ìŒ!`);
                break; 
            }
        }
      } catch (e) {
        console.log(`  [ERROR] ì ‘ì† ì‹¤íŒ¨: ${e.toString()}`);
      }
    }

    if (!finalImgUrl) {
        finalImgUrl = DEFAULT_IMAGE_URL;
        defaultCount++;
        console.log(`[DEFAULT] ${i+2}í–‰: ëŒ€í‘œ ì´ë¯¸ì§€ ì ìš©`);
    }

    if (finalImgUrl) {
      sheet.getRange(i + 2, 8).setValue(finalImgUrl);
      updateCount++;
      if(updateCount % 10 === 0) SpreadsheetApp.flush();
    }
  }
  
  SpreadsheetApp.flush();
  
  let msg = `âœ… ì™„ë£Œ! ì´ ${updateCount}ê±´ ì²˜ë¦¬ë¨`;
  if (defaultCount > 0) msg += ` (ëŒ€í‘œ ì´ë¯¸ì§€ ${defaultCount}ê±´)`;
  if (isTimeOut) msg += "\nâ³ ì‹œê°„ ì œí•œ ì¤‘ë‹¨. ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.";
  
  SpreadsheetApp.getUi().alert(msg);
}

function updateNewsImages_DriveBackup() {
    SpreadsheetApp.getUi().alert("ë°±ì—… ê¸°ëŠ¥ì€ í˜„ì¬ ìœ ì§€ë³´ìˆ˜ ì¤‘ì…ë‹ˆë‹¤.");
}

function fixExistingImagePermissions() {
  const folder = DriveApp.getFolderById(FOLDER_ID);
  const files = folder.getFiles();
  let count = 0;
  while (files.hasNext()) {
    files.next().setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    count++;
  }
  SpreadsheetApp.getUi().alert(count + "ê°œ íŒŒì¼ ê¶Œí•œ ìˆ˜ì • ì™„ë£Œ.");
}