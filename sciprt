/**
 * DA News Hub í†µí•© ìŠ¤í¬ë¦½íŠ¸ (v13.0)
 * 
 * [ê¸°ëŠ¥ 1] ì›¹ ì•± (JSON API)
 * - êµ¬ê¸€ ì‹œíŠ¸ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ JSON í˜•íƒœë¡œ ì œê³µí•©ë‹ˆë‹¤.
 * - doGet í•¨ìˆ˜ê°€ ì´ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 * - ë°˜ë“œì‹œ [ë°°í¬] > [ìƒˆ ë°°í¬] > [ì›¹ ì•±]ìœ¼ë¡œ ë°°í¬ í›„ URLì„ index.htmlì— ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤.
 * 
 * [ê¸°ëŠ¥ 2] ì´ë¯¸ì§€ ìë™í™”
 * - ì™¸ë¶€ ë§í¬ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì™€ ì‹œíŠ¸ì— ì €ì¥í•©ë‹ˆë‹¤.
 */

// ==========================================
// [ê¸°ëŠ¥ 1] ì›¹ ì•± API (ë°ì´í„° ì„œë¹™)
// ==========================================
function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  // ëª¨ë“  ë°ì´í„° ë²”ìœ„ ê°€ì ¸ì˜¤ê¸° (Aì—´~ë§ˆì§€ë§‰ì—´)
  // Iì—´(Region), Jì—´(Tag)ì´ í¬í•¨ë˜ë ¤ë©´ ì‹œíŠ¸ 1í–‰ì— í—¤ë”(Region, Tag)ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
  const data = sheet.getDataRange().getValues();
  
  if (data.length === 0) {
    return ContentService.createTextOutput(JSON.stringify([]))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const headers = data[0];
  const rows = data.slice(1);
  
  const result = rows.map(row => {
    const obj = {};
    headers.forEach((header, index) => {
      // í—¤ë” ì´ë¦„ì´ ìˆëŠ” ì—´ë§Œ ê°ì²´ì— ë‹´ìŠµë‹ˆë‹¤.
      // ì˜ˆ: Date, Title, Category, Summary, URL, Risk, Impact, Image, Region, Tag
      if(header) {
        obj[header] = row[index];
      }
    });
    return obj;
  });
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}


// ==========================================
// [ê¸°ëŠ¥ 2] ì´ë¯¸ì§€ ìë™í™” ë„êµ¬
// ==========================================

const FOLDER_ID = "11OsMn-4WoNhg9QfxgraLQSJtkmG7PXTj";
const MAX_RUNTIME = 1000 * 60 * 3.5; 

// â­ í™•ì •ëœ ëŒ€í‘œ ì´ë¯¸ì§€ (GitHub Pages í˜¸ìŠ¤íŒ…)
const DEFAULT_IMAGE_URL = "https://drasticlife.github.io/DA-news-hub/default_news_cover.jpg";

// ğŸš« ìŠ¤í‚µí•  íŒŒì¼ í™•ì¥ì 
const SKIP_EXTENSIONS = ['.pdf', '.xls', '.xlsx', '.doc', '.docx', '.zip', '.hwp', '.ppt', '.pptx'];

// ğŸš« ìŠ¤í‚µí•  ë„ë©”ì¸
const SKIP_DOMAINS = [
    'cmegroup.com', 
    'tradingeconomics.com', 'lme.com', 'bloomberg.com', 'metal.com', 'sunsirs.com', 'ptonline.com', 'reuters.com', 'wsj.com',
    'investing.com', 'marketwatch.com', 'cnbc.com', 'ft.com', 
    'chosun.com', 'yna.co.kr', 'donga.com', 'hani.co.kr', 'mk.co.kr', 'hankyung.com', 'joins.com', 'khan.co.kr'
];

function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('News Image Tools')
    .addItem('ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸: ì›ë³¸ ë§í¬)', 'updateNewsImages')
    .addItem('ì´ë¯¸ì§€ ë°±ì—…í•˜ê¸° (ë“œë¼ì´ë¸Œ ì €ì¥)', 'updateNewsImages_DriveBackup')
    .addSeparator()
    .addItem('ê¸°ì¡´ ë“œë¼ì´ë¸Œ íŒŒì¼ ê¶Œí•œ ìˆ˜ì •', 'fixExistingImagePermissions')
    .addToUi();
}

function updateNewsImages() {
  const startTime = new Date().getTime();
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const lastRow = sheet.getLastRow();
  
  if (lastRow < 2) {
    SpreadsheetApp.getUi().alert("ì²˜ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ë°ì´í„° ë²”ìœ„: Hì—´(8ë²ˆì§¸)ê¹Œì§€ë§Œ ì“°ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì „ì²´ ë¡œì§ìƒ URLì€ Eì—´(5ë²ˆì§¸), ì´ë¯¸ì§€ëŠ” Hì—´(8ë²ˆì§¸)
  // I, Jì—´ì´ ì¶”ê°€ë˜ì–´ë„ ì´ ë¡œì§ì€ Hì—´ê¹Œì§€ë§Œ ê±´ë“œë¦¬ë¯€ë¡œ ì•ˆì „í•©ë‹ˆë‹¤.
  const range = sheet.getRange(2, 1, lastRow - 1, 8);
  const data = range.getValues(); 
  let updateCount = 0;
  let defaultCount = 0;
  let isTimeOut = false;

  SpreadsheetApp.getActiveSpreadsheet().toast("ì´ë¯¸ì§€ ë§í¬ ê°€ì ¸ì˜¤ê¸°(Hotlink)ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...", "ğŸš€ ì‹œì‘");

  for (let i = 0; i < data.length; i++) {
    if (i % 5 === 0) {
        let msg = `ì§„í–‰ ì¤‘: ${i + 1}í–‰ / ${data.length}í–‰`;
        SpreadsheetApp.getActiveSpreadsheet().toast(msg, "ğŸ” ì§„í–‰ í˜„í™©");
    }
    
    if (new Date().getTime() - startTime > MAX_RUNTIME) {
      isTimeOut = true;
      break;
    }

    let urlInput = data[i][4]; // Eì—´ URL
    let currentImageVal = data[i][7]; // Hì—´ Image

    if (currentImageVal && currentImageVal.toString() !== "") {
        console.log(`[PASS] ${i+2}í–‰: ì™„ë£Œë¨`);
        continue;
    }
    
    if (!urlInput || typeof urlInput !== 'string') {
        sheet.getRange(i + 2, 8).setValue(DEFAULT_IMAGE_URL);
        defaultCount++;
        console.log(`[EMPTY->DEFAULT] ${i+2}í–‰: URL ì—†ì–´ ëŒ€í‘œ ì´ë¯¸ì§€ ì ìš©`);
        continue;
    }

    console.log(`[START] ${i+2}í–‰ ì‘ì—… ì‹œì‘...`);

    let urls = urlInput.split(/[\n,]+/)
        .map(u => u.trim())
        .filter(u => u.startsWith('http'));

    let finalImgUrl = null;

    for (let targetUrl of urls) {
      let lowerUrl = targetUrl.toLowerCase();
      if (SKIP_EXTENSIONS.some(ext => lowerUrl.endsWith(ext))) continue;
      if (SKIP_DOMAINS.some(domain => lowerUrl.includes(domain))) continue;

      try {
        let response = UrlFetchApp.fetch(targetUrl, { 
            muteHttpExceptions: true, 
            validateHttpsCertificates: false,
            headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36' } 
        });
        
        if (response.getResponseCode() === 200) {
            let html = response.getContentText();
            let imgMatch = 
                html.match(/<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["']/i) ||
                html.match(/<meta[^>]+content=["']([^"']+)["'][^>]+property=["']og:image["']/i) ||
                html.match(/<meta[^>]+name=["']twitter:image["'][^>]+content=["']([^"']+)["']/i) ||
                html.match(/<meta[^>]+content=["']([^"']+)["'][^>]+name=["']twitter:image["']/i) ||
                html.match(/<meta[^>]+itemprop=["']image["'][^>]+content=["']([^"']+)["']/i);
            
            if (imgMatch && imgMatch[1]) {
                finalImgUrl = imgMatch[1];
                if (!finalImgUrl.startsWith('http')) {
                    let domainMatch = targetUrl.match(/^https?:\/\/[^\/]+/);
                    if(domainMatch) finalImgUrl = (finalImgUrl.startsWith('/') ? domainMatch[0] : domainMatch[0] + '/') + finalImgUrl;
                }
                break; 
            }
        }
      } catch (e) {
        console.log(`  [ERROR] ì ‘ì† ì‹¤íŒ¨: ${e.toString()}`);
      }
    }

    if (!finalImgUrl) {
        finalImgUrl = DEFAULT_IMAGE_URL;
        defaultCount++;
    }

    if (finalImgUrl) {
      sheet.getRange(i + 2, 8).setValue(finalImgUrl);
      updateCount++;
      if(updateCount % 10 === 0) SpreadsheetApp.flush();
    }
  }
  
  SpreadsheetApp.flush();
  
  let msg = `âœ… ì™„ë£Œ! ì´ ${updateCount}ê±´ ì²˜ë¦¬ë¨`;
  if (defaultCount > 0) msg += ` (ëŒ€í‘œ ì´ë¯¸ì§€ ${defaultCount}ê±´)`;
  if (isTimeOut) msg += "\nâ³ ì‹œê°„ ì œí•œ ì¤‘ë‹¨. ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.";
  
  SpreadsheetApp.getUi().alert(msg);
}

function updateNewsImages_DriveBackup() {
    SpreadsheetApp.getUi().alert("ë°±ì—… ê¸°ëŠ¥ì€ í˜„ì¬ ìœ ì§€ë³´ìˆ˜ ì¤‘ì…ë‹ˆë‹¤.");
}

function fixExistingImagePermissions() {
  const folder = DriveApp.getFolderById(FOLDER_ID);
  const files = folder.getFiles();
  let count = 0;
  while (files.hasNext()) {
    files.next().setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    count++;
  }
  SpreadsheetApp.getUi().alert(count + "ê°œ íŒŒì¼ ê¶Œí•œ ìˆ˜ì • ì™„ë£Œ.");
}
