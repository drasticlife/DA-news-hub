<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DA Strategic Dashboard</title>

    <!-- 1. Tailwind CSS (ë””ìì¸) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/index.css" />

    <!-- 2. Import Map (ë¦¬ì•¡íŠ¸ ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª¨ë“ˆ ì„¤ì •) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react"
        }
    }
    </script>

    <!-- 3. Babel (JSX ë³€í™˜ê¸°) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lottie Web Component (ìƒˆ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜) -->
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.11/dist/dotlottie-wc.js" type="module"></script>

    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #E2E8F0;
            border-radius: 0px;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #F8F9FB;
        }

        * {
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        /* Strategic Narrative ë‚´ ê°•ì¡° ìŠ¤íƒ€ì¼ (index.html ì¼ê´€ì„±) */
        h2 mark {
            background-color: #DBEAFE;
            color: #1D4ED8;
            border-radius: 3px;
            padding: 0 3px;
            font-weight: 700;
        }

        h2 b {
            color: #1E40AF;
            font-weight: 900;
        }
    </style>
</head>

<body>
    <!-- â”€â”€ ê¸€ë¡œë²Œ ë„¤ë¹„ ë“œë¡œì–´ (ìˆœìˆ˜ HTML, React ì™¸ë¶€) â”€â”€ -->
    <div id="dashmod-drawer-overlay" onclick="closeDashModDrawer()"
        style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1200;backdrop-filter:blur(2px);">
    </div>
    <div id="dashmod-drawer"
        style="position:fixed;top:0;left:-320px;width:280px;height:100%;background:white;z-index:1300;transition:left 0.3s cubic-bezier(0.4,0,0.2,1);overflow-y:auto;padding:20px 16px;box-shadow:4px 0 24px rgba(0,0,0,0.15);font-family:'Pretendard',sans-serif;">

        <div
            style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #e2e8f0;">
            <div style="display:flex;align-items:center;gap:8px;">
                <div
                    style="background:#0033A0;color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:900;letter-spacing:0.1em;">
                    DA</div>
                <span
                    style="font-weight:700;font-size:13px;color:#0033A0;text-transform:uppercase;letter-spacing:0.03em;">Purchase
                    Intel</span>
            </div>
            <button onclick="closeDashModDrawer()"
                style="padding:4px;border-radius:8px;border:none;background:transparent;cursor:pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="#94a3b8" stroke-width="2.5" stroke-linecap="round">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>

        <div
            style="font-size:9px;font-weight:900;letter-spacing:0.18em;color:#94a3b8;text-transform:uppercase;padding:0 4px;margin-bottom:8px;">
            NAVIGATE</div>
        <nav style="display:flex;flex-direction:column;gap:2px;margin-bottom:16px;">
            <a href="index.html?view=hub"
                style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#475569;text-decoration:none;font-size:13px;font-weight:700;transition:all 0.15s;"
                onmouseover="this.style.background='#eff6ff';this.style.color='#0033A0';"
                onmouseout="this.style.background='';this.style.color='#475569';">
                <span
                    style="width:28px;height:28px;background:#f1f5f9;border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;">ğŸ“°</span>
                <span>News Hub</span>
            </a>
            <a href="dashboard_mod.html"
                style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;background:#eff6ff;color:#0033A0;text-decoration:none;font-size:13px;font-weight:700;">
                <span
                    style="width:28px;height:28px;background:#dbeafe;border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;">ğŸ“Š</span>
                <span style="flex:1;">Dashboard</span>
                <span
                    style="font-size:9px;font-weight:900;padding:2px 7px;border-radius:99px;background:#dbeafe;color:#0033A0;">í˜„ì¬</span>
            </a>
            <a href="dashboard_3d.html"
                style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#475569;text-decoration:none;font-size:13px;font-weight:700;transition:all 0.15s;"
                onmouseover="this.style.background='#eff6ff';this.style.color='#0033A0';"
                onmouseout="this.style.background='';this.style.color='#475569';">
                <span
                    style="width:28px;height:28px;background:#f1f5f9;border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;">ğŸŒ</span>
                <span>3D Globe Briefing</span>
            </a>
            <a href="wiki/index.html"
                style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#475569;text-decoration:none;font-size:13px;font-weight:700;transition:all 0.15s;"
                onmouseover="this.style.background='#eff6ff';this.style.color='#0033A0';"
                onmouseout="this.style.background='';this.style.color='#475569';">
                <span
                    style="width:28px;height:28px;background:#f1f5f9;border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;">ğŸ“–</span>
                <span style="flex:1;">Product Wiki</span>
                <span
                    style="font-size:9px;font-weight:900;padding:2px 7px;border-radius:99px;background:#fef3c7;color:#d97706;">NEW</span>
            </a>
        </nav>

        <div style="border-top:1px solid #e2e8f0;margin:16px 0;"></div>
        <div id="dashmod-user-info"
            style="font-size:11px;color:#94a3b8;font-weight:600;margin-bottom:10px;padding:0 4px;"></div>
        <button id="dashmod-logout-btn" onclick="dashmodLogout()"
            style="display:none;width:100%;padding:9px 12px;border-radius:8px;border:none;background:#fef2f2;color:#ef4444;font-size:12px;font-weight:700;cursor:pointer;text-align:left;align-items:center;gap:8px;margin-bottom:6px;transition:background 0.2s;"
            onmouseover="this.style.background='#fee2e2';" onmouseout="this.style.background='#fef2f2';">
            ğŸšª ë¡œê·¸ì•„ì›ƒ
        </button>
        <a href="index.html" id="dashmod-login-btn"
            style="display:flex;align-items:center;gap:8px;width:100%;padding:9px 12px;border-radius:8px;background:#f0fdf4;color:#16a34a;font-size:12px;font-weight:700;text-decoration:none;transition:background 0.2s;"
            onmouseover="this.style.background='#dcfce7';" onmouseout="this.style.background='#f0fdf4';">
            ğŸ”‘ ë¡œê·¸ì¸ í™”ë©´
        </a>
    </div>

    <!-- â”€â”€ ê¸€ë¡œë²Œ í—¤ë” (DA Wiki Header ë³µì œ) â”€â”€ -->
    <header class="da-wiki-header"
        style="position:fixed;top:0;left:0;right:0;height:56px;background:#0033A0;color:white;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:1100;box-shadow:0 2px 16px rgba(0,51,160,0.5);backdrop-filter:blur(4px);border-bottom:1px solid rgba(255,255,255,0.1);transform:translateZ(0);">
        <div style="display:flex;align-items:center;gap:12px;">
            <button onclick="toggleDashModDrawer()" aria-label="ë©”ì¸ í—ˆë¸Œ ë©”ë‰´ ì—´ê¸°" id="dashmod-hamburger"
                style="display:flex;align-items:center;justify-content:center;color:white;opacity:0.8;transition:opacity 0.15s;background:transparent;border:none;cursor:pointer;padding:0;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="4" x2="20" y1="12" y2="12" />
                    <line x1="4" x2="20" y1="6" y2="6" />
                    <line x1="4" x2="20" y1="18" y2="18" />
                </svg>
            </button>
            <a href="index.html?view=hub"
                style="display:flex;align-items:center;gap:8px;text-decoration:none;color:white;opacity:0.95;transition:opacity 0.15s;">
                <div
                    style="background:white;color:#0033A0;font-size:10px;font-weight:900;padding:2px 6px;border-radius:4px;letter-spacing:0.05em;">
                    DA</div>
                <span
                    style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;white-space:nowrap;"
                    class="hidden sm:inline">Purchase Intelligence</span>
            </a>
            <div style="color:rgba(255,255,255,0.4);font-size:12px;" class="hidden sm:inline">/</div>
            <span
                style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;color:rgba(255,255,255,0.8);"
                class="hidden sm:inline">Dashboard</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
            <a href="wiki/index.html"
                style="display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:99px;font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:0.1em;text-decoration:none;transition:all 0.15s;white-space:nowrap;background:rgba(255,255,255,0.12);color:white;"
                onmouseover="this.style.background='rgba(255,255,255,0.22)'"
                onmouseout="this.style.background='rgba(255,255,255,0.12)'">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                </svg>
                <span class="hidden sm:inline">Product Wiki</span>
            </a>
            <a href="index.html?view=hub"
                style="display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:99px;font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:0.1em;text-decoration:none;transition:all 0.15s;white-space:nowrap;background:#3b82f6;color:white;"
                onmouseover="this.style.background='#60a5fa'" onmouseout="this.style.background='#3b82f6'">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v2" />
                    <path d="M4 22a2 2 0 0 1-2-2v-7l3-3 3 3v9" />
                    <path d="M14 13h4" />
                    <path d="M14 9h4" />
                    <path d="M14 17h4" />
                </svg>
                <span class="hidden sm:inline">News Hub</span>
            </a>
        </div>
    </header>
    <div id="root"></div>

    <!-- 4. ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer,
            BarChart, Bar, Cell, Legend, AreaChart, Area
        } from 'recharts';
        import {
            Globe, Calendar, LayoutGrid, ArrowUpRight,
            Search, Bell, Moon, Sun, TrendingUp, AlertCircle, Info, Filter, MousePointer2, Clock, MapPin, CheckCircle2,
            Zap, Hash, ShieldAlert, Sparkles, MessageSquare, Tag, Fingerprint, ExternalLink, ChevronDown, List,
            ChevronsLeft, ChevronsRight, ChevronLeft, ChevronRight, RotateCcw, CalendarRange, XCircle, Target,
            BarChart3, FileText, Eye, LogOut, X, Cpu
        } from 'lucide-react';

        const RAW_DATA_URL = "https://raw.githubusercontent.com/drasticlife/DA-news-hub/main/data.json";
        const GAS_URL = "https://script.google.com/macros/s/AKfycby6E7X1vODajQSkXLyWVjstXR7IF0LY7W8sHiCHVNbrp1cjEEQBttS7fWZxTYw9i0ie6Q/exec";
        const INTEL_URL = "https://raw.githubusercontent.com/drasticlife/DA-news-hub/main/intel_report.json";

        // --- 1. ìƒìˆ˜ ì •ì˜ (ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ìµœìƒë‹¨ ê³ ì •) ---
        const COLORS = {
            headerBlue: '#0033A0',
            activeBlue: '#0747A6',
            riskHigh: '#DE350B',
            riskMed: '#FFAB00',
            riskLow: '#00B8D9',
        };

        const RISK_COLORS = {
            'High': COLORS.riskHigh,
            'Med': COLORS.riskMed,
            'Low': COLORS.riskLow
        };

        const CATEGORY_COLORS = {
            'ì›ìì¬': '#0747A6',
            'ê±°ì‹œ/ì •ì±…': '#2684FF',
            'ê²½ìŸì‚¬': '#4C9AFF',
            'ìƒì‚°ì§€ì—­': '#8993A4',
            'ì‹ ê¸°ìˆ ë™í–¥': '#0052CC',
            'ê¸°íƒ€': '#B3D4FF'
        };

        const REGION_COORDS = {
            'Global': { x: '50%', y: '45%' },
            'USA': { x: '22%', y: '40%' },
            'South Korea': { x: '82%', y: '42%' },
            'China': { x: '78%', y: '45%' },
            'Europe': { x: '52%', y: '35%' },
            'Japan': { x: '85%', y: '45%' },
            'Vietnam': { x: '76%', y: '58%' },
            'India': { x: '70%', y: '55%' },
            'Mexico': { x: '25%', y: '50%' },
        };

        // --- 2. Helper Functions ---

        const safeString = (val) => {
            if (val === null || val === undefined) return "";
            if (typeof val === 'object') {
                if (Array.isArray(val)) return val.join(', ');
                return "";
            }
            return String(val);
        };

        const normalizeDate = (dateStr) => {
            const ds = safeString(dateStr);
            if (!ds || ds.includes("NaN")) return "";
            const tSplit = ds.split('T')[0];
            const cleaned = tSplit.replace(/[\.\/]/g, '-');
            const parts = cleaned.split('-');
            if (parts.length === 3) {
                const y = parts[0];
                const m = parts[1].padStart(2, '0');
                const d = parts[2].padStart(2, '0');
                return `${y}-${m}-${d}`;
            }
            return isNaN(new Date(cleaned).getTime()) ? "" : cleaned;
        };

        const normalizeCategory = (catStr) => {
            const cs = safeString(catStr);
            if (!cs) return "ê¸°íƒ€";
            const base = cs.split(':')[0].trim();
            if (base === 'AIê¸°ìˆ ' || base === 'AIê¸°ëŠ¥' || base === 'ì‹ ê¸°ìˆ ' || base === 'ì‹ ê¸°ìˆ ë™í–¥') return 'ì‹ ê¸°ìˆ ë™í–¥';
            if (base.includes('ê±°ì‹œ') || base.includes('ì •ì±…') || base.includes('ê±°ì‹œê²½ì œ')) return 'ê±°ì‹œ/ì •ì±…';
            if (base.includes('ì§€ì—­') || base.includes('ìƒì‚°')) return 'ì§€ì—­ë³„ ë¶„ì„';
            return base;
        };

        const translateCategory = (catStr, lang) => {
            if (lang === 'KO') return catStr;
            const cs = safeString(catStr).replace(/^#/, '').trim(); // # ì œê±° ë° íŠ¸ë¦¬ë°
            const mapping = {
                // ìƒë‹¨ ë©”ë‰´ ë° ëŒ€í‘œ ì¹´í…Œê³ ë¦¬
                'ì›ìì¬': 'Material',
                'ê±°ì‹œ/ì •ì±…': 'Macro',
                'ì§€ì—­ë³„ ë¶„ì„': 'Region',
                'ê²½ìŸì‚¬': 'Competitors',
                'ì‹ ê¸°ìˆ ë™í–¥': 'New Tech',
                'ê¸°íƒ€': 'Misc',
                'í†µí•© ë¶„ì„': 'Unified',
                'ê³µê¸‰ë§ í†µí•©': 'Supply Chain',
                'ì „ëµ ì‹œí™©': 'Strategy',

                // ì›ë³¸ ë°ì´í„° ì‹œíŠ¸ ëª…ì¹­ ëŒ€ì‘
                'ê±°ì‹œê²½ì œ': 'Macro',
                'ìƒì‚°ì§€ì—­': 'Region',

                // ìƒì„¸ ì¹´í…Œê³ ë¦¬ ë° ìƒìœ„ íƒœê·¸
                'ìˆ˜ê¸‰': 'Supply',
                'ì›ìì¬ìˆ˜ê¸‰': 'Supply',
                'ê°€ê²©': 'Price',
                'ì›ê°€ì„±ê³¼': 'Cost',
                'í™˜ìœ¨': 'Exchange',
                'ê´€ìœ¨': 'Exchange', // ì‚¬ìš©ì ì˜¤íƒ€ ëŒ€ì‘
                'ê¸ˆë¦¬': 'Rate',
                'ë…¸ë™ì •ì¹˜': 'Labor/Politics',
                'ì •ì¹˜': 'Politics',
                'ë…¸ë™': 'Labor',
                'ì •ì±…': 'Policy',
                'ê¸°ëŠ¥': 'Features',
                'ê¸°ìˆ ': 'Tech',
                'ê³µê¸‰ë§': 'Supply Chain',
                'ì›ê°€': 'Cost',
                'ìˆ˜ì¶œ': 'Export',
                'ìˆ˜ì…': 'Import',

                // ì£¼ìš” ë‰´ìŠ¤ íƒœê·¸ (Strategic Tags ëŒ€ì‘)
                'ê´€ì„¸': 'Tariff',
                'ì² ê°•': 'Steel',
                'ë¯¸êµ­': 'USA',
                'ì¤‘êµ­': 'China',
                'ì¸ë„': 'India',
                'ìœ ëŸ½': 'Europe',
                'ì¼ë³¸': 'Japan',
                'ì „ê¸°ë£Œ': 'Power',
                'êµ¬ë¦¬': 'Copper',
                'ì•Œë£¨ë¯¸ëŠ„': 'Aluminum',
                'ë™ê²°': 'Freeze',
                'ë„¤ê³ ': 'Nego',
                'ë°°í„°ë¦¬': 'Battery',
                'ë°˜ë„ì²´': 'Chips',
                'ì „ê¸°ì°¨': 'EV',
                'ë³´ì¡°ê¸ˆ': 'Subsidy',
                'ì¸í”Œë ˆì´ì…˜': 'Inflation',
                'ëŸ¬ì‹œì•„': 'Russia',
                'ìš°í¬ë¼ì´ë‚˜': 'Ukraine',
                'ìœ ê°€': 'Oil Price',
                'íƒ„ì†Œ': 'Carbon',
                'ê³µê¸‰': 'Supply',
                'ìˆ˜ìš”': 'Demand',
                'ì¬ê³ ': 'Inventory',
                'ì„¤ë¹„': 'Equipment',
                'íˆ¬ì': 'Investment',
                'M&A': 'M&A',
                'íŠ¹í—ˆ': 'Patent',
                'í‘œì¤€': 'Standard',
                'ê·œì œ': 'Regulation',
                'ì œì¬': 'Sanction',
                'í˜‘ìƒ': 'Negotiation',
                'íŒŒì—…': 'Strike',
                'ì „ë§': 'Outlook',
                'í˜„í™©': 'Status',
                'ë¶„ì„': 'Analysis',
                'ë³´ê³ ': 'Report',
                'ë™í–¥': 'Trend',
                'ì´ìŠˆ': 'Issue',
                'ë¦¬ìŠ¤í¬': 'Risk',
                'ê¸€ë¡œë²Œ': 'Global',
                'ê³µê¸‰ë§ë¦¬ìŠ¤í¬': 'SCM Risk',
                'ì›ìì¬ê°€ê²©': 'Material Price',
                'ì¹œí™˜ê²½': 'Eco-friendly',
                'ESG': 'ESG',
                'RE100': 'RE100',
                'íƒ„ì†Œì¤‘ë¦½': 'Net Zero',
                'í•µì‹¬ê´‘ë¬¼': 'Critical Minerals',
                'í¬í† ë¥˜': 'Rare Earth',
                'ë¦¬íŠ¬': 'Lithium',
                'ë‹ˆì¼ˆ': 'Nickel',
                'ì½”ë°œíŠ¸': 'Cobalt',
                'í‘ì—°': 'Graphite'
            };

            // ì½œë¡  ê¸°ë°˜ ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬
            if (cs.includes(':')) {
                const parts = cs.split(':').map(p => p.trim());
                const main = mapping[parts[0]] || parts[0];
                const sub = mapping[parts[1]] || parts[1];
                return `${main}: ${sub}`;
            }

            return mapping[cs] || cs;
        };

        const getFormattedWeek = (dateStr) => {
            const normalized = normalizeDate(dateStr);
            const date = new Date(normalized);
            if (isNaN(date.getTime())) return safeString(dateStr);
            const tempDate = new Date(date.getTime());
            tempDate.setHours(0, 0, 0, 0);
            tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
            const week1 = new Date(tempDate.getFullYear(), 0, 4);
            const weekNum = 1 + Math.round(((tempDate.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            const year = tempDate.getFullYear().toString().substring(2);
            const paddedWeek = weekNum.toString().padStart(2, '0');
            return `'${year}.W${paddedWeek}`;
        };

        // --- 3. Sub Components ---

        const DateSlider = ({ selectedDate, onDateChange, availableDates, hasArticlesMap, darkMode }) => {
            const scrollRef = useRef(null);
            const itemRefs = useRef({});
            const todayStr = new Date().toISOString().split('T')[0];

            useEffect(() => {
                const el = scrollRef.current;
                if (!el) return;
                const handleWheel = (e) => {
                    if (Math.abs(e.deltaY) > 0) {
                        e.preventDefault();
                        el.scrollLeft += (e.deltaY * 6);
                    }
                };
                el.addEventListener('wheel', handleWheel, { passive: false });
                return () => el.removeEventListener('wheel', handleWheel);
            }, []);

            useEffect(() => {
                const targetRefKey = (selectedDate === 'LastWeek' || selectedDate === 'LastMonth') ? todayStr : selectedDate;
                if (targetRefKey && itemRefs.current[targetRefKey]) {
                    setTimeout(() => {
                        itemRefs.current[targetRefKey].scrollIntoView({
                            behavior: 'smooth', block: 'nearest', inline: 'center'
                        });
                    }, 150);
                }
            }, [selectedDate, todayStr]);

            const jumpDate = (days) => {
                const current = (selectedDate === 'LastMonth' || selectedDate === 'LastWeek') ? new Date() : new Date(selectedDate);
                current.setDate(current.getDate() + days);
                const targetStr = current.toISOString().split('T')[0];
                onDateChange(targetStr);
            };

            return (
                <div className={`w-full border-b overflow-hidden relative shadow-sm h-36 flex items-center transition-colors ${darkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-200'}`}>
                    <div className={`flex items-center px-6 gap-3 z-30 shadow-[15px_0_15px_-5px_rgba(0,0,0,0.05)] border-r h-full transition-colors ${darkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-100'}`}>
                        <div className="flex flex-col gap-2 min-w-[130px]">
                            <button onClick={() => onDateChange('LastMonth')} className={`flex items-center justify-center gap-2 px-4 py-2 rounded-full font-black text-[9px] uppercase tracking-widest transition-all border ${selectedDate === 'LastMonth' ? 'bg-[#0033A0] text-white border-transparent shadow-lg' : (darkMode ? 'bg-slate-800 text-slate-400 border-slate-700' : 'bg-slate-50 text-slate-400 border-slate-100 hover:bg-slate-100')}`}><CalendarRange size={11} /> LAST MONTH</button>
                            <button onClick={() => onDateChange('LastWeek')} className={`flex items-center justify-center gap-2 px-4 py-2 rounded-full font-black text-[9px] uppercase tracking-widest transition-all border ${selectedDate === 'LastWeek' ? 'bg-[#0052CC] text-white border-transparent shadow-lg' : (darkMode ? 'bg-slate-800 text-slate-400 border-slate-700' : 'bg-slate-50 text-slate-400 border-slate-100 hover:bg-slate-100')}`}><CalendarRange size={11} /> LAST WEEK</button>
                            <button onClick={() => onDateChange(todayStr)} className={`flex items-center justify-center gap-2 px-4 py-2 rounded-full font-black text-[9px] uppercase tracking-widest transition-all border ${selectedDate === todayStr ? 'bg-[#0747A6] text-white border-transparent shadow-lg' : (darkMode ? 'bg-slate-800 text-slate-400 border-slate-700' : 'bg-white text-[#0747A6] border-[#0747A6]/20 hover:bg-blue-50')}`}><RotateCcw size={11} /> TODAY</button>
                        </div>
                        <div className={`w-[1px] h-16 mx-2 ${darkMode ? 'bg-slate-700' : 'bg-slate-100'}`}></div>
                        <div className="flex items-center gap-1">
                            <button onClick={() => jumpDate(-30)} className={`p-2 rounded-full transition-all ${darkMode ? 'text-slate-500 hover:text-white hover:bg-slate-800' : 'text-slate-300 hover:text-[#0747A6] hover:bg-slate-50'}`}><ChevronsLeft size={22} /></button>
                            <button onClick={() => jumpDate(-7)} className={`p-2 rounded-full transition-all ${darkMode ? 'text-slate-500 hover:text-white hover:bg-slate-800' : 'text-slate-300 hover:text-[#0747A6] hover:bg-slate-50'}`}><ChevronLeft size={22} /></button>
                        </div>
                    </div>
                    <div ref={scrollRef} className="flex items-center gap-6 px-[5%] py-8 overflow-x-auto no-scrollbar scroll-smooth snap-x flex-1 h-full" style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}>
                        {availableDates.map((date) => {
                            const d = new Date(date);
                            const isSelected = selectedDate === date;
                            return (
                                <button key={date} ref={el => itemRefs.current[date] = el} onClick={() => onDateChange(date)} className={`snap-center flex-shrink-0 transition-all duration-500 flex flex-col items-center min-w-[100px] py-3 rounded-2xl relative ${isSelected ? 'scale-125 opacity-100 bg-blue-500/10 ring-2 ring-blue-500/30 shadow-md' : 'scale-90 opacity-20 hover:opacity-50'} ${date === todayStr && !isSelected ? 'border border-blue-500/30 shadow-sm' : ''}`}>
                                    <span className={`text-[9px] font-black uppercase mb-1 ${isSelected ? (darkMode ? 'text-blue-400' : 'text-[#0747A6]') : 'text-slate-400'}`}>{d.toLocaleDateString('en-US', { month: 'short' })}</span>
                                    <span className={`text-2xl font-black tracking-tighter ${isSelected ? (darkMode ? 'text-white' : 'text-[#172B4D]') : 'text-slate-500'}`}>{d.getDate()}</span>
                                    <span className={`text-[8px] font-bold uppercase tracking-widest mt-1 ${isSelected ? (darkMode ? 'text-blue-400' : 'text-[#0747A6]') : 'text-slate-300'}`}>{d.toLocaleDateString('en-US', { weekday: 'short' })}</span>
                                    {hasArticlesMap[date] && <div className={`absolute top-2 right-4 w-1.5 h-1.5 rounded-full ${isSelected ? (darkMode ? 'bg-blue-400' : 'bg-[#0747A6]') : 'bg-blue-300 animate-pulse'}`} />}
                                </button>
                            );
                        })}
                    </div>
                    <div className={`flex items-center px-8 gap-1 z-30 shadow-[-15px_0_15px_-5px_rgba(0,0,0,0.05)] border-l h-full min-w-[120px] justify-center transition-colors ${darkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-100'}`}>
                        <button onClick={() => jumpDate(7)} className={`p-2 rounded-full transition-all ${darkMode ? 'text-slate-500 hover:text-white hover:bg-slate-800' : 'text-slate-300 hover:text-[#0747A6] hover:bg-slate-50'}`}><ChevronRight size={22} /></button>
                        <button onClick={() => jumpDate(30)} className={`p-2 rounded-full transition-all ${darkMode ? 'text-slate-500 hover:text-white hover:bg-slate-800' : 'text-slate-300 hover:text-[#0747A6] hover:bg-slate-50'}`}><ChevronsRight size={22} /></button>
                    </div>
                </div>
            );
        };

        const IndexModal = ({ isOpen, onClose, darkMode }) => {
            if (!isOpen) return null;
            return (
                <div onClick={onClose} className="fixed inset-0 bg-slate-950/60 backdrop-blur-md flex items-center justify-center p-4 z-[1000] animate-in fade-in duration-300">
                    <div onClick={e => e.stopPropagation()} className={`p-6 rounded-2xl shadow-2xl relative border ${darkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-100'}`}>
                        <button onClick={onClose} className={`absolute top-4 right-4 p-2 rounded-full transition-colors ${darkMode ? 'hover:bg-slate-800 text-slate-400' : 'hover:bg-slate-100 text-slate-500'}`}>
                            <X size={24} />
                        </button>
                        <div className="w-full flex justify-center items-center mt-4">
                            <iframe src="TradingView Widget.html" style={{ width: '580px', height: '430px', border: 'none', overflow: 'hidden' }} scrolling="no"></iframe>
                        </div>
                    </div>
                </div>
            );
        };

        const Pagination = ({ totalItems, itemsPerPage, currentPage, onPageChange, darkMode, lang }) => {
            // Updated symmetry
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 1) return null;


            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            const pages = [];
            for (let i = startPage; i <= endPage; i++) pages.push(i);

            return (
                <div className="pagination-container">
                    <button
                        className="pagination-btn nav-text"
                        disabled={currentPage === 1}
                        onClick={() => { onPageChange(1); window.scrollTo({ top: 0, behavior: 'smooth' }); }}
                    >
                        {lang === 'KO' ? 'ì²˜ìŒ' : 'First'}
                    </button>
                    <button
                        className="pagination-btn"
                        disabled={currentPage === 1}
                        onClick={() => { onPageChange(currentPage - 1); window.scrollTo({ top: 0, behavior: 'smooth' }); }}
                    >
                        <ChevronLeft size={16} />
                    </button>

                    {pages.map(p => (
                        <button
                            key={p}
                            className={`pagination-btn ${p === currentPage ? 'active' : ''}`}
                            onClick={() => { onPageChange(p); window.scrollTo({ top: 0, behavior: 'smooth' }); }}
                        >
                            {p}
                        </button>
                    ))}

                    <button
                        className="pagination-btn"
                        disabled={currentPage === totalPages}
                        onClick={() => { onPageChange(currentPage + 1); window.scrollTo({ top: 0, behavior: 'smooth' }); }}
                    >
                        <ChevronRight size={16} />
                    </button>
                    <button
                        className="pagination-btn nav-text"
                        disabled={currentPage === totalPages}
                        onClick={() => { onPageChange(totalPages); window.scrollTo({ top: 0, behavior: 'smooth' }); }}
                    >
                        {lang === 'KO' ? 'ë§ˆì§€ë§‰' : 'Last'}
                    </button>

                </div>
            );
        };

        // --- 4. Main Application ---

        const App = () => {
            const [rawData, setRawData] = useState([]);
            const [intelData, setIntelData] = useState(null);
            const [selectedFilter, setSelectedFilter] = useState('All');
            const [selectedRisk, setSelectedRisk] = useState('All');
            const [selectedTag, setSelectedTag] = useState(null);
            const [selectedDate, setSelectedDate] = useState('LastWeek');
            const [timeRange, setTimeRange] = useState('Weekly');
            const [loading, setLoading] = useState(true);
            const [darkMode, setDarkMode] = useState(false);
            const [language, setLanguage] = useState('KO');
            const [searchTarget, setSearchTarget] = useState('Both');
            const [selectedRegion, setSelectedRegion] = useState('All');
            const [searchKeyword, setSearchKeyword] = useState('');
            const [latestDateStr, setLatestDateStr] = useState(new Date().toISOString().split('T')[0]);
            const [currPage, setCurrPage] = useState(1);
            const itemsPerPage = 10;
            const [monthlyStats, setMonthlyStats] = useState([]);

            const [showReport, setShowReport] = useState(false);
            const [showIndex, setShowIndex] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const mapRef = useRef(null);

            useEffect(() => {
                const user = JSON.parse(localStorage.getItem('da_user'));
                if (user) setCurrentUser(user);
            }, []);

            useEffect(() => {
                const fetchData = async () => {
                    setLoading(true);

                    // [ìµœì í™”] 1. ìºì‹œ ë°ì´í„°(sessionStorage) í™•ì¸
                    let cachedData = null;
                    let cachedIntel = null;
                    let cachedMonthly = null;
                    try {
                        cachedData = sessionStorage.getItem('cachedNewsData');
                        cachedIntel = sessionStorage.getItem('cachedIntel');
                        cachedMonthly = sessionStorage.getItem('cachedMonthlyStats');
                    } catch (e) {
                        console.warn("Cache access failed", e);
                    }

                    // [ìµœì í™”] 2. ìºì‹œê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ë¡œë“œ (Plan A)
                    let mainDataReady = false;
                    if (cachedData) {
                        try {
                            const json = JSON.parse(cachedData);
                            processData(json);
                            mainDataReady = true;
                            console.log("Loaded main data from cache");
                        } catch (e) {
                            console.error("Cache parse error", e);
                        }
                    }

                    if (cachedIntel) {
                        try {
                            setIntelData(JSON.parse(cachedIntel));
                            console.log("Loaded intel data from cache");
                        } catch (e) { console.error("Intel cache parse error", e); }
                    }

                    if (cachedMonthly) {
                        try {
                            setMonthlyStats(JSON.parse(cachedMonthly));
                            console.log("Loaded monthly stats from cache");
                        } catch (e) { console.error("Monthly cache parse error", e); }
                    }

                    // 3. ë©”ì¸ ë°ì´í„° í˜ì¹­ (Plan B: ìºì‹œê°€ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš°)
                    if (!mainDataReady) {
                        const sources = [
                            { name: 'Google Sheets (Real-time)', url: GAS_URL },
                            { name: 'GitHub JSON (Static)', url: RAW_DATA_URL }
                        ];

                        for (const source of sources) {
                            try {
                                const response = await fetch(source.url);
                                if (response.ok) {
                                    const json = await response.json();
                                    processData(json);
                                    // ë„¤íŠ¸ì›Œí¬ë¡œ ìƒˆë¡œ ë°›ì•˜ìœ¼ë©´ ìºì‹œ ì—…ë°ì´íŠ¸
                                    sessionStorage.setItem('cachedNewsData', JSON.stringify(json));
                                    mainDataReady = true;
                                    break;
                                }
                            } catch (e) {
                                console.warn(`Failed to fetch main data from ${source.name}`, e);
                            }
                        }
                    }

                    // 4. ì¶”ê°€ ë°ì´í„° í˜ì¹­ (Intel, Monthly ë“± ìºì‹œê°€ ì—†ìœ¼ë©´ ì§„í–‰)
                    if (!cachedIntel && mainDataReady) {
                        try {
                            const intelRes = await fetch(INTEL_URL);
                            if (intelRes.ok) {
                                const intelJson = await intelRes.json();
                                setIntelData(intelJson);
                                sessionStorage.setItem('cachedIntel', JSON.stringify(intelJson));
                            }
                        } catch (e) { console.warn("Failed to fetch intel_report", e); }
                    }

                    // ì›”ê°„ í†µê³„ (í•­ìƒ ìµœì‹ í™”ë¥¼ ì›í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ìºì‹œê°€ ìˆì–´ë„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ í•œ ë²ˆ ë” ì—…ë°ì´íŠ¸ ê°€ëŠ¥)
                    // ì—¬ê¸°ì„œëŠ” ì†ë„ë¥¼ ìœ„í•´ ìºì‹œê°€ ì—†ì„ ë•Œë§Œ fetch í•˜ê±°ë‚˜, ë¹„ê³µê²©ì ìœ¼ë¡œ fetch
                    try {
                        const mResponse = await fetch(`${GAS_URL}?type=monthly`);
                        if (mResponse.ok) {
                            const mJson = await mResponse.json();
                            setMonthlyStats(mJson);
                            sessionStorage.setItem('cachedMonthlyStats', JSON.stringify(mJson));
                        }
                    } catch (e) { console.warn("Failed to fetch monthly stats", e); }

                    setLoading(false);
                };

                const processData = (json) => {
                    try {
                        const formatted = json.map((item, index) => {
                            const ko_title = safeString(item.B || item.Title || item.title || 'ì œëª© ì—†ìŒ');
                            const en_title = safeString(item.M || item.Title_en || item.title_en || ko_title || 'No Title');

                            const ko_category = normalizeCategory(item.C || item.Category || item.category);
                            const en_category = safeString(item.O || item.Category_en || item.category_en || 'MISC');

                            const ko_raw = item.D || item.Summary || item.summary || item.Content || item.content || item['ê¸°ì‚¬ë‚´ìš©'];
                            const en_raw = item.N || item.Summary_en || item.summary_en || item.n;

                            const ko_content = safeString(ko_raw || 'ìƒì„¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.').replace(/<[^>]*>?/gm, '').replace(/\s+/g, ' ').trim();
                            const en_content = safeString(en_raw || ko_raw || 'No Content Available.').replace(/<[^>]*>?/gm, '').replace(/\s+/g, ' ').trim();

                            const ko_tags = safeString(item.J || item.Tag || item.tag || "").split(',').map(t => t.trim()).filter(Boolean);
                            // Pì—´(Tag_en) í•„ë“œ ì¸ì‹ì„ ë” ê°•í™” (ëŒ€ì†Œë¬¸ì ë¬´ê´€í•˜ê²Œ íƒìƒ‰ ì‹œë„ ê°€ëŠ¥í•˜ë‚˜ ì¼ë‹¨ í‚¤ì›Œë“œ ì¶”ê°€)
                            const en_tags_found = item.P || item.Tag_en || item.tag_en || item.TAG_EN || item.TagEn || "";
                            const en_tags_raw = safeString(en_tags_found).split(',').map(t => t.trim()).filter(Boolean);
                            const en_tags = en_tags_raw.length > 0 ? en_tags_raw : ko_tags;

                            const ko_region = safeString(item.I || item.Region || 'Global').trim();
                            const en_region = safeString(item.Q || item.Region_en || item.region_en || 'Global').trim();

                            const ko_bot = safeString(item.BOT || item.Bot || item.bot).trim();
                            const en_bot = safeString(item["BOT(eng)"] || item.BOT_en || item.bot_en || item.M || ko_bot).trim();

                            return {
                                _uId: `news-${index}`,
                                date: normalizeDate(item.A || item.Date || item.date || '2026-02-01'),
                                risk: safeString(item.G || item.Risk || item.risk || 'Low'),
                                viewCount: Number(item.ViewCount || item.viewCount || 0),
                                ko: { title: ko_title, category: ko_category, content: ko_content, tags: ko_tags, region: ko_region, bot: ko_bot },
                                en: { title: en_title, category: en_category, content: en_content, tags: en_tags, region: en_region, bot: en_bot }
                            };
                        }).filter(item => item.date !== "");

                        setRawData(formatted);
                        const dates = formatted.map(d => d.date).sort((a, b) => b.localeCompare(a));
                        if (dates.length > 0) setLatestDateStr(dates[0]);
                        setSelectedDate('LastWeek');
                    } catch (err) {
                        console.error("Data Process Error:", err);
                    }
                };

                fetchData();
            }, []);

            const availableDates = useMemo(() => {
                const dates = [];
                const base = new Date(latestDateStr);
                const start = new Date(base);
                start.setDate(base.getDate() - 90);
                for (let i = 0; i <= 120; i++) {
                    const d = new Date(start); d.setDate(start.getDate() + i);
                    dates.push(d.toISOString().split('T')[0]);
                }
                return dates;
            }, [latestDateStr]);

            const hasArticlesMap = useMemo(() => {
                const map = {}; rawData.forEach(d => { map[d.date] = true; });
                return map;
            }, [rawData]);

            const currentLocaleData = useMemo(() => {
                return rawData.map(d => ({
                    ...d,
                    ...d[language.toLowerCase()]
                }));
            }, [rawData, language]);

            const filteredData = useMemo(() => {
                let data = currentLocaleData;
                if (selectedFilter !== 'All') data = data.filter(d => d.ko.category === selectedFilter);
                if (selectedRisk !== 'All') data = data.filter(d => d.risk === selectedRisk);
                if (selectedRegion !== 'All') data = data.filter(d => d.region === selectedRegion);
                if (selectedTag) data = data.filter(d => d.tags.includes(selectedTag));

                const baseDate = new Date(latestDateStr);

                if (selectedDate === 'LastWeek') {
                    const lastWeek = new Date(baseDate); lastWeek.setDate(baseDate.getDate() - 7);
                    data = data.filter(d => { const itemDate = new Date(d.date); return itemDate >= lastWeek && itemDate <= baseDate; });
                } else if (selectedDate === 'LastMonth') {
                    const lastMonth = new Date(baseDate); lastMonth.setDate(baseDate.getDate() - 30);
                    data = data.filter(d => { const itemDate = new Date(d.date); return itemDate >= lastMonth && itemDate <= baseDate; });
                } else if (selectedDate !== 'All') {
                    data = data.filter(d => d.date === selectedDate);
                }

                if (searchKeyword.trim()) {
                    const kw = searchKeyword.toLowerCase();
                    data = data.filter(d => {
                        const titleMatch = safeString(d.title).toLowerCase().includes(kw);
                        const contentMatch = safeString(d.content).toLowerCase().includes(kw);
                        if (searchTarget === 'Both') return titleMatch || contentMatch;
                        if (searchTarget === 'Title') return titleMatch;
                        if (searchTarget === 'Content') return contentMatch;
                        return true;
                    });
                }
                return data;
            }, [currentLocaleData, selectedFilter, selectedRisk, selectedTag, selectedDate, searchKeyword, searchTarget, latestDateStr]);

            // [ì¶”ê°€] í•„í„° ë³€ê²½ ì‹œ í˜ì´ì§€ ì´ˆê¸°í™”
            useEffect(() => {
                setCurrPage(1);
            }, [selectedFilter, selectedRisk, selectedTag, selectedDate, searchKeyword, selectedRegion]);

            const cardStats = useMemo(() => {

                if (!filteredData.length) return { count: 0, topRegion: '-', topCat: '-', critical: { level: 'None', title: '-', content: '-' } };
                const regions = {}; filteredData.forEach(d => { regions[d.region] = (regions[d.region] || 0) + 1; });
                const sortedRegions = Object.entries(regions).filter(([name]) => name !== 'Global').sort((a, b) => b[1] - a[1]);
                const riskPriority = { 'High': 3, 'Med': 2, 'Low': 1 };
                const topRiskItem = [...filteredData].sort((a, b) => (riskPriority[b.risk] || 0) - (riskPriority[a.risk] || 0))[0];
                return {
                    count: filteredData.length,
                    topRegion: sortedRegions.length > 0 ? safeString(sortedRegions[0][0]) : 'Global',
                    topCat: selectedFilter === 'All' ? (language === 'KO' ? 'í†µí•© ë¶„ì„' : 'Unified') : translateCategory(selectedFilter, language),
                    critical: { level: safeString(topRiskItem.risk), title: safeString(topRiskItem.title), content: safeString(topRiskItem.content) }
                };
            }, [filteredData, selectedFilter, language]);

            const strategicNarrative = useMemo(() => {
                if (intelData) {
                    // 1. ê¸°ê°„ í‚¤ ë³€í™˜ (Dashboard í‚¤ â†’ intel_report.json í‚¤)
                    const todayStr = new Date().toISOString().split('T')[0];
                    let periodKey = 'thisWeek'; // default
                    if (selectedDate === 'LastWeek') periodKey = 'lastWeek';
                    else if (selectedDate === 'LastMonth') periodKey = 'lastMonth';
                    else if (selectedDate === todayStr) periodKey = 'thisWeek';
                    // ê·¸ ì™¸ íŠ¹ì • ë‚ ì§œì˜ ê²½ìš° ìµœì‹ (thisWeek) ë¸Œë¦¬í•‘ ì¶œë ¥

                    // 2. ì¹´í…Œê³ ë¦¬ í‚¤ ë³€í™˜
                    const catKeyMap = {
                        'ì›ìì¬': 'ì›ìì¬',
                        'ê±°ì‹œ/ì •ì±…': 'ê±°ì‹œê²½ì œ',
                        'ì§€ì—­ë³„ ë¶„ì„': 'ìƒì‚°ì§€ì—­',
                        'ê²½ìŸì‚¬': 'ê²½ìŸì‚¬',
                        'ì‹ ê¸°ìˆ ë™í–¥': 'ì‹ ê¸°ìˆ ë™í–¥',
                        'AIê¸°ìˆ ': 'ì‹ ê¸°ìˆ ë™í–¥',
                    };
                    const catKey = catKeyMap[selectedFilter] || 'all';

                    // 3. ì‹ ê·œ êµ¬ì¡°(scripts[period][cat]) ìš°ì„  íƒìƒ‰
                    if (intelData.scripts && intelData.scripts[periodKey]) {
                        const targetScript = intelData.scripts[periodKey][catKey] || intelData.scripts[periodKey]['all'];
                        if (targetScript) return targetScript;
                    }

                    // 4. êµ¬ë²„ì „/í•˜ìœ„ í˜¸í™˜ fallback
                    if (intelData.categoryScripts) {
                        const legacyCat = catKey === 'all' ? 'all' : catKey;
                        if (intelData.categoryScripts[legacyCat]) return intelData.categoryScripts[legacyCat];
                    }
                    if (intelData.dailyBriefing && intelData.dailyBriefing.script) return intelData.dailyBriefing.script;
                }

                // ë°ì´í„° ì—†ì„ ë•Œ ìë™ ìƒì„± fallback
                if (!filteredData.length) return language === 'KO' ? `í˜„ì¬ ì„ íƒëœ ì¡°ê±´ì— ë¶€í•©í•˜ëŠ” ë¦¬ìŠ¤í¬ ë°ì´í„°ê°€ ë¶€ì¬í•©ë‹ˆë‹¤.` : `No risk data found for the selected context.`;
                let dateLabel = selectedDate === 'LastMonth' ? (language === 'KO' ? 'ìµœê·¼ 30ì¼' : 'Last 30 Days') : (selectedDate === 'LastWeek' ? (language === 'KO' ? 'ìµœê·¼ 7ì¼' : 'Last 7 Days') : (selectedDate === 'All' ? (language === 'KO' ? 'ì „ì²´ ê¸°ê°„' : 'All Period') : selectedDate));
                const catLabel = selectedFilter === 'All' ? (language === 'KO' ? 'ê³µê¸‰ë§ í†µí•©' : 'Supply Chain') : translateCategory(selectedFilter, language);
                return language === 'KO' ? `${dateLabel} ê¸°ì¤€, ${catLabel} ì„¹í„° ë¶„ì„ ê²°ê³¼ ${cardStats.topRegion} ì§€ì—­ ì´ìŠˆê°€ ê°€ì¥ ë‘ë“œëŸ¬ì§‘ë‹ˆë‹¤. ${filteredData.filter(d => d.risk === 'High').length > 0 ? 'íŠ¹íˆ High ë¦¬ìŠ¤í¬ì— ëŒ€í•œ ì„ ì œì  ëŒ€ì‘ì´ ê¶Œê³ ë©ë‹ˆë‹¤.' : ''}` : `Based on ${dateLabel}, the ${catLabel} analysis highlights key issues in ${cardStats.topRegion}. ${filteredData.filter(d => d.risk === 'High').length > 0 ? 'Urgent attention is advised for High Risk cases.' : 'Risk levels are currently stable.'}`;
            }, [intelData, selectedFilter, selectedDate, filteredData.length, language, cardStats.topRegion]);


            const timelineStats = useMemo(() => {
                if (!currentLocaleData.length) return [];
                const groupedMap = {}; const chartCats = ['ì›ìì¬', 'ê±°ì‹œ/ì •ì±…', 'ì§€ì—­ë³„ ë¶„ì„', 'ê²½ìŸì‚¬', 'ì‹ ê¸°ìˆ ë™í–¥'];
                const trendBaseData = currentLocaleData.filter(d => {
                    let match = true;
                    if (selectedFilter !== 'All') match = match && d.ko.category === selectedFilter;
                    if (selectedRisk !== 'All') match = match && d.risk === selectedRisk;
                    if (selectedTag) match = match && d.tags.includes(selectedTag);
                    return match;
                });
                trendBaseData.forEach(item => {
                    const d = new Date(item.date); if (isNaN(d.getTime())) return;
                    let key = timeRange === 'Weekly' ? getFormattedWeek(item.date) : (timeRange === 'Monthly' ? `${d.getFullYear()}.${(d.getMonth() + 1).toString().padStart(2, '0')}` : item.date);
                    if (!groupedMap[key]) { groupedMap[key] = { date: key, count: 0 }; chartCats.forEach(c => groupedMap[key][c] = 0); }
                    groupedMap[key].count++; if (chartCats.includes(item.ko.category)) groupedMap[key][item.ko.category]++;
                });
                return Object.values(groupedMap).sort((a, b) => a.date.localeCompare(b.date));
            }, [currentLocaleData, timeRange, selectedFilter, selectedRisk, selectedTag]);

            const dynamicTags = useMemo(() => {
                if (!filteredData.length) return [];
                const tagCounts = {}; filteredData.forEach(item => { item.tags.forEach(t => { tagCounts[t] = (tagCounts[t] || 0) + 1; }); });
                return Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 15).map(([text, count]) => ({
                    text: safeString(text),
                    count,
                    translated: translateCategory(text, language)
                }));
            }, [filteredData, language]);

            const riskProfileData = useMemo(() => {
                const cats = language === 'KO' ? ['ì›ìì¬', 'ê±°ì‹œ/ì •ì±…', 'ì§€ì—­ë³„ ë¶„ì„', 'ê²½ìŸì‚¬', 'ì‹ ê¸°ìˆ ë™í–¥'] : ['Material', 'Macro', 'Region', 'Competitors', 'New Tech'];
                const mapping = { 'Material': 'ì›ìì¬', 'Macro': 'ê±°ì‹œ/ì •ì±…', 'Region': 'ì§€ì—­ë³„ ë¶„ì„', 'Competitors': 'ê²½ìŸì‚¬', 'New Tech': 'ì‹ ê¸°ìˆ ë™í–¥' };
                return cats.map(cat => {
                    const targetCat = language === 'KO' ? cat : mapping[cat];
                    const catData = filteredData.filter(d => d.ko.category === targetCat);
                    return { name: cat, High: catData.filter(d => d.risk === 'High').length, Med: catData.filter(d => d.risk === 'Med').length, Low: catData.filter(d => d.risk === 'Low').length };
                });
            }, [filteredData, language]);

            // [ì¶”ê°€] ì¸ê¸° ì¹´í…Œê³ ë¦¬ (ì¡°íšŒìˆ˜ ê¸°ì¤€)
            const popularCategoryData = useMemo(() => {
                const catViews = {};
                filteredData.forEach(d => {
                    const cat = translateCategory(d.ko.category, language);
                    catViews[cat] = (catViews[cat] || 0) + d.viewCount;
                });
                return Object.entries(catViews)
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value);
            }, [filteredData, language]);

            // [ì¶”ê°€] ìµœë‹¤ ì¡°íšŒ ê¸°ì‚¬
            const topArticles = useMemo(() => {
                return [...filteredData]
                    .sort((a, b) => b.viewCount - a.viewCount)
                    .slice(0, 5);
            }, [filteredData]);

            const handleLink = (id) => window.location.href = `index.html?targetId=${id}`;
            const goToIndex = () => window.location.href = 'index.html?view=hub';
            const logOut = () => {
                localStorage.removeItem("da_user");
                window.location.href = "index.html";
            };
            const resetFilters = () => { setSelectedFilter('All'); setSelectedRisk('All'); setSelectedRegion('All'); setSelectedTag(null); setSelectedDate('LastWeek'); setSearchKeyword(''); };

            // ì§€ë„ì™€ì˜ í†µì‹  ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
            useEffect(() => {
                const handleMessage = (e) => {
                    if (e.data.type === 'filterByCountry') {
                        setSelectedRegion(e.data.country);
                    }
                };
                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, []);

            useEffect(() => {
                if (mapRef.current && mapRef.current.contentWindow) {
                    const countryMap = {};
                    filteredData.forEach(d => {
                        if (d.region && d.region !== 'Global') {
                            countryMap[d.region] = (countryMap[d.region] || 0) + 1;
                        }
                    });
                    mapRef.current.contentWindow.postMessage({ type: 'updateData', data: countryMap }, '*');
                }
            }, [filteredData]);

            // [ì¶”ê°€] ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ëœë¤ ìˆœì°¨ ì¬ìƒ ë¡œì§
            const LOTTIE_URLS = [
                "https://lottie.host/43ada85a-c45a-4cc5-8b01-e0c76650dba8/79RRpsjJH0.lottie",
                "https://lottie.host/063867c2-3f3d-4ede-8e0f-51c5e352d85b/t8c7HUbPGE.lottie",
                "https://lottie.host/c10868aa-6ca2-468e-bd01-1cc1c6c0e21d/MI35VKUbQa.lottie"
            ];
            // 1. ì§„ì… ì‹œ ìˆœì„œë¥¼ ë¬´ì‘ìœ„ë¡œ í•œ ë²ˆ ì„ìŒ
            const [shuffledUrls] = useState(() => [...LOTTIE_URLS].sort(() => Math.random() - 0.5));
            // 2. í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ì¸ë±ìŠ¤ ê´€ë¦¬
            const [aniIndex, setAniIndex] = useState(0);
            const lottieRef = useRef(null);

            useEffect(() => {
                const el = lottieRef.current;
                if (el) {
                    const handleComplete = () => {
                        // ë‹¤ìŒ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì´ë™ (ìˆœí™˜)
                        setAniIndex((prev) => (prev + 1) % shuffledUrls.length);
                    };
                    el.addEventListener('complete', handleComplete);
                    return () => el.removeEventListener('complete', handleComplete);
                }
            }, [aniIndex, shuffledUrls]);

            if (loading) return (
                <div className="flex h-screen items-center justify-center bg-white font-sans overflow-hidden">
                    <div className="flex flex-col items-center justify-center">
                        <dotlottie-wc
                            ref={lottieRef}
                            src={shuffledUrls[aniIndex]}
                            style={{ width: '600px', height: '600px' }}
                            autoplay
                        ></dotlottie-wc>
                        <p className="text-[12px] font-black text-[#0033A0] uppercase tracking-[0.5em] -mt-10 z-10">
                            Calibrating Decision Core
                        </p>
                    </div>
                </div>
            );

            const menuLabels = {
                KO: ['ì „ëµ ì‹œí™©', 'ì›ìì¬', 'ê±°ì‹œ/ì •ì±…', 'ì§€ì—­ë³„ ë¶„ì„', 'ê²½ìŸì‚¬', 'ì‹ ê¸°ìˆ ë™í–¥', 'INDEX'],
                EN: ['Strategy', 'Material', 'Macro', 'Region', 'Competitors', 'New Tech', 'Index']
            };

            const searchLabels = {
                KO: { placeholder: 'ë‰´ìŠ¤ í‚¤ì›Œë“œ ê²€ìƒ‰...', options: ['ì œëª©+ë³¸ë¬¸', 'ì œëª©', 'ë³¸ë¬¸'] },
                EN: { placeholder: 'Search keywords...', options: ['Title+Content', 'Title', 'Content'] }
            };

            return (
                <div className={`min-h-screen transition-colors duration-500 font-sans antialiased pb-24 ${darkMode ? 'bg-slate-950 text-slate-200' : 'bg-[#F8F9FB] text-[#172B4D]'}`}>
                    <header className="bg-[#0033A0] text-white sticky top-0 z-50 px-4 h-14 flex items-center justify-between shadow-xl">
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-white text-[#0033A0] px-1.5 py-0.5 rounded-sm text-[10px] font-black uppercase">DA</div>
                                <h1 className="font-bold text-[13px] tracking-tight uppercase">PURCHASE INTELLIGENCE</h1>
                            </div>
                            <nav className="flex items-center gap-3 lg:gap-4 text-[11px] font-bold">
                                {menuLabels[language].map((m, idx) => {
                                    const catKey = menuLabels['KO'][idx];
                                    if (m.toUpperCase() === 'INDEX') {
                                        return (
                                            <button key={m} onClick={() => setShowIndex(true)} className="text-white/60 border-b-2 border-transparent hover:text-white py-1 transition-all uppercase">{m}</button>
                                        );
                                    }
                                    const isSelected = (m === 'ì „ëµ ì‹œí™©' || m === 'Strategy') ? selectedFilter === 'All' : selectedFilter === catKey;
                                    return (
                                        <button key={m} onClick={() => { setSelectedFilter(m === 'ì „ëµ ì‹œí™©' || m === 'Strategy' ? 'All' : catKey); setSelectedTag(null); }} className={`transition-all py-1 border-b-2 uppercase ${isSelected ? 'text-white border-white' : 'text-white/60 border-transparent hover:text-white'}`}>{m}</button>
                                    );
                                })}
                            </nav>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="flex items-center bg-white rounded-full p-0.5 shadow-lg overflow-hidden border border-blue-200/50">
                                <div className="relative">
                                    <select value={searchTarget} onChange={(e) => setSearchTarget(e.target.value)} className="bg-transparent text-[#172B4D] text-[10px] font-black py-1 pl-4 pr-8 border-none focus:ring-0 appearance-none cursor-pointer">
                                        <option value="Both">{searchLabels[language].options[0]}</option>
                                        <option value="Title">{searchLabels[language].options[1]}</option>
                                        <option value="Content">{searchLabels[language].options[2]}</option>
                                    </select>
                                    <ChevronDown size={12} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" />
                                </div>
                                <div className="w-[1px] h-4 bg-slate-200"></div>
                                <div className="flex items-center flex-1 px-3">
                                    <Search size={14} className="text-slate-400 mr-2" />
                                    <input type="text" value={searchKeyword} onChange={(e) => setSearchKeyword(e.target.value)} placeholder={searchLabels[language].placeholder} className="bg-transparent border-none text-[11px] text-[#172B4D] font-bold focus:ring-0 w-36 placeholder:text-slate-300 uppercase tracking-tighter" />
                                </div>
                            </div>
                            <button onClick={goToIndex} className="flex items-center gap-2 bg-blue-500 hover:bg-blue-400 px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all shadow-md text-white"><List size={14} /> NEWS HUB</button>

                            {/* User info & Logout aligned with index.html */}
                            <div className="flex items-center gap-3 ml-2 border-l border-white/20 pl-4 h-8">
                                <div className="flex flex-col leading-tight">
                                    <span className="text-[10px] font-black opacity-80">{currentUser ? currentUser.userName : 'Guest'}</span>
                                    <span className="text-[9px] font-bold opacity-60">ë‹˜</span>
                                </div>
                                <button
                                    onClick={logOut}
                                    className="text-[10px] font-black text-red-400 hover:text-red-500 uppercase tracking-widest transition-all"
                                >
                                    LOGOUT
                                </button>
                            </div>

                            <button onClick={() => setLanguage(l => l === 'KO' ? 'EN' : 'KO')} className="bg-white/10 hover:bg-white/20 px-2.5 py-1 rounded-sm text-[10px] font-black border border-white/20 uppercase tracking-widest">{language}</button>
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2 hover:bg-white/10 rounded-full transition-all text-white/80 hover:text-white">{darkMode ? <Sun size={18} /> : <Moon size={18} />}</button>
                        </div>
                    </header>

                    <DateSlider selectedDate={selectedDate} onDateChange={setSelectedDate} availableDates={availableDates} hasArticlesMap={hasArticlesMap} darkMode={darkMode} lang={language} />

                    <main className="max-w-[1600px] mx-auto p-8 space-y-8 animate-in fade-in duration-700">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className={`p-6 rounded-sm border transition-all hover:border-[#0033A0] group shadow-sm ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 group-hover:text-[#0033A0]">{language === 'KO' ? 'ê¸°ì‚¬ ë¶„ì„ ìˆ˜' : 'Article Intensity'}</p>
                                <h3 className={`text-4xl font-black tracking-tighter ${darkMode ? 'text-blue-400' : 'text-[#0033A0]'}`}>{filteredData.length} <span className="text-[10px] font-normal text-slate-400 uppercase ml-1">Cases</span></h3>
                            </div>
                            <div className={`p-6 rounded-sm border transition-all hover:border-[#0033A0] shadow-sm ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{language === 'KO' ? 'ì§‘ì¤‘ ì§€ì—­' : 'Impact Hotspot'}</p>
                                <h3 className={`text-3xl font-black tracking-tighter flex items-center gap-3 uppercase ${darkMode ? 'text-slate-200' : 'text-slate-800'}`}><MapPin size={24} className={darkMode ? 'text-blue-400' : 'text-[#0033A0]'} /> {cardStats.topRegion}</h3>
                            </div>
                            <div onClick={() => setSelectedRisk(prev => prev === 'High' ? 'All' : 'High')} className={`p-6 rounded-sm border shadow-sm cursor-pointer transition-all hover:shadow-md ${selectedRisk === 'High' ? 'border-red-500 ring-2 ring-red-500/20' : (darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200')}`}>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{language === 'KO' ? 'ìµœëŒ€ ë¦¬ìŠ¤í¬' : 'Max Risk Depth'}</p>
                                <div className="flex items-center gap-3"><div className={`w-3.5 h-3.5 rounded-full ${selectedRisk === 'High' ? 'bg-red-500 animate-pulse' : (darkMode ? 'bg-blue-400' : 'bg-[#0033A0]')}`}></div><h3 className={`text-3xl font-black tracking-tighter uppercase ${darkMode ? 'text-slate-200' : 'text-slate-800'}`}>{selectedRisk}</h3></div>
                            </div>
                        </div>

                        <div className={`border-l-4 p-6 rounded-sm shadow-sm flex flex-col md:flex-row items-start md:items-center justify-between gap-6 hover:shadow-md transition-shadow ${darkMode ? 'bg-slate-900 border-blue-500' : 'bg-white border-[#0033A0]'}`}>
                            <div className="flex items-center gap-6 flex-1">
                                <div className={`p-3 rounded-full shadow-sm ${darkMode ? 'bg-slate-800 text-blue-400' : 'bg-blue-50 text-[#0033A0]'}`}><Sparkles size={24} /></div>
                                <div><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{language === 'KO' ? 'ì „ëµì  ë§¥ë½ ë¶„ì„' : 'Strategic Context Analysis'}</p><h2 className={`text-[15px] font-bold leading-relaxed ${darkMode ? 'text-slate-200' : 'text-slate-800'}`} dangerouslySetInnerHTML={{ __html: strategicNarrative.replace(/\n/g, '<br/>') }} /></div>
                            </div>
                            {(selectedFilter !== 'All' || selectedRisk !== 'All' || selectedTag || (selectedDate !== 'LastWeek' && selectedDate !== 'LastMonth') || searchKeyword) && (
                                <button onClick={resetFilters} className={`flex items-center gap-2 text-[10px] font-black border px-5 py-2.5 rounded-sm transition-all uppercase whitespace-nowrap shadow-sm ${darkMode ? 'bg-slate-800 border-slate-700 text-blue-400 hover:bg-slate-700' : 'text-[#0033A0] border-[#0033A0] hover:bg-blue-50'}`}><Clock size={12} /> {language === 'KO' ? 'í•„í„° í•´ì œ' : 'Reset Filter'}</button>
                            )}
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div className={`lg:col-span-4 rounded-sm border shadow-sm p-6 ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-[10px] font-black uppercase tracking-widest flex items-center gap-2 text-slate-400"><TrendingUp size={16} className={darkMode ? 'text-blue-400' : 'text-[#0033A0]'} /> {language === 'KO' ? 'ì¶”ì„¸' : 'Trend'}</h2>
                                    <div className="flex bg-slate-100 p-0.5 rounded-sm dark:bg-slate-800">
                                        {['Weekly', 'Monthly'].map(v => (<button key={v} onClick={() => setTimeRange(v)} className={`px-3 py-1 text-[8px] font-black rounded-sm transition-all ${timeRange === v ? (darkMode ? 'bg-blue-600 text-white' : 'bg-white text-[#0033A0] shadow-sm') : 'text-slate-400'}`}>{v}</button>))}
                                    </div>
                                </div>
                                <div className="h-[220px]">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={timelineStats}>
                                            <defs><linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={darkMode ? "#3B82F6" : "#0033A0"} stopOpacity={0.15} /><stop offset="95%" stopColor={darkMode ? "#3B82F6" : "#0033A0"} stopOpacity={0} /></linearGradient></defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={darkMode ? "#334155" : "#EDF2F7"} />
                                            <XAxis dataKey="date" axisLine={false} tickLine={false} tick={{ fontSize: 8, fill: '#8993A4', fontWeight: 700 }} />
                                            <YAxis axisLine={false} tickLine={false} tick={{ fontSize: 8, fill: '#8993A4', fontWeight: 700 }} />
                                            <RechartsTooltip contentStyle={darkMode ? { backgroundColor: '#1E293B', border: '1px solid #334155', color: '#fff' } : {}} />
                                            <Area type="monotone" dataKey="count" stroke={darkMode ? "#60A5FA" : "#0033A0"} strokeWidth={2} fillOpacity={1} fill="url(#chartGrad)" />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                            <div className={`lg:col-span-4 rounded-sm border shadow-sm p-6 flex flex-col justify-between ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-[10px] font-black uppercase tracking-widest flex items-center gap-2 text-slate-400"><Globe size={16} className={darkMode ? 'text-blue-400' : 'text-[#0033A0]'} /> {language === 'KO' ? 'ì§€ë„' : 'Mapping'}</h2>
                                    {selectedRegion !== 'All' && (
                                        <button onClick={() => setSelectedRegion('All')} className="text-[8px] font-black bg-blue-600 text-white px-2 py-0.5 rounded-sm uppercase tracking-tighter">RESET MAP</button>
                                    )}
                                </div>
                                <div className={`relative aspect-video rounded-sm overflow-hidden flex items-center justify-center shadow-inner ${darkMode ? 'bg-slate-800' : 'bg-slate-50'}`}>
                                    <iframe
                                        ref={mapRef}
                                        src="InteractiveMap.html"
                                        className="w-full h-full border-none"
                                        title="Interactive Map"
                                    />
                                </div>
                            </div>
                            <div className={`lg:col-span-4 p-6 rounded-sm shadow-xl relative overflow-hidden group border-b-4 ${darkMode ? 'bg-slate-900 border-blue-600' : 'bg-[#172B4D] border-[#0033A0]'}`}>
                                <div className="relative z-10">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-[10px] font-black uppercase tracking-widest flex items-center gap-2 text-blue-200"><Tag size={14} /> {language === 'KO' ? 'ì „ëµ íƒœê·¸' : 'Strategic Tags'}</h2>
                                        {selectedTag && <button onClick={() => setSelectedTag(null)} className="flex items-center gap-1 text-[8px] font-black bg-blue-600 hover:bg-blue-500 px-2.5 py-1 rounded-sm transition-all text-white"><XCircle size={10} /> RESET</button>}
                                    </div>
                                    <div className="flex flex-wrap gap-1.5 overflow-y-auto max-h-[140px] custom-scrollbar pr-2">
                                        {dynamicTags.map(tag => (
                                            <button key={tag.text} onClick={() => setSelectedTag(prev => prev === tag.text ? null : tag.text)} className={`px-2 py-1 rounded-sm text-[9px] font-bold border transition-all flex items-center gap-1.5 ${selectedTag === tag.text ? 'bg-white text-[#172B4D] border-white shadow-lg' : 'bg-white/5 border-white/10 hover:bg-white/15 text-blue-100'}`}>#{tag.translated} <span className={`text-[7.5px] font-black opacity-30`}>{tag.count}</span></button>
                                        ))}
                                    </div>
                                </div>
                                <Fingerprint className="absolute -bottom-8 -right-8 w-24 h-24 text-white/5" />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div className={`lg:col-span-9 rounded-sm border shadow-sm overflow-hidden flex flex-col transition-all hover:shadow-md ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <div className={`p-4 border-b flex items-center justify-between ${darkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-slate-50/50 border-slate-100'}`}>
                                    <h2 className="text-[10px] font-black uppercase tracking-widest flex items-center gap-2 text-slate-400"><Filter size={12} /> {language === 'KO' ? 'ëŒ€ìƒ ì¸í…”ë¦¬ì „ìŠ¤ ì»¨í…ìŠ¤íŠ¸ í”¼ë“œ' : 'Target Intelligence Context Feed'}</h2>
                                    <span className={`text-[8px] font-black px-2 py-0.5 rounded-full shadow-sm ${darkMode ? 'bg-blue-900/40 text-blue-400' : 'bg-blue-50 text-blue-600'}`}>{filteredData.length} Articles Loaded</span>
                                </div>
                                <div className="divide-y divide-slate-100 dark:divide-slate-800">
                                    {(filteredData.slice().reverse().slice((currPage - 1) * itemsPerPage, currPage * itemsPerPage)).map((item, idx) => (
                                        <div key={idx} className={`p-6 transition-all cursor-pointer group ${darkMode ? 'hover:bg-slate-800' : 'hover:bg-blue-50/20'}`} onClick={() => handleLink(item._uId)}>
                                            <div className="flex items-center gap-3 mb-3 text-[8.5px] font-black uppercase tracking-widest">
                                                <span className="px-2 py-0.5 rounded-sm text-white shadow-sm" style={{ backgroundColor: item.risk === 'High' ? RISK_COLORS.High : (CATEGORY_COLORS[item.category] || COLORS.activeBlue) }}>{safeString(item.category)}</span>
                                                <span className="text-slate-400 border-l border-slate-200 pl-3 dark:border-slate-700">{safeString(item.region)}</span>
                                                <span className="text-slate-300 border-l border-slate-200 pl-3 dark:border-slate-700 font-medium">{safeString(item.date)}</span>
                                                <span className={`ml-auto font-bold ${item.risk === 'High' ? 'text-red-500 animate-pulse' : 'text-slate-400'}`}>{safeString(item.risk)} RISK</span>
                                            </div>
                                            <h4 className={`text-[15px] font-bold leading-snug transition-colors mb-3 group-hover:text-blue-500 ${darkMode ? 'text-slate-200' : 'text-slate-800'}`}>{safeString(item.title)}</h4>
                                            {/* ğŸš€ ê¸°ì‚¬ ë³¸ë¬¸ ì¶œë ¥ ë³´ì¥ */}
                                            <p className="text-[12.5px] text-slate-500 leading-relaxed line-clamp-3 mb-3 dark:text-slate-400">{safeString(item.content)}</p>

                                            {/* ğŸ¤– BOT ì¸ì‚¬ì´íŠ¸ (Strategic Action) ì¶”ê°€ */}
                                            {item.bot && (
                                                <div className={`mb-4 p-4 rounded-sm border-l-4 ${darkMode ? 'bg-blue-900/10 border-blue-500/50 text-blue-100' : 'bg-blue-50 border-blue-600/50 text-blue-900'}`}>
                                                    <div className="flex items-center gap-2 mb-1.5 overflow-hidden">
                                                        <Cpu size={12} className="animate-pulse shrink-0" />
                                                        <span className="text-[10px] font-black uppercase tracking-tighter opacity-70 italic whitespace-nowrap">Strategic Intelligence Insight</span>
                                                    </div>
                                                    <p className="text-[11.5px] font-medium leading-relaxed opacity-90 line-clamp-3 italic">
                                                        {safeString(item.bot)}
                                                    </p>
                                                </div>
                                            )}

                                            <div className="flex flex-wrap gap-1.5">{item.tags.map(t => (<span key={t} className={`text-[8px] font-bold px-1.5 py-0.5 rounded-sm ${darkMode ? 'text-blue-400 bg-blue-900/20' : 'text-blue-400 bg-blue-50/50'}`}>#{translateCategory(t, language)}</span>))}</div>
                                        </div>
                                    ))}
                                    <div className="p-6 border-t dark:border-slate-800">
                                        <Pagination
                                            totalItems={filteredData.length}
                                            itemsPerPage={itemsPerPage}
                                            currentPage={currPage}
                                            onPageChange={setCurrPage}
                                            darkMode={darkMode}
                                            lang={language}
                                        />
                                    </div>
                                </div>

                            </div>
                            <div className={`lg:col-span-3 rounded-sm border shadow-sm p-6 flex flex-col ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <h2 className="text-[10px] font-black uppercase tracking-widest flex items-center gap-2 mb-4 text-slate-400"><TrendingUp size={16} className={darkMode ? 'text-blue-400' : 'text-[#0033A0]'} /> {language === 'KO' ? 'ì¸ê¸° ì¹´í…Œê³ ë¦¬' : 'Popular Categories'}</h2>
                                <div className="flex-1 h-[140px] mb-6">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={popularCategoryData} layout="vertical" margin={{ left: 5, right: 30, top: 0, bottom: 0 }}>
                                            <XAxis type="number" hide />
                                            <YAxis dataKey="name" type="category" axisLine={false} tickLine={false} tick={{ fontSize: 8, fontWeight: 900, fill: '#64748b' }} width={70} />
                                            <Bar dataKey="value" radius={[0, 4, 4, 0]}>
                                                {popularCategoryData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={CATEGORY_COLORS[entry.name] || COLORS.activeBlue} />
                                                ))}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>

                                <h2 className="text-[10px] font-black uppercase tracking-widest flex items-center gap-2 mb-4 text-slate-400"><Target size={14} className={darkMode ? 'text-blue-400' : 'text-[#0033A0]'} /> {language === 'KO' ? 'ë³¸ ì£¼ê°„ ìµœë‹¤ ì¡°íšŒ ê¸°ì‚¬' : 'Weekly Most Viewed'}</h2>
                                <div className="space-y-3 flex-1 overflow-y-auto max-h-[300px] pr-1 custom-scrollbar">
                                    {topArticles.map((article, i) => (
                                        <div key={i} onClick={() => handleLink(article._uId)} className={`p-3 rounded-sm border transition-all cursor-pointer hover:border-blue-400 group ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-slate-100'}`}>
                                            <div className="flex justify-between items-start gap-2 mb-1">
                                                <span className="text-[8px] font-black uppercase text-blue-500">{article.category}</span>
                                                <span className="text-[9px] font-bold text-slate-400 flex items-center gap-1"><Clock size={10} /> {article.viewCount} views</span>
                                            </div>
                                            <h5 className={`text-[11px] font-bold leading-tight line-clamp-2 group-hover:text-blue-500 transition-colors ${darkMode ? 'text-slate-200' : 'text-slate-800'}`}>{article.title}</h5>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* --- Monthly Performance Report Section --- */}
                        <div className={`mt-10 p-8 rounded-sm border-2 border-dashed transition-all hover:bg-opacity-80 relative overflow-hidden ${darkMode ? 'bg-slate-900/50 border-slate-800' : 'bg-blue-50/30 border-blue-100'}`}>
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-8 relative z-10">
                                <div className="flex items-center gap-4">
                                    <div className="p-3 bg-[#0033A0] text-white rounded-sm shadow-lg"><BarChart3 size={24} /></div>
                                    <div>
                                        <h2 className="text-xl font-black tracking-tight text-[#0033A0] dark:text-blue-400">Strategic Engagement Analysis</h2>
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">ì˜ì‚¬ê²°ì • ì§€ì› ë° ì „ëµ ì •ë³´ í™œìš© ì§€í‘œ</p>
                                    </div>
                                </div>
                                <button onClick={() => setShowReport(!showReport)} className="bg-[#0033A0] hover:bg-blue-700 text-white px-6 py-2.5 rounded-sm text-[11px] font-black uppercase tracking-widest transition-all shadow-md flex items-center gap-2">
                                    {showReport ? <XCircle size={14} /> : <FileText size={14} />} {showReport ? 'Close Analysis' : 'Generate Summary'}
                                </button>
                            </div>

                            {showReport && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in slide-in-from-top duration-500 relative z-10">
                                    <div className={`p-6 rounded-sm shadow-sm ${darkMode ? 'bg-slate-800' : 'bg-white'}`}>
                                        <h3 className="text-[10px] font-black uppercase tracking-widest text-[#0033A0] dark:text-blue-400 mb-4 flex items-center gap-2"><Eye size={14} /> Engagement Summary</h3>
                                        <div className="space-y-4">
                                            <div className="flex justify-between items-end border-b pb-2">
                                                <span className="text-[11px] font-bold text-slate-400">{language === 'KO' ? 'ëˆ„ì  ì •ë³´ ì—´ëŒ (PV)' : 'Total Page Views'}</span>
                                                <span className="text-2xl font-black tracking-tighter">{monthlyStats.reduce((acc, curr) => acc + (Number(curr.Views) || 0), 0)}</span>
                                            </div>
                                            <div className="flex justify-between items-end border-b pb-2">
                                                <span className="text-[11px] font-bold text-slate-400">{language === 'KO' ? 'ê³ ìœ  ë°©ë¬¸ í™œìš© (Sessions)' : 'Unique Sessions'}</span>
                                                <span className="text-2xl font-black tracking-tighter">{monthlyStats.reduce((acc, curr) => acc + (Number(curr.Sessions) || 0), 0)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className={`p-6 rounded-sm shadow-sm lg:col-span-2 ${darkMode ? 'bg-slate-800' : 'bg-white'}`}>
                                        <h3 className="text-[10px] font-black uppercase tracking-widest text-[#0033A0] dark:text-blue-400 mb-4 flex items-center gap-2"><Target size={14} /> Strategic Category Focus</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            {Object.entries(monthlyStats.reduce((acc, curr) => {
                                                acc[curr.Category] = (acc[curr.Category] || 0) + (Number(curr.Views) || 0);
                                                return acc;
                                            }, {})).sort((a, b) => b[1] - a[1]).slice(0, 4).map(([cat, val], idx) => (
                                                <div key={cat} className="flex flex-col">
                                                    <span className="text-[9px] font-black text-slate-400 uppercase line-clamp-1">{translateCategory(cat, language)}</span>
                                                    <span className="text-lg font-black">{val} <span className="text-[8px] font-bold text-blue-500">PV</span></span>
                                                    <div className="w-full bg-slate-100 dark:bg-slate-700 h-1 mt-1 rounded-full overflow-hidden">
                                                        <div className="bg-[#0033A0] dark:bg-blue-500 h-full" style={{ width: `${Math.min(100, (val / (monthlyStats.reduce((acc, curr) => acc + (Number(curr.Views) || 0), 0) || 1)) * 100)}%` }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                            <Fingerprint className="absolute -bottom-10 -left-10 w-48 h-48 text-blue-500/5 rotate-12" />
                        </div>
                    </main>
                    <footer className={`max-w-[1600px] mx-auto px-8 py-14 border-t text-center text-slate-400 transition-colors ${darkMode ? 'border-slate-800' : 'border-slate-200'}`}>
                        <p className="text-[9px] font-black uppercase tracking-[0.4em]">DA Intelligence Mapping Core // Framework Stable Release v8.2</p>
                    </footer>
                    <IndexModal isOpen={showIndex} onClose={() => setShowIndex(false)} darkMode={darkMode} />
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <!-- ê¸€ë¡œë²Œ ë“œë¡œì–´ JS -->
    <script>
        function toggleDashModDrawer() {
            const drawer = document.getElementById('dashmod-drawer');
            const overlay = document.getElementById('dashmod-drawer-overlay');
            const isOpen = parseInt(drawer.style.left) === 0;
            if (isOpen) {
                closeDashModDrawer();
            } else {
                const user = JSON.parse(localStorage.getItem('da_user'));
                const userEl = document.getElementById('dashmod-user-info');
                if (userEl) userEl.textContent = user ? user.userName + 'ë‹˜ ë¡œê·¸ì¸ ì¤‘' : 'ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ';
                const logoutBtn = document.getElementById('dashmod-logout-btn');
                const loginBtn = document.getElementById('dashmod-login-btn');
                if (logoutBtn) logoutBtn.style.display = user ? 'flex' : 'none';
                if (loginBtn) loginBtn.style.display = user ? 'none' : 'flex';
                drawer.style.left = '0px';
                overlay.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }
        function closeDashModDrawer() {
            document.getElementById('dashmod-drawer').style.left = '-320px';
            document.getElementById('dashmod-drawer-overlay').style.display = 'none';
            document.body.style.overflow = '';
        }
        function dashmodLogout() {
            localStorage.removeItem('da_user');
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>