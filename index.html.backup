<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEC DA Purchase Intelligence Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.goat1000.com/tagcanvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        body { font-family: 'Pretendard', sans-serif; transition: all 0.3s ease; }
        .header { height: 55px; position: fixed; top: 0; width: 100%; z-index: 100; border-bottom: 2px solid #1428a0; }
        .sidebar { width: 280px; position: fixed; left: 0; top: 55px; height: calc(100vh - 55px); border-right: 1px solid #eee; padding: 25px; overflow-y: auto; background: white; }
        .main-content { margin-left: 280px; margin-top: 55px; padding: 30px 40px; max-width: 1200px; }

        /* 1. 안정적인 8열 그리드 달력 (주차 포함) */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: 28px repeat(7, minmax(28px, 1fr)); 
            gap: 4px; 
            align-items: center; 
            justify-items: center;
            width: 100%;
            max-width: 280px;
        }
        .calendar-grid span { 
            width: 28px; 
            height: 28px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            transition: all 0.3s ease; 
            font-size: 10px; 
            cursor: default; 
            position: relative;
            flex-shrink: 0;
        }
        
        /* 주차 표시 스타일 */
        .week-label {
            font-size: 9px !important;
            font-weight: 700;
            color: #94a3b8;
            cursor: pointer !important;
            transition: all 0.2s;
        }
        .week-label:hover {
            color: #1428a0;
            transform: scale(1.1);
        }
        .week-selected {
            background: #1428a0 !important;
            color: white !important;
            border-radius: 4px !important;
        }
        
        /* 얄쌍한 링 디자인 (LV1~LV3) */
        .calendar-ring { border: 1.2px solid #1428a0; color: #1428a0; font-weight: 800; cursor: pointer !important; }
        .ring-lv1 { width: 20px !important; height: 20px !important; border-width: 1px; }
        .ring-lv2 { width: 24px !important; height: 24px !important; border-width: 2px; }
        .ring-lv3 { width: 28px !important; height: 28px !important; border-width: 3px; box-shadow: 0 0 8px rgba(20,40,160,0.15); }
        .calendar-selected { background-color: #1428a0 !important; color: white !important; border: none !important; }

        /* 네비게이션 화살표 스타일 */
        .nav-btn { cursor: pointer; padding: 2px; border-radius: 4px; transition: all 0.2s; color: #cbd5e1; }
        .nav-btn:hover { background: #f1f5f9; color: #1428a0; }

        /* 2. 동적 확장 카드 및 이미지 효과 */
        .news-item { border-bottom: 1px solid #f1f5f9; padding: 24px 0; cursor: pointer; transition: all 0.4s ease; overflow: hidden; max-height: 240px; }
        .news-item.expanded { max-height: 1500px; background: #fcfdfe; border-bottom: 2px solid #1428a0; }
        .summary-text { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .news-item.expanded .summary-text { -webkit-line-clamp: unset; }
        .news-item img { filter: grayscale(100%); transition: all 0.5s ease; }
        .news-item:hover img { filter: grayscale(0%); transform: scale(1.05); }

        /* 3D 인터랙티브 태그 클라우드 */
        #tagCloudContainer {
            position: relative;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
        }
        #tagCanvas {
            width: 100%;
            height: 100%;
        }
        #tagList {
            display: none;
        }
        #tagList a {
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            color: #1428a0;
            padding: 4px 8px;
        }

        /* 글로벌 지도 스타일 */
        #worldMap {
            width: 100%;
            height: 200px;
            background: #f8fafc;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .country-marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #1428a0;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .country-marker:hover {
            transform: scale(1.5);
            z-index: 10;
        }
        .country-marker::after {
            content: attr(data-country);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1428a0;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            margin-bottom: 4px;
        }
        .country-marker:hover::after {
            opacity: 1;
        }
        
        /* 펄스 애니메이션 */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }
        }

        /* URL 출처 링크 스타일 */
        .source-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .source-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #f1f5f9;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: #1428a0;
            text-decoration: none;
            transition: all 0.2s;
        }
        .source-link:hover {
            background: #1428a0;
            color: white;
            transform: translateY(-1px);
        }

        .dark body { background-color: #1a1c1e; color: #e2e8f0; }
        .dark .header, .dark .sidebar, .dark .news-item { background-color: #25282c; border-color: #3f444a; }
    </style>
</head>
<body class="bg-[#fcfcfc] text-[#333]">

    <header class="header flex items-center px-6 justify-between bg-white dark:bg-[#25282c] shadow-sm">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                <div class="w-7 h-7 bg-[#1428a0] rounded flex items-center justify-center text-white font-bold text-xs shadow-sm">DA</div>
                <h1 class="text-base font-black text-[#1428a0] dark:text-blue-400 tracking-tighter uppercase">Purchase Intelligence</h1>
            </div>
            <nav class="flex gap-8 text-sm font-bold text-gray-400">
                <a href="#" class="text-[#1428a0] border-b-2 border-[#1428a0] pb-1" onclick="resetFilters()">전략 시황</a>
                <a href="#" onclick="filterNews('원자재')">원자재</a>
                <a href="#" onclick="filterNews('거시경제')">거시/정책</a>
                <a href="#" onclick="filterNews('생산지역')">생산지역</a>
                <a href="#" onclick="filterNews('경쟁사')">경쟁사</a>
            </nav>
        </div>
        <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <i data-lucide="moon" id="themeIcon" class="w-4 h-4 text-gray-500"></i>
        </button>
    </header>

    <aside class="sidebar dark:bg-[#25282c]">
        <!-- 달력 섹션 -->
        <div class="mb-8">
            <h3 class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400 flex justify-between items-center">
                Archive Calendar
                <div class="flex items-center gap-1 bg-gray-50 dark:bg-gray-800 px-2 py-1 rounded-md">
                    <i data-lucide="chevrons-left" class="w-3 h-3 nav-btn" onclick="moveCalendar(-1, 0)"></i>
                    <i data-lucide="chevron-left" class="w-3 h-3 nav-btn" onclick="moveCalendar(0, -1)"></i>
                    <span id="calHeader" class="text-[10px] font-bold text-[#1428a0] min-w-[55px] text-center">2026. 01</span>
                    <i data-lucide="chevron-right" class="w-3 h-3 nav-btn" onclick="moveCalendar(0, 1)"></i>
                    <i data-lucide="chevrons-right" class="w-3 h-3 nav-btn" onclick="moveCalendar(1, 0)"></i>
                </div>
            </h3>
            <div id="calendarGrid" class="calendar-grid text-slate-400"></div>
        </div>

        <!-- 글로벌 지도 섹션 -->
        <div class="mb-8">
            <h3 class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400">Global Map</h3>
            <div id="worldMap"></div>
        </div>

        <!-- 3D 태그 클라우드 섹션 -->
        <div>
            <h3 class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400">Intelligence Cloud</h3>
            <div id="tagCloudContainer" style="width: 100%; height: 250px;">
                <canvas id="tagCanvas">
                    <ul id="tagList"></ul>
                </canvas>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="grid grid-cols-3 gap-6 mb-10" id="summaryGrid"></div>
        <div class="flex justify-between items-center mb-6 pb-2 border-b dark:border-gray-700">
            <h2 class="font-bold text-lg" id="feedTitle">Strategic Feed</h2>
            <div class="text-[10px] flex gap-4 uppercase font-bold text-slate-400">
                <span id="sortLatest" class="cursor-pointer text-[#1428a0]" onclick="sortNews('latest')">Latest</span>
                <span id="sortRisk" class="cursor-pointer hover:text-[#1428a0]" onclick="sortNews('risk')">Risk</span>
            </div>
        </div>
        <div id="loading" class="py-20 text-center animate-pulse text-blue-600 font-bold text-[10px] tracking-widest">SYNCING DATA...</div>
        <div id="news-feed" class="space-y-4"></div>
    </main>

    <div id="reportModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-[1000]">
        <div class="modal-content bg-white dark:bg-[#25282c] w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden transition-all duration-300 transform translate-y-4">
            <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center bg-[#1428a0] text-white">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="file-text" class="w-5 h-5"></i> 전략 요약 보고서</h3>
                <button onclick="closeModal()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="modalBody" class="p-8 max-h-[70vh] overflow-y-auto space-y-6"></div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwpTIuLZcwhQa0eGpeXhX9xGTyp7Q3h84rxufHOGdyIUZUiA3SD7bunjDpmvK6-6OcDxQ/exec";
        let allNews = [], currentFilteredNews = [];
        let curYear = 2026, curMonth = 0;
        let tagCloudInstance = null;

        // 국가 좌표 맵핑 (간소화된 세계 지도 좌표, %)
        const countryCoords = {
            '미국': { x: 20, y: 35 }, 'USA': { x: 20, y: 35 },
            '중국': { x: 75, y: 40 }, 'China': { x: 75, y: 40 },
            '일본': { x: 82, y: 38 }, 'Japan': { x: 82, y: 38 },
            '한국': { x: 80, y: 40 }, 'Korea': { x: 80, y: 40 }, 'South Korea': { x: 80, y: 40 },
            '독일': { x: 52, y: 30 }, 'Germany': { x: 52, y: 30 },
            '영국': { x: 48, y: 28 }, 'UK': { x: 48, y: 28 }, 'United Kingdom': { x: 48, y: 28 },
            '프랑스': { x: 50, y: 32 }, 'France': { x: 50, y: 32 },
            '러시아': { x: 65, y: 25 }, 'Russia': { x: 65, y: 25 },
            '인도': { x: 70, y: 50 }, 'India': { x: 70, y: 50 },
            '브라질': { x: 32, y: 70 }, 'Brazil': { x: 32, y: 70 },
            '호주': { x: 82, y: 75 }, 'Australia': { x: 82, y: 75 },
            '캐나다': { x: 22, y: 25 }, 'Canada': { x: 22, y: 25 },
            '멕시코': { x: 18, y: 48 }, 'Mexico': { x: 18, y: 48 },
            '이탈리아': { x: 53, y: 38 }, 'Italy': { x: 53, y: 38 },
            '스페인': { x: 48, y: 38 }, 'Spain': { x: 48, y: 38 },
            '베트남': { x: 76, y: 52 }, 'Vietnam': { x: 76, y: 52 },
            '태국': { x: 74, y: 52 }, 'Thailand': { x: 74, y: 52 },
            '인도네시아': { x: 78, y: 62 }, 'Indonesia': { x: 78, y: 62 }
        };

        // 철통 날짜 파싱
        function parseDate(dateStr) {
            if (!dateStr) return new Date();
            const clean = dateStr.toString().replace(/\./g, '-').replace(/\s/g, '');
            const parts = clean.split('T')[0].split('-');
            return parts.length < 3 ? new Date() : new Date(parts[0], parts[1] - 1, parts[2]);
        }

        // 주차 계산 함수
        function getWeekOfMonth(date) {
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const dayOfMonth = date.getDate();
            const firstDayOfWeek = firstDay.getDay();
            return Math.ceil((dayOfMonth + firstDayOfWeek) / 7);
        }

        // 날짜 범위로 필터링
        function getDateRangeForWeek(year, month, weekNum) {
            const firstDay = new Date(year, month, 1);
            const firstDayOfWeek = firstDay.getDay();
            
            const startDate = (weekNum - 1) * 7 - firstDayOfWeek + 1;
            const endDate = startDate + 6;
            
            return {
                start: Math.max(1, startDate),
                end: Math.min(endDate, new Date(year, month + 1, 0).getDate())
            };
        }

        async function fetchNews() {
            try {
                const res = await fetch(GAS_URL);
                allNews = await res.json();
                console.log('Fetched news:', allNews.length, 'items');
                console.log('Sample:', allNews[0]);
                currentFilteredNews = [...allNews];
                renderAll(allNews);
                sortNews('latest'); 
            } catch(e) { 
                console.error('Fetch error:', e); 
                document.getElementById('loading').innerText = 'ERROR LOADING DATA';
            }
            document.getElementById('loading').style.display = 'none';
        }

        function renderAll(data) {
            renderCalendar(data);
            renderSummary(data);
            renderTags(data);
            renderWorldMap(data);
        }

        function moveCalendar(yOff, mOff) {
            curYear += yOff;
            curMonth += mOff;
            if (curMonth > 11) { curMonth = 0; curYear++; }
            if (curMonth < 0) { curMonth = 11; curYear--; }
            
            document.getElementById('calHeader').innerText = `${curYear}. ${String(curMonth + 1).padStart(2, '0')}`;
            renderCalendar(allNews);
        }

        function renderCalendar(data) {
            const grid = document.getElementById('calendarGrid');
            const dateCounts = data.reduce((acc, n) => {
                const d = parseDate(n.Date);
                if(d.getFullYear() === curYear && d.getMonth() === curMonth) {
                    const day = d.getDate(); 
                    acc[day] = (acc[day] || 0) + 1;
                }
                return acc;
            }, {});

            let html = "";
            
            // 헤더: 주차 + 요일
            html += `<span class="font-bold opacity-30 text-[9px]">W</span>`;
            ['S','M','T','W','T','F','S'].forEach(s => html += `<span class="font-bold opacity-30 text-[10px]">${s}</span>`);

            const firstDay = new Date(curYear, curMonth, 1).getDay();
            const lastDate = new Date(curYear, curMonth + 1, 0).getDate();
            
            let currentWeek = 1;
            let dayCount = 0;

            // 첫 주
            html += `<span class="week-label" id="week-${currentWeek}" onclick="filterByWeek(${currentWeek})">W${currentWeek}</span>`;
            
            // 첫 주의 빈 칸
            for (let i = 0; i < firstDay; i++) {
                html += `<span class="invisible">-</span>`;
                dayCount++;
            }
            
            // 날짜 렌더링
            for (let d = 1; d <= lastDate; d++) {
                // 새로운 주 시작 (일요일)
                if (dayCount > 0 && dayCount % 7 === 0) {
                    currentWeek++;
                    html += `<span class="week-label" id="week-${currentWeek}" onclick="filterByWeek(${currentWeek})">W${currentWeek}</span>`;
                }
                
                const count = dateCounts[d] || 0;
                let lv = count >= 3 ? "calendar-ring ring-lv3" : count === 2 ? "calendar-ring ring-lv2" : count === 1 ? "calendar-ring ring-lv1" : "";
                const clickEvent = count > 0 ? `onclick="filterByDate(${d})"` : '';
                html += `<span class="${lv}" id="cal-${d}" ${clickEvent}>${d}</span>`;
                dayCount++;
            }
            
            // 마지막 주의 빈 칸
            const remainingCells = dayCount % 7;
            if (remainingCells !== 0) {
                for (let i = remainingCells; i < 7; i++) {
                    html += `<span class="invisible">-</span>`;
                }
            }
            
            grid.innerHTML = html;
        }

        function filterByWeek(weekNum) {
            // 모든 선택 해제
            document.querySelectorAll('.calendar-grid span').forEach(el => {
                el.classList.remove('calendar-selected', 'week-selected');
            });
            
            // 주차 라벨 선택 표시
            const weekLabel = document.getElementById(`week-${weekNum}`);
            if(weekLabel) weekLabel.classList.add('week-selected');
            
            const dateRange = getDateRangeForWeek(curYear, curMonth, weekNum);
            
            currentFilteredNews = allNews.filter(n => {
                const d = parseDate(n.Date);
                if(d.getFullYear() === curYear && d.getMonth() === curMonth) {
                    const day = d.getDate();
                    return day >= dateRange.start && day <= dateRange.end;
                }
                return false;
            });
            
            renderFeed(currentFilteredNews);
            document.getElementById('feedTitle').innerText = `Week ${weekNum} - ${curYear}.${String(curMonth + 1).padStart(2, '0')}`;
        }

        function filterByDate(day) {
            document.querySelectorAll('.calendar-grid span').forEach(el => {
                el.classList.remove('calendar-selected', 'week-selected');
            });
            const target = document.getElementById(`cal-${day}`);
            if(target) target.classList.add('calendar-selected');
            
            currentFilteredNews = allNews.filter(n => {
                const d = parseDate(n.Date);
                return d.getFullYear() === curYear && d.getMonth() === curMonth && d.getDate() === day;
            });
            renderFeed(currentFilteredNews);
            document.getElementById('feedTitle').innerText = `${curYear}.${String(curMonth + 1).padStart(2, '0')}.${String(day).padStart(2, '0')}`;
        }

        function sortNews(type) {
            const lb = document.getElementById('sortLatest'), rb = document.getElementById('sortRisk');
            lb.classList.remove('text-[#1428a0]');
            rb.classList.remove('text-[#1428a0]');
            lb.classList.add('text-slate-400');
            rb.classList.add('text-slate-400');
            
            if (type === 'latest') {
                currentFilteredNews.sort((a, b) => parseDate(b.Date) - parseDate(a.Date));
                lb.classList.add('text-[#1428a0]');
                lb.classList.remove('text-slate-400');
            } else {
                const p = { 'High': 1, 'Med': 2, 'Low': 3 };
                currentFilteredNews.sort((a, b) => (p[a.Risk] || 4) - (p[b.Risk] || 4));
                rb.classList.add('text-[#1428a0]');
                rb.classList.remove('text-slate-400');
            }
            renderFeed(currentFilteredNews);
        }

        // 다중 URL 파싱 함수
        function parseUrls(urlString) {
            if (!urlString) return [];
            
            // URL과 출처명 패턴 파싱: "출처명: URL" 또는 단순 URL
            const urlPattern = /(?:([^:,]+):\s*)?(https?:\/\/[^\s,]+)/g;
            const urls = [];
            let match;
            
            while ((match = urlPattern.exec(urlString)) !== null) {
                urls.push({
                    name: match[1] ? match[1].trim() : extractDomain(match[2]),
                    url: match[2].trim()
                });
            }
            
            return urls.length > 0 ? urls : [{ name: '원문', url: urlString }];
        }

        // 도메인에서 출처명 추출
        function extractDomain(url) {
            try {
                const domain = new URL(url).hostname.replace('www.', '');
                return domain.split('.')[0];
            } catch {
                return '출처';
            }
        }

        function renderFeed(data) {
            const feed = document.getElementById('news-feed');
            feed.innerHTML = data.map(n => {
                const urls = parseUrls(n.URL);
                const sourceLinksHtml = urls.map(src => 
                    `<a href="${src.url}" target="_blank" class="source-link" onclick="event.stopPropagation()">
                        <i data-lucide="external-link" class="w-3 h-3"></i>
                        ${src.name}
                    </a>`
                ).join('');
                
                return `
                <article class="news-item flex gap-8 items-start bg-white dark:bg-[#25282c] p-6 rounded-xl shadow-sm border border-transparent hover:border-blue-100 transition-all" onclick="this.classList.toggle('expanded')">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="px-2 py-0.5 rounded text-[9px] font-bold ${n.Risk === 'High' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}">${n.Category || 'N/A'}</span>
                            ${(n.Region || n.Country) ? `<span class="px-2 py-0.5 rounded text-[9px] font-bold bg-green-50 text-green-600">${n.Region || n.Country}</span>` : ''}
                            <span class="text-[10px] text-slate-400 ml-auto font-medium">${n.Date ? n.Date.toString().split('T')[0] : ''}</span>
                        </div>
                        <h4 class="font-bold text-base mb-3 leading-snug">${n.Title || 'No Title'}</h4>
                        <p class="summary-text text-[13px] text-slate-500 dark:text-slate-400 leading-relaxed mb-4">${n.Summary || ''}</p>
                        <div class="source-links">${sourceLinksHtml}</div>
                    </div>
                    ${n.Image ? `<div class="w-44 h-32 rounded-lg overflow-hidden flex-shrink-0 border dark:border-gray-800"><img src="${n.Image}" class="w-full h-full object-cover"></div>` : ''}
                </article>`;
            }).join('');
            lucide.createIcons();
        }

        // Obsidian 스타일 그래프 뷰 렌더링
        function renderTags(data) {
            console.log('renderTags called with', data.length, 'items');
            const tagMap = {};
            data.forEach(n => { 
                const tagField = n.Tag || n.Tags;
                if(tagField) {
                    tagField.split(',').forEach(tag => { 
                        const t = tag.trim(); 
                        if(t) tagMap[t] = (tagMap[t] || 0) + 1; 
                    }); 
                }
            });
            console.log('Tag map:', tagMap);
            
            const sortedTags = Object.entries(tagMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 30);
            
            const container = document.getElementById('tagCloud');
            
            if (sortedTags.length === 0) {
                container.innerHTML = '<div style="color: #94a3b8; font-size: 11px; text-align: center; padding: 40px;">태그 데이터 없음</div>';
                console.log('No tags found');
                return;
            }
            
            container.innerHTML = '';
            
            const width = container.offsetWidth;
            const height = 250;
            const maxCount = Math.max(...sortedTags.map(([_, c]) => c), 1);
            
            // 노드 위치 계산 (물리 기반 레이아웃)
            const nodes = sortedTags.map(([tag, count], idx) => {
                const angle = (idx / sortedTags.length) * 2 * Math.PI;
                const radius = 60 + (Math.random() * 40);
                const x = width/2 + Math.cos(angle) * radius + (Math.random() - 0.5) * 30;
                const y = height/2 + Math.sin(angle) * radius + (Math.random() - 0.5) * 30;
                const size = 10 + (count / maxCount) * 8;
                
                return { tag, count, x, y, size, vx: 0, vy: 0 };
            });
            
            // 연결선 그리기
            nodes.forEach((node, i) => {
                if (i < nodes.length - 1) {
                    // 가까운 노드와 연결
                    const nearNodes = nodes.slice(i + 1).filter(other => {
                        const dx = other.x - node.x;
                        const dy = other.y - node.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        return dist < 120 && Math.random() > 0.5;
                    });
                    
                    nearNodes.forEach(other => {
                        const line = document.createElement('div');
                        line.className = 'graph-line';
                        const dx = other.x - node.x;
                        const dy = other.y - node.y;
                        const length = Math.sqrt(dx * dx + dy * dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        
                        line.style.width = `${length}px`;
                        line.style.left = `${node.x}px`;
                        line.style.top = `${node.y}px`;
                        line.style.transform = `rotate(${angle}deg)`;
                        container.appendChild(line);
                    });
                }
            });
            
            // 노드 렌더링
            nodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = 'graph-node';
                nodeEl.textContent = node.tag;
                nodeEl.style.fontSize = `${node.size}px`;
                nodeEl.style.left = `${node.x}px`;
                nodeEl.style.top = `${node.y}px`;
                nodeEl.style.transform = 'translate(-50%, -50%)';
                
                // 빈도에 따른 색상
                const hue = 220 + (node.count / maxCount) * 60;
                nodeEl.style.borderColor = `hsla(${hue}, 70%, 60%, 0.8)`;
                nodeEl.style.background = `hsla(${hue}, 70%, 60%, 0.15)`;
                nodeEl.style.boxShadow = `0 0 ${10 + node.count * 3}px hsla(${hue}, 70%, 60%, 0.4)`;
                
                // 드래그 기능
                let isDragging = false;
                let startX, startY;
                
                nodeEl.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.clientX - node.x;
                    startY = e.clientY - node.y;
                    e.preventDefault();
                });
                
                nodeEl.addEventListener('click', (e) => {
                    if (!isDragging) {
                        showTagReport(node.tag);
                    }
                });
                
                container.appendChild(nodeEl);
            });
            
            // 드래그 이벤트
            container.addEventListener('mousemove', (e) => {
                const draggingNode = nodes.find(n => {
                    const nodeEl = Array.from(container.children).find(el => 
                        el.textContent === n.tag && el.classList.contains('graph-node')
                    );
                    return nodeEl && nodeEl.matches(':active');
                });
            });
            
            console.log('Graph nodes rendered:', nodes.length);
        }

        // 글로벌 지도 렌더링
        function renderWorldMap(data) {
            console.log('renderWorldMap called with', data.length, 'items');
            const countryMap = {};
            data.forEach(n => {
                const regionField = n.Region || n.Country; // Region 또는 Country 필드 지원
                if(regionField) {
                    const countries = regionField.split(',').map(c => c.trim());
                    countries.forEach(country => {
                        if(country) countryMap[country] = (countryMap[country] || 0) + 1;
                    });
                }
            });
            console.log('Country map:', countryMap);
            
            const mapContainer = document.getElementById('worldMap');
            
            if (Object.keys(countryMap).length === 0) {
                mapContainer.innerHTML = '<div style="color: #94a3b8; font-size: 11px; text-align: center; padding: 40px;">지역 데이터 없음</div>';
                console.log('No countries found');
                return;
            }
            
            mapContainer.innerHTML = '';
            
            // 명확한 세계 지도 배경 (단순화된 실루엣)
            mapContainer.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 280 200" style="position: absolute;">
                    <defs>
                        <linearGradient id="oceanGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#dbeafe;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#93c5fd;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="280" height="200" fill="url(#oceanGrad)"/>
                    
                    <!-- 격자선 -->
                    <line x1="0" y1="100" x2="280" y2="100" stroke="#bfdbfe" stroke-width="0.5" opacity="0.5"/>
                    <line x1="140" y1="0" x2="140" y2="200" stroke="#bfdbfe" stroke-width="0.5" opacity="0.5"/>
                    
                    <!-- 북미 (캐나다+미국) -->
                    <path d="M 25,20 L 35,15 L 50,18 L 60,25 L 65,35 L 68,50 L 65,65 L 58,75 L 45,80 L 30,78 L 20,70 L 18,55 L 20,35 Z" 
                          fill="#10b981" stroke="#059669" stroke-width="0.5" opacity="0.85"/>
                    
                    <!-- 남미 -->
                    <path d="M 48,88 L 55,85 L 62,90 L 65,105 L 68,125 L 65,140 L 58,148 L 50,150 L 45,145 L 42,130 L 40,110 L 42,95 Z" 
                          fill="#10b981" stroke="#059669" stroke-width="0.5" opacity="0.85"/>
                    
                    <!-- 유럽 -->
                    <path d="M 125,35 L 135,32 L 145,35 L 152,42 L 155,52 L 152,62 L 145,68 L 135,70 L 125,67 L 120,58 L 120,45 Z" 
                          fill="#10b981" stroke="#059669" stroke-width="0.5" opacity="0.85"/>
                    
                    <!-- 아프리카 -->
                    <path d="M 132,72 L 140,70 L 150,75 L 158,85 L 162,100 L 160,115 L 155,128 L 145,132 L 135,130 L 128,115 L 127,95 L 128,80 Z" 
                          fill="#10b981" stroke="#059669" stroke-width="0.5" opacity="0.85"/>
                    
                    <!-- 아시아 (러시아+중동+동아시아) -->
                    <path d="M 160,25 L 180,20 L 200,25 L 220,35 L 230,48 L 228,65 L 220,78 L 205,85 L 185,82 L 170,75 L 162,60 L 160,45 Z" 
                          fill="#10b981" stroke="#059669" stroke-width="0.5" opacity="0.85"/>
                    
                    <!-- 동남아시아 -->
                    <path d="M 200,85 L 210,88 L 218,95 L 220,105 L 215,115 L 205,118 L 195,115 L 192,105 L 195,95 Z" 
                          fill="#10b981" stroke="#059669" stroke-width="0.5" opacity="0.85"/>
                    
                    <!-- 호주 -->
                    <path d="M 210,135 L 225,132 L 238,138 L 242,148 L 240,158 L 230,163 L 215,162 L 208,155 L 207,145 Z" 
                          fill="#10b981" stroke="#059669" stroke-width="0.5" opacity="0.85"/>
                </svg>
            `;
            
            // 국가별 기사 수 표시
            console.log('Adding country list');
            const countryList = document.createElement('div');
            countryList.style.cssText = 'position: absolute; top: 5px; left: 5px; background: rgba(255,255,255,0.95); padding: 8px; border-radius: 6px; font-size: 9px; max-height: 180px; overflow-y: auto; z-index: 10;';
            countryList.innerHTML = `<div style="font-weight: 700; margin-bottom: 4px; color: #1428a0;">국가별 기사</div>` +
                Object.entries(countryMap)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .map(([country, count]) => 
                        `<div style="cursor: pointer; padding: 2px 0; color: #64748b;" onclick="filterByCountry('${country}')" onmouseover="this.style.color='#1428a0'" onmouseout="this.style.color='#64748b'">
                            ${country}: ${count}건
                        </div>`
                    ).join('');
            mapContainer.appendChild(countryList);
            
            // 국가 마커 추가
            console.log('Adding country markers');
            let markerCount = 0;
            Object.entries(countryMap).forEach(([country, count]) => {
                const coords = countryCoords[country];
                console.log(`Checking country: ${country}, coords:`, coords);
                if (coords) {
                    const marker = document.createElement('div');
                    marker.className = 'country-marker';
                    marker.setAttribute('data-country', `${country} (${count})`);
                    marker.style.left = `${coords.x}%`;
                    marker.style.top = `${coords.y}%`;
                    
                    // 빈도에 따른 크기 조정
                    const maxCount = Math.max(...Object.values(countryMap));
                    const size = 10 + (count / maxCount) * 10;
                    marker.style.width = `${size}px`;
                    marker.style.height = `${size}px`;
                    
                    // 펄스 애니메이션 추가
                    if (count > 1) {
                        marker.style.animation = 'pulse 2s infinite';
                    }
                    
                    marker.addEventListener('click', () => filterByCountry(country));
                    mapContainer.appendChild(marker);
                    markerCount++;
                } else {
                    console.log(`No coords for country: ${country}`);
                }
            });
            
            console.log('Total markers added:', markerCount);
        }

        function filterByCountry(country) {
            currentFilteredNews = allNews.filter(n => {
                const region = n.Region || n.Country;
                return region && region.includes(country);
            });
            renderFeed(currentFilteredNews);
            document.getElementById('feedTitle').innerText = `${country} 관련 뉴스`;
        }

        function showTagReport(tag) {
            const filtered = allNews.filter(n => {
                const tagField = n.Tag || n.Tags;
                return tagField && tagField.includes(tag);
            });
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <h4 class="font-bold mb-4 text-lg">#${tag} 전략 브리핑 (${filtered.length}건)</h4>
                <div class="space-y-3 text-sm">
                    ${filtered.map(n => `
                        <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <div class="font-bold mb-1">${n.Title}</div>
                            <div class="text-xs text-gray-500">${n.Date ? n.Date.toString().split('T')[0] : ''} | ${n.Category || 'N/A'}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('reportModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() { 
            document.getElementById('reportModal').classList.add('hidden'); 
        }
        
        function filterNews(cat) { 
            currentFilteredNews = cat === 'all' ? [...allNews] : allNews.filter(n => n.Category === cat); 
            renderFeed(currentFilteredNews); 
            document.getElementById('feedTitle').innerText = `${cat} 카테고리`;
        }
        
        function resetFilters() {
            currentFilteredNews = [...allNews];
            sortNews('latest');
            document.getElementById('feedTitle').innerText = 'Strategic Feed';
            document.querySelectorAll('.calendar-grid span').forEach(el => {
                el.classList.remove('calendar-selected', 'week-selected');
            });
        }
        
        function renderSummary(data) {
            const highs = data.filter(a => a.Risk === 'High').slice(0, 3);
            document.getElementById('summaryGrid').innerHTML = highs.map(a => 
                `<div class="p-6 bg-white dark:bg-[#25282c] shadow-sm border-t-4 border-[#1428a0] rounded-lg">
                    <h4 class="font-bold text-sm line-clamp-1">${a.Title || 'No Title'}</h4>
                </div>`
            ).join('');
        }
        
        function toggleDarkMode() { 
            document.documentElement.classList.toggle('dark'); 
            lucide.createIcons(); 
        }
        
        window.onload = () => { 
            lucide.createIcons(); 
            fetchNews(); 
        };
    </script>
</body>
</html>
