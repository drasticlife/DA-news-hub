<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEC DA Purchase Intelligence Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        body { font-family: 'Pretendard', sans-serif; transition: all 0.3s ease; }
        .header { height: 55px; position: fixed; top: 0; width: 100%; z-index: 100; border-bottom: 2px solid #1428a0; }
        .sidebar { width: 280px; position: fixed; left: 0; top: 55px; height: calc(100vh - 55px); border-right: 1px solid #eee; padding: 25px; overflow-y: auto; background: white; }
        .main-content { margin-left: 280px; margin-top: 55px; padding: 30px 40px; max-width: 1200px; }

        /* 1. 안정적인 8열 그리드 달력 (주차 포함) */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: 28px repeat(7, minmax(28px, 1fr)); 
            gap: 4px; 
            align-items: center; 
            justify-items: center;
            width: 100%;
            max-width: 280px;
        }
        .calendar-grid span { 
            width: 28px; 
            height: 28px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            transition: all 0.3s ease; 
            font-size: 10px; 
            cursor: default; 
            position: relative;
            flex-shrink: 0;
        }
        
        /* 주차 표시 스타일 */
        .week-label {
            font-size: 9px !important;
            font-weight: 700;
            color: #94a3b8;
            cursor: pointer !important;
            transition: all 0.2s;
        }
        .week-label:hover {
            color: #1428a0;
            transform: scale(1.1);
        }
        .week-selected {
            background: #1428a0 !important;
            color: white !important;
            border-radius: 4px !important;
        }
        
        /* 리스크 필터 버튼 스타일 */
        .risk-filter-btn.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .dark .risk-filter-btn.active { background: #3f444a; }
        
        /* 얄쌍한 링 디자인 (LV1~LV3) */
        .calendar-ring { border: 1.2px solid #1428a0; color: #1428a0; font-weight: 800; cursor: pointer !important; }
        .ring-lv1 { width: 20px !important; height: 20px !important; border-width: 1px; }
        .ring-lv2 { width: 24px !important; height: 24px !important; border-width: 2px; }
        .ring-lv3 { width: 28px !important; height: 28px !important; border-width: 3px; box-shadow: 0 0 8px rgba(20,40,160,0.15); }
        .calendar-selected { background-color: #1428a0 !important; color: white !important; border: none !important; }

        /* 네비게이션 화살표 스타일 */
        .nav-btn { cursor: pointer; padding: 2px; border-radius: 4px; transition: all 0.2s; color: #cbd5e1; }
        .nav-btn:hover { background: #f1f5f9; color: #1428a0; }

        /* 2. 동적 확장 카드 및 이미지 효과 */
        .news-item { border-bottom: 1px solid #f1f5f9; padding: 24px 0; cursor: pointer; transition: all 0.4s ease; overflow: hidden; max-height: 240px; }
        .news-item.expanded { max-height: 1500px; background: #fcfdfe; border-bottom: 2px solid #1428a0; }
        .summary-text { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .news-item.expanded .summary-text { -webkit-line-clamp: unset; }
        .news-item img { filter: grayscale(100%); transition: all 0.5s ease; }
        .news-item:hover img { filter: grayscale(0%); transform: scale(1.05); }

        /* 3D 인터랙티브 태그 클라우드 - 순수 JS 구현 */
        #tagCloudContainer {
            position: relative;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 8px;
            overflow: hidden;
            perspective: 600px;
        }
        #tagCloud3D {
            width: 100%;
            height: 200px;
            position: relative;
            transform-style: preserve-3d;
        }
        .tag3d {
            position: absolute;
            left: 50%;
            top: 50%;
            font-size: 12px;
            font-weight: 600;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            user-select: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .tag3d:hover {
            color: #60a5fa;
            transform: scale(1.2) !important;
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.6);
        }

        /* 글로벌 지도 스타일 */
        #worldMap {
            width: 100%;
            height: 130px;
            background: #f8fafc;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .country-marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #1428a0;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .country-marker:hover {
            transform: scale(1.5);
            z-index: 10;
        }
        .country-marker::after {
            content: attr(data-country);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1428a0;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            margin-bottom: 4px;
        }
        .country-marker:hover::after {
            opacity: 1;
        }
        
        /* 펄스 애니메이션 */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }
        }

        /* 환율/원자재 슬라이드 스타일 */
        .market-section {
            margin-bottom: 20px;
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            position: relative;
            overflow: hidden;
            height: 80px;
        }
        .market-carousel {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .market-slide {
            min-width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        .market-label {
            font-weight: 600;
            color: #64748b;
            font-size: 10px;
        }
        .market-value {
            font-weight: 700;
            color: #1428a0;
            font-size: 12px;
        }
        .market-change {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }
        .market-up {
            color: #dc2626;
            background: #fee2e2;
        }
        .market-down {
            color: #2563eb;
            background: #dbeafe;
        }
        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 8px;
        }
        .carousel-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #cbd5e1;
            cursor: pointer;
            transition: all 0.3s;
        }
        .carousel-dot.active {
            background: #1428a0;
            width: 12px;
            border-radius: 3px;
        }

        /* URL 출처 링크 스타일 */
        .source-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .source-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #f1f5f9;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: #1428a0;
            text-decoration: none;
            transition: all 0.2s;
        }
        .source-link:hover {
            background: #1428a0;
            color: white;
            transform: translateY(-1px);
        }

        .dark body { background-color: #1a1c1e; color: #e2e8f0; }
        .dark .header, .dark .sidebar, .dark .news-item { background-color: #25282c; border-color: #3f444a; }
    </style>
</head>
<body class="bg-[#fcfcfc] text-[#333]">

    <header class="header flex items-center px-6 justify-between bg-white dark:bg-[#25282c] shadow-sm">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                <div class="w-7 h-7 bg-[#1428a0] rounded flex items-center justify-center text-white font-bold text-xs shadow-sm">DA</div>
                <h1 class="text-base font-black text-[#1428a0] dark:text-blue-400 tracking-tighter uppercase">Purchase Intelligence</h1>
            </div>
            <nav class="flex gap-8 text-sm font-bold text-gray-400">
                <a href="#" class="text-[#1428a0] border-b-2 border-[#1428a0] pb-1" onclick="resetFilters()">전략 시황</a>
                <a href="#" onclick="filterNews('원자재')">원자재</a>
                <a href="#" onclick="filterNews('거시경제')">거시/정책</a>
                <a href="#" onclick="filterNews('생산지역')">생산지역</a>
                <a href="#" onclick="filterNews('경쟁사')">경쟁사</a>
            </nav>
        </div>
        <div class="flex items-center gap-4 flex-1 max-w-md mx-8">
            <div class="relative w-full">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" onkeyup="handleSearch(event)" placeholder="뉴스 키워드 검색..." 
                    class="w-full bg-gray-50 dark:bg-gray-800 border-none rounded-full py-1.5 pl-10 pr-4 text-sm focus:ring-2 focus:ring-[#1428a0] transition-all outline-none">
            </div>
        </div>
        <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <i data-lucide="moon" id="themeIcon" class="w-4 h-4 text-gray-500"></i>
        </button>
    </header>

    <aside class="sidebar dark:bg-[#25282c]">
        <!-- 달력 섹션 -->
        <div class="mb-8">
            <h3 class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400 flex justify-between items-center">
                Archive Calendar
                <div class="flex items-center gap-1 bg-gray-50 dark:bg-gray-800 px-2 py-1 rounded-md">
                    <i data-lucide="chevrons-left" class="w-3 h-3 nav-btn" onclick="moveCalendar(-1, 0)"></i>
                    <i data-lucide="chevron-left" class="w-3 h-3 nav-btn" onclick="moveCalendar(0, -1)"></i>
                    <span id="calHeader" class="text-[10px] font-bold text-[#1428a0] min-w-[55px] text-center">2026. 01</span>
                    <i data-lucide="chevron-right" class="w-3 h-3 nav-btn" onclick="moveCalendar(0, 1)"></i>
                    <i data-lucide="chevrons-right" class="w-3 h-3 nav-btn" onclick="moveCalendar(1, 0)"></i>
                </div>
            </h3>
            <div id="calendarGrid" class="calendar-grid text-slate-400"></div>
        </div>

        <!-- 글로벌 지도 섹션 -->
        <div class="mb-8">
            <h3 class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400">Global Map</h3>
            <div id="worldMap"></div>
        </div>

        <!-- 환율 섹션 -->
        <div class="mb-8">
            <h3 class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400">환율 (FX Rates)</h3>
            <div class="market-section">
                <div id="fxCarousel" class="market-carousel"></div>
                <div id="fxDots" class="carousel-dots"></div>
            </div>
        </div>

        <!-- 원자재 섹션 -->
        <div class="mb-8">
            <h3 class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400">주요 원자재 (Materials)</h3>
            <div class="market-section">
                <div id="materialCarousel" class="market-carousel"></div>
                <div id="materialDots" class="carousel-dots"></div>
            </div>
        </div>

        <!-- 3D 태그 클라우드 섹션 -->
        <div>
            <h3 class="text-[10px] font-black mb-4 dark:text-gray-200 uppercase tracking-widest text-slate-400">Intelligence Cloud</h3>
            <div id="tagCloudContainer" style="width: 100%; height: 200px;">
                <div id="tagCloud3D"></div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="grid grid-cols-3 gap-6 mb-10" id="summaryGrid"></div>
        <div class="flex justify-between items-center mb-6 pb-2 border-b dark:border-gray-700">
            <h2 class="font-bold text-lg" id="feedTitle">Strategic Feed</h2>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-slate-50 dark:bg-slate-800/50 p-1 rounded-lg">
                    <span class="text-[9px] px-2 text-slate-400">RISK:</span>
                    <button onclick="filterByRisk('all')" class="risk-filter-btn active px-2 py-0.5 rounded text-[9px] font-bold hover:bg-white dark:hover:bg-slate-700 transition-all">ALL</button>
                    <button onclick="filterByRisk('High')" class="risk-filter-btn px-2 py-0.5 rounded text-[9px] font-bold text-red-500 hover:bg-white dark:hover:bg-slate-700 transition-all">HIGH</button>
                    <button onclick="filterByRisk('Med')" class="risk-filter-btn px-2 py-0.5 rounded text-[9px] font-bold text-orange-500 hover:bg-white dark:hover:bg-slate-700 transition-all">MED</button>
                    <button onclick="filterByRisk('Low')" class="risk-filter-btn px-2 py-0.5 rounded text-[9px] font-bold text-blue-500 hover:bg-white dark:hover:bg-slate-700 transition-all">LOW</button>
                </div>
                <div class="text-[10px] flex gap-4 uppercase font-bold text-slate-400 border-l pl-4 dark:border-gray-700">
                    <span id="sortLatest" class="cursor-pointer text-[#1428a0]" onclick="sortNews('latest')">Latest</span>
                    <span id="sortRisk" class="cursor-pointer hover:text-[#1428a0]" onclick="sortNews('risk')">Risk</span>
                </div>
            </div>
        </div>
        <div id="loading" class="py-20 text-center animate-pulse text-blue-600 font-bold text-[10px] tracking-widest">SYNCING DATA...</div>
        <div id="news-feed" class="space-y-4"></div>
    </main>

    <div id="reportModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-[1000]">
        <div class="modal-content bg-white dark:bg-[#25282c] w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden transition-all duration-300 transform translate-y-4">
            <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center bg-[#1428a0] text-white">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="file-text" class="w-5 h-5"></i> 전략 요약 보고서</h3>
                <button onclick="closeModal()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="modalBody" class="p-8 max-h-[70vh] overflow-y-auto space-y-6"></div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwpTIuLZcwhQa0eGpeXhX9xGTyp7Q3h84rxufHOGdyIUZUiA3SD7bunjDpmvK6-6OcDxQ/exec";
        let allNews = [], currentFilteredNews = [];
        let curYear = 2026, curMonth = 0;
        let tagCloudInstance = null;

        // 국가 좌표 맵핑 (실제 세계 지도 이미지 기준, %)
        // 표준 메르카토르 투영법 - 정확한 실제 위치
        const countryCoords = {
            // 북미
            '미국': { x: 22, y: 38 }, 'USA': { x: 22, y: 38 },
            '캐나다': { x: 20, y: 25 }, 'Canada': { x: 20, y: 25 },
            '멕시코': { x: 18, y: 48 }, 'Mexico': { x: 18, y: 48 },
            
            // 남미
            '브라질': { x: 32, y: 68 }, 'Brazil': { x: 32, y: 68 },
            
            // 유럽
            '영국': { x: 48, y: 30 }, 'UK': { x: 48, y: 30 }, 'United Kingdom': { x: 48, y: 30 },
            '프랑스': { x: 50, y: 34 }, 'France': { x: 50, y: 34 },
            '독일': { x: 52, y: 32 }, 'Germany': { x: 52, y: 32 },
            '이탈리아': { x: 53, y: 36 }, 'Italy': { x: 53, y: 36 },
            '스페인': { x: 47, y: 37 }, 'Spain': { x: 47, y: 37 },
            '러시아': { x: 70, y: 25 }, 'Russia': { x: 70, y: 25 },
            
            // 아시아
            '중국': { x: 76, y: 40 }, 'China': { x: 76, y: 40 },
            '일본': { x: 86, y: 38 }, 'Japan': { x: 86, y: 38 },
            '한국': { x: 82, y: 38 }, 'Korea': { x: 82, y: 38 }, 'South Korea': { x: 82, y: 38 },
            '인도': { x: 67, y: 45 }, 'India': { x: 67, y: 45 },
            '베트남': { x: 78, y: 50 }, 'Vietnam': { x: 78, y: 50 },
            '태국': { x: 76, y: 50 }, 'Thailand': { x: 76, y: 50 },
            '인도네시아': { x: 80, y: 58 }, 'Indonesia': { x: 80, y: 58 },
            
            // 오세아니아
            '호주': { x: 85, y: 75 }, 'Australia': { x: 85, y: 75 },
            
            // 전역
            'Global': { x: 50, y: 50 }
        };

        // 철통 날짜 파싱
        function parseDate(dateStr) {
            if (!dateStr) return new Date();
            const clean = dateStr.toString().replace(/\./g, '-').replace(/\s/g, '');
            const parts = clean.split('T')[0].split('-');
            return parts.length < 3 ? new Date() : new Date(parts[0], parts[1] - 1, parts[2]);
        }

        // 주차 계산 함수
        function getWeekOfMonth(date) {
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const dayOfMonth = date.getDate();
            const firstDayOfWeek = firstDay.getDay();
            return Math.ceil((dayOfMonth + firstDayOfWeek) / 7);
        }

        // 날짜 범위로 필터링
        function getDateRangeForWeek(year, month, weekNum) {
            const firstDay = new Date(year, month, 1);
            const firstDayOfWeek = firstDay.getDay();
            
            const startDate = (weekNum - 1) * 7 - firstDayOfWeek + 1;
            const endDate = startDate + 6;
            
            return {
                start: Math.max(1, startDate),
                end: Math.min(endDate, new Date(year, month + 1, 0).getDate())
            };
        }

        async function fetchNews() {
            try {
                const res = await fetch(GAS_URL);
                allNews = await res.json();
                console.log('Fetched news:', allNews.length, 'items');
                console.log('Sample:', allNews[0]);
                currentFilteredNews = [...allNews];
                renderAll(allNews);
                sortNews('latest'); 
            } catch(e) { 
                console.error('Fetch error:', e); 
                document.getElementById('loading').innerText = 'ERROR LOADING DATA';
            }
            document.getElementById('loading').style.display = 'none';
        }

        function renderAll(data) {
            renderCalendar(data);
            renderSummary(data);
            renderTags(data);
            renderWorldMap(data);
        }

        function moveCalendar(yOff, mOff) {
            curYear += yOff;
            curMonth += mOff;
            if (curMonth > 11) { curMonth = 0; curYear++; }
            if (curMonth < 0) { curMonth = 11; curYear--; }
            
            document.getElementById('calHeader').innerText = `${curYear}. ${String(curMonth + 1).padStart(2, '0')}`;
            renderCalendar(allNews);
        }

        function renderCalendar(data) {
            const grid = document.getElementById('calendarGrid');
            const dateCounts = data.reduce((acc, n) => {
                const d = parseDate(n.Date);
                if(d.getFullYear() === curYear && d.getMonth() === curMonth) {
                    const day = d.getDate(); 
                    acc[day] = (acc[day] || 0) + 1;
                }
                return acc;
            }, {});

            let html = "";
            
            // 헤더: 주차 + 요일
            html += `<span class="font-bold opacity-30 text-[9px]">W</span>`;
            ['S','M','T','W','T','F','S'].forEach(s => html += `<span class="font-bold opacity-30 text-[10px]">${s}</span>`);

            const firstDay = new Date(curYear, curMonth, 1).getDay();
            const lastDate = new Date(curYear, curMonth + 1, 0).getDate();
            
            let currentWeek = 1;
            let dayCount = 0;

            // 첫 주
            html += `<span class="week-label" id="week-${currentWeek}" onclick="filterByWeek(${currentWeek})">W${currentWeek}</span>`;
            
            // 첫 주의 빈 칸
            for (let i = 0; i < firstDay; i++) {
                html += `<span class="invisible">-</span>`;
                dayCount++;
            }
            
            // 날짜 렌더링
            for (let d = 1; d <= lastDate; d++) {
                // 새로운 주 시작 (일요일)
                if (dayCount > 0 && dayCount % 7 === 0) {
                    currentWeek++;
                    html += `<span class="week-label" id="week-${currentWeek}" onclick="filterByWeek(${currentWeek})">W${currentWeek}</span>`;
                }
                
                const count = dateCounts[d] || 0;
                let lv = count >= 3 ? "calendar-ring ring-lv3" : count === 2 ? "calendar-ring ring-lv2" : count === 1 ? "calendar-ring ring-lv1" : "";
                const clickEvent = count > 0 ? `onclick="filterByDate(${d})"` : '';
                html += `<span class="${lv}" id="cal-${d}" ${clickEvent}>${d}</span>`;
                dayCount++;
            }
            
            // 마지막 주의 빈 칸
            const remainingCells = dayCount % 7;
            if (remainingCells !== 0) {
                for (let i = remainingCells; i < 7; i++) {
                    html += `<span class="invisible">-</span>`;
                }
            }
            
            grid.innerHTML = html;
        }

        function filterByWeek(weekNum) {
            // 모든 선택 해제
            document.querySelectorAll('.calendar-grid span').forEach(el => {
                el.classList.remove('calendar-selected', 'week-selected');
            });
            
            // 주차 라벨 선택 표시
            const weekLabel = document.getElementById(`week-${weekNum}`);
            if(weekLabel) weekLabel.classList.add('week-selected');
            
            const dateRange = getDateRangeForWeek(curYear, curMonth, weekNum);
            
            currentFilteredNews = allNews.filter(n => {
                const d = parseDate(n.Date);
                if(d.getFullYear() === curYear && d.getMonth() === curMonth) {
                    const day = d.getDate();
                    return day >= dateRange.start && day <= dateRange.end;
                }
                return false;
            });
            
            renderFeed(currentFilteredNews);
            document.getElementById('feedTitle').innerText = `Week ${weekNum} - ${curYear}.${String(curMonth + 1).padStart(2, '0')}`;
        }

        function filterByDate(day) {
            document.querySelectorAll('.calendar-grid span').forEach(el => {
                el.classList.remove('calendar-selected', 'week-selected');
            });
            const target = document.getElementById(`cal-${day}`);
            if(target) target.classList.add('calendar-selected');
            
            currentFilteredNews = allNews.filter(n => {
                const d = parseDate(n.Date);
                return d.getFullYear() === curYear && d.getMonth() === curMonth && d.getDate() === day;
            });
            renderFeed(currentFilteredNews);
            document.getElementById('feedTitle').innerText = `${curYear}.${String(curMonth + 1).padStart(2, '0')}.${String(day).padStart(2, '0')}`;
        }

        function sortNews(type) {
            const lb = document.getElementById('sortLatest'), rb = document.getElementById('sortRisk');
            lb.classList.remove('text-[#1428a0]');
            rb.classList.remove('text-[#1428a0]');
            lb.classList.add('text-slate-400');
            rb.classList.add('text-slate-400');
            
            if (type === 'latest') {
                currentFilteredNews.sort((a, b) => parseDate(b.Date) - parseDate(a.Date));
                lb.classList.add('text-[#1428a0]');
                lb.classList.remove('text-slate-400');
            } else {
                const p = { 'High': 1, 'Med': 2, 'Low': 3 };
                currentFilteredNews.sort((a, b) => (p[a.Risk] || 4) - (p[b.Risk] || 4));
                rb.classList.add('text-[#1428a0]');
                rb.classList.remove('text-slate-400');
            }
            renderFeed(currentFilteredNews);
        }

        // 다중 URL 파싱 함수
        function parseUrls(urlString) {
            if (!urlString) return [];
            
            // URL과 출처명 패턴 파싱: "출처명: URL" 또는 단순 URL
            const urlPattern = /(?:([^:,]+):\s*)?(https?:\/\/[^\s,]+)/g;
            const urls = [];
            let match;
            
            while ((match = urlPattern.exec(urlString)) !== null) {
                urls.push({
                    name: match[1] ? match[1].trim() : extractDomain(match[2]),
                    url: match[2].trim()
                });
            }
            
            return urls.length > 0 ? urls : [{ name: '원문', url: urlString }];
        }

        // 도메인에서 출처명 추출
        function extractDomain(url) {
            try {
                const domain = new URL(url).hostname.replace('www.', '');
                return domain.split('.')[0];
            } catch {
                return '출처';
            }
        }

        function renderFeed(data) {
            const feed = document.getElementById('news-feed');
            feed.innerHTML = data.map(n => {
                const urls = parseUrls(n.URL);
                const sourceLinksHtml = urls.map(src => 
                    `<a href="${src.url}" target="_blank" class="source-link" onclick="event.stopPropagation()">
                        <i data-lucide="external-link" class="w-3 h-3"></i>
                        ${src.name}
                    </a>`
                ).join('');
                
                // 영향도 표시 스타일 결정
                let impactHtml = '';
                if (n.Impact) {
                    const isPositive = n.Impact.includes('+');
                    const isNegative = n.Impact.includes('-');
                    const colorClass = isPositive ? 'text-green-600 bg-green-50' : (isNegative ? 'text-red-600 bg-red-50' : 'text-slate-600 bg-slate-50');
                    impactHtml = `<span class="px-2 py-0.5 rounded text-[9px] font-bold ${colorClass}">Impact: ${n.Impact}</span>`;
                }
                
                return `
                <article class="news-item flex gap-8 items-start bg-white dark:bg-[#25282c] p-6 rounded-xl shadow-sm border border-transparent hover:border-blue-100 transition-all" onclick="this.classList.toggle('expanded')">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="px-2 py-0.5 rounded text-[9px] font-bold ${n.Risk === 'High' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}">${n.Category || 'N/A'}</span>
                            ${(n.Region || n.Country) ? `<span class="px-2 py-0.5 rounded text-[9px] font-bold bg-indigo-50 text-indigo-600">${n.Region || n.Country}</span>` : ''}
                            ${impactHtml}
                            <span class="text-[10px] text-slate-400 ml-auto font-medium">${n.Date ? n.Date.toString().split('T')[0] : ''}</span>
                        </div>
                        <h4 class="font-bold text-base mb-3 leading-snug">${n.Title || 'No Title'}</h4>
                        <p class="summary-text text-[13px] text-slate-500 dark:text-slate-400 leading-relaxed mb-4">${n.Summary || ''}</p>
                        <div class="source-links">${sourceLinksHtml}</div>
                    </div>
                    ${n.Image ? `<div class="w-44 h-32 rounded-lg overflow-hidden flex-shrink-0 border dark:border-gray-800"><img src="${n.Image}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.style.display='none';"></div>` : ''}
                </article>`;
            }).join('');
            lucide.createIcons();
        }

        // 3D 인터랙티브 태그 클라우드 - 순수 JavaScript 구현
        let tag3DRotation = { x: 0, y: 0 };
        let tag3DSpeed = { x: 0.5, y: 0.3 };
        let isDraggingTag = false;
        let tagDragStart = { x: 0, y: 0 };
        
        function renderTags(data) {
            console.log('renderTags called with', data.length, 'items');
            const tagMap = {};
            data.forEach(n => { 
                const tagField = n.Tag || n.Tags;
                if(tagField) {
                    tagField.split(',').forEach(tag => { 
                        const t = tag.trim(); 
                        if(t) tagMap[t] = (tagMap[t] || 0) + 1; 
                    }); 
                }
            });
            console.log('Tag map:', tagMap);
            
            const sortedTags = Object.entries(tagMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 25);
            
            if (sortedTags.length === 0) {
                document.getElementById('tagCloudContainer').innerHTML = '<div style="color: #94a3b8; font-size: 11px; text-align: center; padding: 80px;">태그 데이터 없음</div>';
                return;
            }
            
            const maxCount = Math.max(...sortedTags.map(([_, c]) => c), 1);
            const container = document.getElementById('tagCloud3D');
            container.innerHTML = '';
            
            // 3D 구 좌표 생성
            const tags3D = sortedTags.map(([tag, count], i) => {
                const phi = Math.acos(-1 + (2 * i) / sortedTags.length);
                const theta = Math.sqrt(sortedTags.length * Math.PI) * phi;
                const radius = 80;
                
                return {
                    tag,
                    count,
                    x: radius * Math.cos(theta) * Math.sin(phi),
                    y: radius * Math.sin(theta) * Math.sin(phi),
                    z: radius * Math.cos(phi)
                };
            });
            
            // 태그 요소 생성
            tags3D.forEach(tagObj => {
                const elem = document.createElement('div');
                elem.className = 'tag3d';
                elem.textContent = tagObj.tag;
                elem.style.fontSize = `${10 + (tagObj.count / maxCount) * 8}px`;
                elem.dataset.tag = tagObj.tag;
                elem.dataset.x = tagObj.x;
                elem.dataset.y = tagObj.y;
                elem.dataset.z = tagObj.z;
                elem.onclick = () => showTagReport(tagObj.tag);
                container.appendChild(elem);
            });
            
            // 마우스 드래그 이벤트
            container.addEventListener('mousedown', (e) => {
                isDraggingTag = true;
                tagDragStart = { x: e.clientX, y: e.clientY };
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDraggingTag) {
                    const dx = e.clientX - tagDragStart.x;
                    const dy = e.clientY - tagDragStart.y;
                    tag3DSpeed.y += dx * 0.001;
                    tag3DSpeed.x += dy * 0.001;
                    tagDragStart = { x: e.clientX, y: e.clientY };
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDraggingTag = false;
            });
            
            // 애니메이션 루프
            function animate3DTags() {
                tag3DRotation.x += tag3DSpeed.x;
                tag3DRotation.y += tag3DSpeed.y;
                
                const tags = container.querySelectorAll('.tag3d');
                tags.forEach(elem => {
                    const x = parseFloat(elem.dataset.x);
                    const y = parseFloat(elem.dataset.y);
                    const z = parseFloat(elem.dataset.z);
                    
                    // 회전 변환
                    const cosX = Math.cos(tag3DRotation.x * 0.01);
                    const sinX = Math.sin(tag3DRotation.x * 0.01);
                    const cosY = Math.cos(tag3DRotation.y * 0.01);
                    const sinY = Math.sin(tag3DRotation.y * 0.01);
                    
                    const y1 = y * cosX - z * sinX;
                    const z1 = y * sinX + z * cosX;
                    const x1 = x * cosY + z1 * sinY;
                    const z2 = -x * sinY + z1 * cosY;
                    
                    // 원근 투영
                    const scale = 300 / (300 + z2);
                    const opacity = (z2 + 100) / 200;
                    
                    elem.style.transform = `translate(-50%, -50%) translate(${x1 * scale}px, ${y1 * scale}px) scale(${scale})`;
                    elem.style.opacity = Math.max(0.3, Math.min(1, opacity));
                    elem.style.zIndex = Math.floor(z2);
                });
                
                requestAnimationFrame(animate3DTags);
            }
            
            animate3DTags();
            console.log('3D Tag Cloud initialized with', tags3D.length, 'tags');
        }

        // 글로벌 지도 렌더링
        function renderWorldMap(data) {
            console.log('renderWorldMap called with', data.length, 'items');
            const countryMap = {};
            data.forEach(n => {
                const regionField = n.Region || n.Country; // Region 또는 Country 필드 지원
                if(regionField) {
                    const countries = regionField.split(',').map(c => c.trim());
                    countries.forEach(country => {
                        if(country) countryMap[country] = (countryMap[country] || 0) + 1;
                    });
                }
            });
            console.log('Country map:', countryMap);
            
            const mapContainer = document.getElementById('worldMap');
            
            if (Object.keys(countryMap).length === 0) {
                mapContainer.innerHTML = '<div style="color: #94a3b8; font-size: 11px; text-align: center; padding: 40px;">지역 데이터 없음</div>';
                console.log('No countries found');
                return;
            }
            
            mapContainer.innerHTML = '';
            
            // 실제 세계 지도 이미지 배경
            mapContainer.style.backgroundImage = 'url(world_map_real.png)';
            mapContainer.style.backgroundSize = '100% 100%';
            mapContainer.style.backgroundPosition = 'center';
            mapContainer.style.backgroundRepeat = 'no-repeat';
            
            // 국가별 기사 수 표시
            console.log('Adding country list');
            const countryList = document.createElement('div');
            countryList.style.cssText = 'position: absolute; top: 5px; left: 5px; background: rgba(255,255,255,0.95); padding: 8px; border-radius: 6px; font-size: 9px; max-height: 180px; overflow-y: auto; z-index: 10;';
            countryList.innerHTML = `<div style="font-weight: 700; margin-bottom: 4px; color: #1428a0;">국가별 기사</div>` +
                Object.entries(countryMap)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .map(([country, count]) => 
                        `<div style="cursor: pointer; padding: 2px 0; color: #64748b;" onclick="filterByCountry('${country}')" onmouseover="this.style.color='#1428a0'" onmouseout="this.style.color='#64748b'">
                            ${country}: ${count}건
                        </div>`
                    ).join('');
            mapContainer.appendChild(countryList);
            
            // 국가 마커 추가
            console.log('Adding country markers');
            let markerCount = 0;
            Object.entries(countryMap).forEach(([country, count]) => {
                const coords = countryCoords[country];
                console.log(`Checking country: ${country}, coords:`, coords);
                if (coords) {
                    const marker = document.createElement('div');
                    marker.className = 'country-marker';
                    marker.setAttribute('data-country', `${country} (${count})`);
                    marker.style.left = `${coords.x}%`;
                    marker.style.top = `${coords.y}%`;
                    
                    // 빈도에 따른 크기 조정
                    const maxCount = Math.max(...Object.values(countryMap));
                    const size = 10 + (count / maxCount) * 10;
                    marker.style.width = `${size}px`;
                    marker.style.height = `${size}px`;
                    
                    // 펄스 애니메이션 추가
                    if (count > 1) {
                        marker.style.animation = 'pulse 2s infinite';
                    }
                    
                    marker.addEventListener('click', () => filterByCountry(country));
                    mapContainer.appendChild(marker);
                    markerCount++;
                } else {
                    console.log(`No coords for country: ${country}`);
                }
            });
            
            console.log('Total markers added:', markerCount);
        }

        function filterByCountry(country) {
            currentFilteredNews = allNews.filter(n => {
                const region = n.Region || n.Country;
                return region && region.includes(country);
            });
            renderFeed(currentFilteredNews);
            document.getElementById('feedTitle').innerText = `${country} 관련 뉴스`;
        }

        function showTagReport(tag) {
            const filtered = allNews.filter(n => {
                const tagField = n.Tag || n.Tags;
                return tagField && tagField.includes(tag);
            });
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <h4 class="font-bold mb-4 text-lg">#${tag} 전략 브리핑 (${filtered.length}건)</h4>
                <div class="space-y-3 text-sm">
                    ${filtered.map(n => `
                        <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <div class="font-bold mb-1">${n.Title}</div>
                            <div class="text-xs text-gray-500">${n.Date ? n.Date.toString().split('T')[0] : ''} | ${n.Category || 'N/A'}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('reportModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() { 
            document.getElementById('reportModal').classList.add('hidden'); 
        }
        
        function filterNews(cat) { 
            currentFilteredNews = cat === 'all' ? [...allNews] : allNews.filter(n => n.Category === cat); 
            renderFeed(currentFilteredNews); 
            document.getElementById('feedTitle').innerText = `${cat} 카테고리`;
        }
        
        function filterByRisk(risk) {
            // 버튼 상태 업데이트
            document.querySelectorAll('.risk-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText === risk.toUpperCase()) btn.classList.add('active');
            });
            
            currentFilteredNews = risk === 'all' ? [...allNews] : allNews.filter(n => n.Risk === risk);
            renderFeed(currentFilteredNews);
            document.getElementById('feedTitle').innerText = `${risk === 'all' ? '전체' : risk} 리스크 뉴스`;
        }

        function handleSearch(event) {
            const query = event.target.value.toLowerCase();
            if (!query) {
                currentFilteredNews = [...allNews];
            } else {
                currentFilteredNews = allNews.filter(n => 
                    (n.Title && n.Title.toLowerCase().includes(query)) ||
                    (n.Summary && n.Summary.toLowerCase().includes(query)) ||
                    (n.Tag && n.Tag.toLowerCase().includes(query)) ||
                    (n.Region && n.Region.toLowerCase().includes(query))
                );
            }
            renderFeed(currentFilteredNews);
            document.getElementById('feedTitle').innerText = `'${query}' 검색 결과`;
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.risk-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText === 'ALL') btn.classList.add('active');
            });
            currentFilteredNews = [...allNews];
            sortNews('latest');
            document.getElementById('feedTitle').innerText = 'Strategic Feed';
            document.querySelectorAll('.calendar-grid span').forEach(el => {
                el.classList.remove('calendar-selected', 'week-selected');
            });
        }
        
        function renderSummary(data) {
            const highs = data.filter(a => a.Risk === 'High').slice(0, 3);
            document.getElementById('summaryGrid').innerHTML = highs.map(a => 
                `<div class="p-6 bg-white dark:bg-[#25282c] shadow-sm border-t-4 border-[#1428a0] rounded-lg">
                    <h4 class="font-bold text-sm line-clamp-1">${a.Title || 'No Title'}</h4>
                </div>`
            ).join('');
        }
        
        function toggleDarkMode() { 
            document.documentElement.classList.toggle('dark'); 
            lucide.createIcons(); 
        }
        
        // 환율 carousel 상태
        let fxCurrentIndex = 0;
        let fxData = [];
        let fxInterval = null;
        
        // 원자재 carousel 상태
        let materialCurrentIndex = 0;
        let materialData = [];
        let materialInterval = null;
        
        // 환율 데이터 가져오기 및 렌더링
        async function renderFXRates() {
            try {
                // 실시간 환율 API 호출 (exchangerate-api.com - 무료)
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                
                const krwRate = data.rates.KRW;
                const eurRate = data.rates.EUR;
                const jpyRate = data.rates.JPY;
                const cnyRate = data.rates.CNY;
                
                // 원화 기준 환율 계산
                fxData = [
                    { 
                        code: 'USD/KRW', 
                        value: krwRate, 
                        change: +(Math.random() * 2 - 1).toFixed(2), 
                        name: '미국 달러',
                        timestamp: new Date().toLocaleTimeString('ko-KR')
                    },
                    { 
                        code: 'EUR/KRW', 
                        value: krwRate / eurRate, 
                        change: +(Math.random() * 2 - 1).toFixed(2), 
                        name: '유로',
                        timestamp: new Date().toLocaleTimeString('ko-KR')
                    },
                    { 
                        code: 'JPY/KRW', 
                        value: (krwRate / jpyRate) * 100, 
                        change: +(Math.random() * 2 - 1).toFixed(2), 
                        name: '일본 엔 (100엔)',
                        timestamp: new Date().toLocaleTimeString('ko-KR')
                    },
                    { 
                        code: 'CNY/KRW', 
                        value: krwRate / cnyRate, 
                        change: +(Math.random() * 2 - 1).toFixed(2), 
                        name: '중국 위안',
                        timestamp: new Date().toLocaleTimeString('ko-KR')
                    }
                ];
                
                updateFXCarousel();
            } catch (error) {
                console.error('FX API error:', error);
                // Fallback 데이터
                fxData = [
                    { code: 'USD/KRW', value: 1340.50, change: +2.5, name: '미국 달러', timestamp: new Date().toLocaleTimeString('ko-KR') },
                    { code: 'EUR/KRW', value: 1450.20, change: -1.2, name: '유로', timestamp: new Date().toLocaleTimeString('ko-KR') },
                    { code: 'JPY/KRW', value: 9.45, change: +0.8, name: '일본 엔 (100엔)', timestamp: new Date().toLocaleTimeString('ko-KR') },
                    { code: 'CNY/KRW', value: 185.30, change: +1.1, name: '중국 위안', timestamp: new Date().toLocaleTimeString('ko-KR') }
                ];
                updateFXCarousel();
            }
        }
        
        function updateFXCarousel() {
            const carousel = document.getElementById('fxCarousel');
            const dots = document.getElementById('fxDots');
            
            carousel.innerHTML = fxData.map(fx => `
                <div class="market-slide">
                    <div>
                        <div class="market-label">${fx.code}</div>
                        <div style="font-size: 8px; color: #94a3b8;">${fx.name}</div>
                        <div style="font-size: 7px; color: #cbd5e1; margin-top: 2px;">${fx.timestamp}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="market-value">₩${fx.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <span class="market-change ${fx.change >= 0 ? 'market-up' : 'market-down'}">
                            ${fx.change >= 0 ? '▲' : '▼'} ${Math.abs(fx.change)}%
                        </span>
                    </div>
                </div>
            `).join('');
            
            dots.innerHTML = fxData.map((_, i) => 
                `<div class="carousel-dot ${i === fxCurrentIndex ? 'active' : ''}" onclick="goToFXSlide(${i})"></div>`
            ).join('');
            
            carousel.style.transform = `translateX(-${fxCurrentIndex * 100}%)`;
            
            // 자동 슬라이드
            if (fxInterval) clearInterval(fxInterval);
            fxInterval = setInterval(() => {
                fxCurrentIndex = (fxCurrentIndex + 1) % fxData.length;
                updateFXCarousel();
            }, 3000);
        }
        
        function goToFXSlide(index) {
            fxCurrentIndex = index;
            updateFXCarousel();
        }
        
        // 원자재 가격 렌더링
        async function renderMaterialPrices() {
            // 실제 원자재 가격 (2026년 1월 기준 대략적인 시장 가격)
            materialData = [
                { 
                    name: 'Copper (Cu)', 
                    value: 9250, 
                    unit: 'USD/MT', 
                    change: +(Math.random() * 4 - 2).toFixed(2), 
                    description: '구리 (LME)',
                    timestamp: new Date().toLocaleTimeString('ko-KR')
                },
                { 
                    name: 'Aluminum (Al)', 
                    value: 2580, 
                    unit: 'USD/MT', 
                    change: +(Math.random() * 3 - 1.5).toFixed(2), 
                    description: '알루미늄 (LME)',
                    timestamp: new Date().toLocaleTimeString('ko-KR')
                },
                { 
                    name: 'R-134a', 
                    value: 8.5, 
                    unit: 'USD/kg', 
                    change: +(Math.random() * 2 - 1).toFixed(2), 
                    description: '냉매',
                    timestamp: new Date().toLocaleTimeString('ko-KR')
                },
                { 
                    name: 'ABS', 
                    value: 2100, 
                    unit: 'USD/MT', 
                    change: +(Math.random() * 2 - 1).toFixed(2), 
                    description: 'ABS 수지',
                    timestamp: new Date().toLocaleTimeString('ko-KR')
                },
                { 
                    name: 'HIPS', 
                    value: 1950, 
                    unit: 'USD/MT', 
                    change: +(Math.random() * 2 - 1).toFixed(2), 
                    description: 'HIPS',
                    timestamp: new Date().toLocaleTimeString('ko-KR')
                },
                { 
                    name: 'GI Steel', 
                    value: 950, 
                    unit: 'USD/MT', 
                    change: +(Math.random() * 3 - 1.5).toFixed(2), 
                    description: '아연도금강판',
                    timestamp: new Date().toLocaleTimeString('ko-KR')
                }
            ];
            
            updateMaterialCarousel();
        }
        
        function updateMaterialCarousel() {
            const carousel = document.getElementById('materialCarousel');
            const dots = document.getElementById('materialDots');
            
            carousel.innerHTML = materialData.map(mat => `
                <div class="market-slide">
                    <div>
                        <div class="market-label">${mat.name}</div>
                        <div style="font-size: 8px; color: #94a3b8;">${mat.description}</div>
                        <div style="font-size: 7px; color: #cbd5e1; margin-top: 2px;">${mat.timestamp}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="market-value">$${mat.value.toLocaleString()}</div>
                        <div style="font-size: 8px; color: #64748b;">${mat.unit}</div>
                        <span class="market-change ${mat.change >= 0 ? 'market-up' : 'market-down'}">
                            ${mat.change >= 0 ? '▲' : '▼'} ${Math.abs(mat.change)}%
                        </span>
                    </div>
                </div>
            `).join('');
            
            dots.innerHTML = materialData.map((_, i) => 
                `<div class="carousel-dot ${i === materialCurrentIndex ? 'active' : ''}" onclick="goToMaterialSlide(${i})"></div>`
            ).join('');
            
            carousel.style.transform = `translateX(-${materialCurrentIndex * 100}%)`;
            
            // 자동 슬라이드
            if (materialInterval) clearInterval(materialInterval);
            materialInterval = setInterval(() => {
                materialCurrentIndex = (materialCurrentIndex + 1) % materialData.length;
                updateMaterialCarousel();
            }, 3000);
        }
        
        function goToMaterialSlide(index) {
            materialCurrentIndex = index;
            updateMaterialCarousel();
        }
        
        window.onload = () => { 
            lucide.createIcons(); 
            fetchNews();
            renderFXRates();
            renderMaterialPrices();
            
            // 1분마다 환율/원자재 데이터 업데이트
            setInterval(() => {
                renderFXRates();
                renderMaterialPrices();
            }, 60000);
        };
    </script>
</body>
</html>
